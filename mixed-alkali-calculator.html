<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ··åˆç¢±æˆåˆ†æµ“åº¦è®¡ç®—å™¨ (NaHCOâ‚ƒ + Naâ‚‚COâ‚ƒ)</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ä¼˜åŒ–æ’ç‰ˆå±‚çº§ - æ”¹ç”¨ç³»ç»Ÿé»˜è®¤å­—ä½“æ ˆä»¥æå‡æ¸…æ™°åº¦å¹¶å»é™¤æ–œæ 0 */
        :root {
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            --bg-canvas: #f0f5f9;
            --bg-surface: #ffffff;
            --text-primary: #1a1a1a;
            --text-secondary: #6b7280;
            --accent-color: #059669; /* æ”¹ä¸ºç¥–æ¯ç»¿/ç»¿è‰²ç³»ï¼ŒåŒºåˆ†ä¹‹å‰çš„è“è‰²ç³» */
            --accent-bg: #ecfdf5;
            --color-error: #f04c4c;
            --border-light: #e0e0e0;
            --button-text: #ffffff;
            --accent-color-rgb: 5, 150, 105;
            --animation-state: running;
        }

        body {
            background-color: var(--bg-canvas);
            transition: background-color 0.5s ease, color 0.5s ease;
            background-image: radial-gradient(
                circle at 50% 10%, 
                rgba(var(--accent-color-rgb), 0.07) 0%, 
                var(--bg-canvas) 50%
            );
            background-size: cover;
            background-attachment: fixed;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 1.5rem 0;
            box-sizing: border-box;
            overflow-x: hidden;
            position: relative;
        }
        
        .main-calculator-card {
            position: relative;
            z-index: 20;
            width: 90%;
            max-width: 800px;
            margin: 0;
            margin-bottom: 4rem; 
        }

        /* --- åŠ¨ç”»èƒŒæ™¯ --- */
        #floating-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            overflow: hidden;
            pointer-events: none; 
            z-index: 1;
        }
        
        .floating-element {
            position: absolute;
            top: 0;
            left: var(--random-x);
            color: var(--accent-color);
            opacity: 0.12;
            font-weight: 700;
            line-height: 1;
            white-space: nowrap;
            animation: waterfall linear infinite;
            animation-play-state: var(--animation-state);
            -webkit-user-select: none;
               -moz-user-select: none;
                    user-select: none;
            font-family: 'Times New Roman', serif;
            will-change: transform;
            transform: translate3d(0, -100vh, 0); 
        }

        @keyframes waterfall {
            0% { transform: translate3d(0, -100vh, 0); }
            100% { transform: translate3d(0, 150vh, 0); }
        }
        
        /* --- æ·±è‰²æ¨¡å¼ --- */
        body[data-mode="dark"] {
            --bg-canvas: #0a0a0a;           
            --bg-surface: #141414;          
            --text-primary: #ffffff;        
            --text-secondary: #a8b9d9;      
            --color-error: #ff7f7f;         
            --border-light: #333333;        
            --button-text: #0a0a0a;         
             background-image: radial-gradient(
                circle at 50% 10%, 
                rgba(var(--accent-color-rgb), 0.15) 0%, 
                var(--bg-canvas) 50%
            );
        }

        /* é€šç”¨ç±» */
        .bg-surface { background-color: var(--bg-surface); }
        .text-primary { color: var(--text-primary); }
        .text-secondary { color: var(--text-secondary); }
        .border-light { border-color: var(--border-light); }
        .accent-bg { background-color: var(--accent-bg); }
        
        /* è¾“å…¥æ¡†æ ·å¼ */
        .input-field {
            border-color: var(--border-light);
            color: var(--text-primary);
            background-color: var(--bg-surface);
            transition: border-color 0.3s, background-color 0.5s;
        }
        .input-field:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(var(--accent-color-rgb), 0.3);
            outline: none;
        }

        .theme-button { position: relative; }
        .theme-button.active {
            transform: scale(1.1);
            box-shadow: 0 0 0 2px var(--bg-surface), 0 0 0 4px var(--text-primary);
        }

        /* è¡¨æ ¼æ ·å¼ */
        .result-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        .result-table th, .result-table td {
            padding: 10px 8px;
            text-align: center;
            border: 1px solid var(--border-light);
            color: var(--text-primary);
        }
        .result-table th {
            background-color: var(--accent-bg); 
            color: var(--text-primary);
            font-weight: 700;
        }
        .result-table tr:hover td {
            background-color: rgba(var(--accent-color-rgb), 0.05);
        }

        /* æŒ‰é’®åŠ¨æ•ˆ */
        .calculate-button {
            background-color: var(--accent-color); 
            color: var(--button-text); 
            transition: all 0.3s ease-out; 
            font-weight: 700;
        }
        .calculate-button:hover {
            filter: brightness(1.15); 
            box-shadow: 0 4px 15px 0px rgba(var(--accent-color-rgb), 0.4); 
            transform: translateY(-2px); 
        }
        .calculate-button:active {
            filter: brightness(0.9); 
            transform: scale(0.98); 
            box-shadow: none;
        }
        .active-scale-98:active { transform: scale(0.98); }

        .main-title { font-size: 2rem; font-weight: 900; letter-spacing: -0.05em; }
        .section-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 0.5rem; color: var(--text-primary); }

        /* Toast æç¤ºæ ·å¼ */
        #toast-notification {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-size: 0.9rem;
            font-weight: 500;
            z-index: 100;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            pointer-events: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        #toast-notification.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        
        .copyable-result {
            cursor: pointer;
            border-bottom: 1px dashed var(--accent-color);
        }
        .copyable-result:active { opacity: 0.7; }
        
        /* é’ˆå¯¹å°å±å¹•ä¼˜åŒ–è¡¨æ ¼ */
        @media (max-width: 640px) {
            .result-table { display: block; overflow-x: auto; white-space: nowrap; }
            .input-group { flex-direction: column; }
            .input-group > div { width: 100%; margin-bottom: 0.5rem; }
        }

        /* --- ç§»åŠ¨ç«¯æ¨ªå‘æ»šåŠ¨ä¼˜åŒ– --- */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .dot-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--border-light);
            transition: all 0.3s ease;
        }
        .dot-indicator.active {
            background-color: var(--accent-color);
            transform: scale(1.2);
            width: 20px;
            border-radius: 4px;
        }

        @keyframes swipe-hint {
            0%, 100% { transform: translateX(0); opacity: 0.5; }
            50% { transform: translateX(10px); opacity: 1; }
        }
        .swipe-hint-icon {
            animation: swipe-hint 1.5s infinite;
        }

        /* å†å²è®°å½•å±•å¼€æ ·å¼ */
        .history-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            opacity: 0;
        }
        .history-details.open {
            max-height: 1000px;
            opacity: 1;
            margin-top: 1rem;
        }
        .history-summary-row {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .history-summary-row:hover {
            background-color: rgba(var(--accent-color-rgb), 0.05);
        }
        .expand-icon {
            transition: transform 0.3s;
        }
        .expand-icon.open {
            transform: rotate(180deg);
        }
    </style>
</head>
<body data-mode="light">
    
    <div id="floating-container"></div>
    
    <!-- Toast Notification -->
    <div id="toast-notification">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
        <span>å†…å®¹å·²å¤åˆ¶</span>
    </div>

    <div class="main-calculator-card bg-surface shadow-2xl rounded-2xl p-6 sm:p-8 space-y-6 border-t-8 border-[var(--accent-color)] transition-colors duration-500">

        <!-- é¡¶éƒ¨æ§åˆ¶åŒº -->
        <div class="flex flex-col space-y-4 pb-4 border-b border-[var(--border-light)] transition-colors duration-500">
            <div class="flex justify-between items-center">
                <div class="flex flex-wrap items-center space-x-3">
                    <span class="text-sm font-medium text-[var(--text-secondary)]">ç•Œé¢æ¨¡å¼:</span>
                    <button onclick="toggleMode()" class="px-3 py-1 bg-[var(--accent-bg)] rounded-full text-[var(--text-primary)] border border-[var(--border-light)] text-xs font-bold active-scale-98">
                        <span id="mode-text">æµ…è‰²</span>
                    </button>
                    <button onclick="toggleAnimation()" class="px-3 py-1 bg-[var(--accent-bg)] rounded-full text-[var(--text-primary)] border border-[var(--border-light)] text-xs font-bold active-scale-98">
                        <span id="animation-text">åŠ¨æ•ˆå¼€</span>
                    </button>
                </div>
                <!-- ä¸»é¢˜è‰²é€‰æ‹© -->
                <div class="flex items-center space-x-2">
                    <button onclick="setAccent('starry-night')" class="theme-button w-6 h-6 rounded-full" style="background: #27497d;" title="æ˜Ÿæœˆå¤œ"></button>
                    <button onclick="setAccent('organic')" class="theme-button w-6 h-6 rounded-full" style="background: #8c7851;" title="å¤§åœ°è‰²"></button>
                    <button onclick="setAccent('emerald')" class="theme-button w-6 h-6 rounded-full active" style="background: #059669;" title="ç¥–æ¯ç»¿"></button>
                </div>
            </div>
            
            <div class="text-center space-y-2">
                <h1 class="main-title text-primary">æ··åˆç¢±æˆåˆ†æµ“åº¦è®¡ç®—å™¨</h1>
                <p class="text-[var(--text-secondary)] text-sm">åŒæŒ‡ç¤ºå‰‚æ³• (NaHCOâ‚ƒ + Naâ‚‚COâ‚ƒ)</p>
            </div>
        </div>
        
        <!-- å…¨å±€å‚æ•°è®¾ç½® -->
        <div class="bg-[var(--accent-bg)] p-4 rounded-lg border border-[var(--border-light)] transition-colors duration-500">
            <h2 class="section-title">ğŸ§ª å®éªŒå…¬å…±å‚æ•°</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-bold text-primary mb-1">HCl æ ‡å‡†æº¶æ¶²æµ“åº¦ (mol/L)</label>
                    <!-- æµ“åº¦è¾“å…¥æ¡†ï¼š4ä½æœ‰æ•ˆæ•°å­—æ§åˆ¶ -->
                    <input type="number" id="c-hcl" placeholder="0.1000" class="w-full rounded-lg p-2 border input-field tabular-nums" onchange="formatInputSigFigs(this, 4)">
                </div>
                <div>
                    <label class="block text-xs font-bold text-primary mb-1">ç§»å–è¯•æ ·ä½“ç§¯ V<sub>æ ·</sub> (mL)</label>
                    <input type="number" id="v-sample" step="0.01" value="25.00" class="w-full rounded-lg p-2 border input-field tabular-nums">
                </div>
            </div>
        </div>

        <!-- æ•°æ®è¾“å…¥åŒº (3æ¬¡æµ‹å®š - ç§»åŠ¨ç«¯æ”¯æŒæ¨ªå‘æ»‘åŠ¨) -->
        <div class="space-y-4">
            <div class="flex justify-between items-end">
                <h2 class="section-title flex items-center gap-2">
                    ğŸ“Š å¹³è¡Œæµ‹å®šæ•°æ®å½•å…¥
                    <!-- ç§»åŠ¨ç«¯æ»‘åŠ¨æç¤ºå›¾æ ‡ -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-[var(--accent-color)] lg:hidden swipe-hint-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7" />
                    </svg>
                </h2>
                <span class="text-xs text-[var(--text-secondary)]">ä½“ç§¯ç²¾ç¡®åˆ° 0.01 mL</span>
            </div>
            
            <!-- å¡ç‰‡å®¹å™¨: Mobile=Flex+Scroll, Desktop=Grid -->
            <div id="trials-container" class="flex lg:grid lg:grid-cols-3 gap-4 overflow-x-auto lg:overflow-visible snap-x snap-mandatory hide-scrollbar pb-2">
                <!-- åŠ¨æ€ç”Ÿæˆçš„è¾“å…¥å¡ç‰‡ -->
            </div>
            
            <!-- ç§»åŠ¨ç«¯é¡µç æŒ‡ç¤ºå™¨ -->
            <div id="trial-indicators" class="flex justify-center space-x-2 lg:hidden">
                <!-- JS å¡«å…… dots -->
            </div>
        </div>

        <!-- è®¡ç®—æŒ‰é’® -->
        <button onclick="calculateResults()" class="w-full flex justify-center py-3 px-4 rounded-lg shadow-lg text-lg calculate-button mt-4">
            è®¡ç®—æˆåˆ†æµ“åº¦ & å¤„ç†æ•°æ®
        </button>

        <!-- ç»“æœå±•ç¤ºåŒº -->
        <div id="result-section" class="hidden space-y-6">
            <div class="border-t-2 border-[var(--accent-color)] pt-6">
                <h2 class="section-title text-center mb-4">ğŸ“ æ•°æ®è®°å½•ä¸å¤„ç†è¡¨</h2>
                <div class="overflow-x-auto rounded-lg shadow-sm border border-[var(--border-light)]">
                    <table class="result-table bg-surface">
                        <thead>
                            <tr>
                                <th style="width: 30%">æµ‹å®šæ¬¡æ•°</th>
                                <th style="width: 23%">1</th>
                                <th style="width: 23%">2</th>
                                <th style="width: 23%">3</th>
                            </tr>
                        </thead>
                        <tbody id="result-table-body">
                            <!-- JS å¡«å…… -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- ç»Ÿè®¡ç»“æœå¡ç‰‡ -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="p-4 rounded-lg border border-[var(--border-light)] bg-surface shadow-sm">
                    <h3 class="font-bold text-[var(--accent-color)] mb-2 border-b pb-2">Naâ‚‚COâ‚ƒ åˆ†æç»“æœ</h3>
                    <div class="flex justify-between mb-1">
                        <span class="text-sm text-secondary">å¹³å‡æµ“åº¦:</span>
                        <span class="font-bold text-primary copyable-result tabular-nums" onclick="copyText(this)" id="avg-na2co3">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-sm text-secondary">ç›¸å¯¹å¹³å‡åå·® (RAD):</span>
                        <span class="font-bold text-primary tabular-nums" id="rad-na2co3">-</span>
                    </div>
                </div>
                <div class="p-4 rounded-lg border border-[var(--border-light)] bg-surface shadow-sm">
                    <h3 class="font-bold text-[var(--accent-color)] mb-2 border-b pb-2">NaHCOâ‚ƒ åˆ†æç»“æœ</h3>
                    <div class="flex justify-between mb-1">
                        <span class="text-sm text-secondary">å¹³å‡æµ“åº¦:</span>
                        <span class="font-bold text-primary copyable-result tabular-nums" onclick="copyText(this)" id="avg-nahco3">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-sm text-secondary">ç›¸å¯¹å¹³å‡åå·® (RAD):</span>
                        <span class="font-bold text-primary tabular-nums" id="rad-nahco3">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- å†å²è®°å½•æ§åˆ¶ -->
        <div class="pt-6 border-t border-[var(--border-light)]">
            <div class="flex justify-between items-center mb-4">
                <h2 class="section-title mb-0">ğŸ’¾ å†å²è®°å½•</h2>
                <div class="space-x-2">
                     <button onclick="exportCSV()" class="px-3 py-1.5 bg-[#10b981] text-white rounded text-sm font-medium hover:bg-[#059669] transition active-scale-98">
                        å¯¼å‡º CSV
                    </button>
                    <button onclick="clearHistory()" class="px-3 py-1.5 bg-[var(--color-error)] text-white rounded text-sm font-medium hover:opacity-90 transition active-scale-98">
                        æ¸…ç©º
                    </button>
                </div>
            </div>
            <p class="text-xs text-[var(--text-secondary)] mb-4">ç‚¹å‡»è®°å½•è¡Œå¯æŸ¥çœ‹/æ”¶èµ·å®Œæ•´æ•°æ®è¡¨</p>
            <div id="history-container" class="space-y-3">
                <!-- å†å²å¡ç‰‡ -->
            </div>
        </div>

    </div>

    <script>
        // --- æ ¸å¿ƒé€»è¾‘ ---
        
        // æ›´æ”¹ Key ä»¥é¿å…ä¸æ—§ç‰ˆæ•°æ®(NaOH)æ··æ·†
        const HISTORY_KEY = 'mixedAlkaliHistory_Bicarb';
        let historyData = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
        
        /**
         * æ ¸å¿ƒä¿®çº¦å‡½æ•°ï¼šä¿ç•™ n ä½æœ‰æ•ˆæ•°å­—ï¼Œéµå¾ªâ€œå››èˆå…­å…¥äº”æˆåŒâ€è§„åˆ™ (GB/T 8170)
         * @param {number} num å¾…ä¿®çº¦æ•°å€¼
         * @param {number} sigFigs æœ‰æ•ˆæ•°å­—ä½æ•°
         * @returns {string} ä¿®çº¦åçš„å­—ç¬¦ä¸²
         */
        function roundToSigFigs(num, sigFigs) {
            if (num === 0) return "0.0000".substring(0, sigFigs + 1); // ç®€å•å¤„ç†0çš„æƒ…å†µ
            if (isNaN(num)) return "-";

            const absNum = Math.abs(num);
            // è®¡ç®—æ•°é‡çº§ï¼Œä¾‹å¦‚ 0.1 -> -1, 10 -> 1
            const d = Math.floor(Math.log10(absNum));
            // è®¡ç®—éœ€è¦ä½ç§»çš„å¹‚æ¬¡ï¼Œä½¿å¾—ç¬¬ sigFigs ä½ç§»åŠ¨åˆ°ä¸ªä½
            // ä¾‹å¦‚ num=0.10005 (d=-1), sigFigs=4. shift = 4 - 1 - (-1) = 4. 
            // 0.10005 * 10000 = 1000.5
            const shift = sigFigs - 1 - d;
            const magnitude = Math.pow(10, shift);
            const shifted = num * magnitude;

            let roundedShifted;
            const integerPart = Math.floor(shifted);
            const fractionalPart = shifted - integerPart;
            
            // ä½¿ç”¨å¾®å° epsilon å¤„ç†æµ®ç‚¹è¯¯å·®
            const epsilon = 1e-10;

            if (Math.abs(fractionalPart - 0.5) < epsilon) {
                // æ°å¥½ä¸º 0.5 çš„æƒ…å†µï¼šçœ‹å‰ä¸€ä½ï¼ˆå³ integerPart çš„ä¸ªä½ï¼‰
                if (integerPart % 2 === 0) {
                    roundedShifted = integerPart; // å¶æ•°ï¼Œèˆå» (äº”æˆåŒ)
                } else {
                    roundedShifted = integerPart + 1; // å¥‡æ•°ï¼Œè¿›ä½ (äº”æˆåŒ)
                }
            } else if (fractionalPart > 0.5) {
                roundedShifted = Math.ceil(shifted);
            } else {
                roundedShifted = Math.floor(shifted);
            }

            const result = roundedShifted / magnitude;
            
            // æ ¼å¼åŒ–è¾“å‡ºï¼Œç¡®ä¿æœ«å°¾çš„é›¶è¢«ä¿ç•™
            // éœ€è¦çš„å°æ•°ä½æ•° = shift (å¦‚æœ shift > 0)
            const decimalPlaces = Math.max(0, shift);
            return result.toFixed(decimalPlaces);
        }

        function formatInputSigFigs(input, sigFigs) {
            const val = parseFloat(input.value);
            if (!isNaN(val) && val !== 0) {
                input.value = roundToSigFigs(val, sigFigs);
            }
        }

        // åˆå§‹åŒ– 3 ä¸ªæµ‹å®šè¾“å…¥æ¡†
        function initTrials() {
            const container = document.getElementById('trials-container');
            const indicatorsContainer = document.getElementById('trial-indicators');
            let html = '';
            let indicatorsHtml = '';

            for (let i = 1; i <= 3; i++) {
                html += `
                <div class="min-w-[85%] sm:min-w-[45%] lg:min-w-0 lg:w-full flex-shrink-0 snap-center p-4 rounded-lg border border-[var(--border-light)] bg-surface shadow-sm relative trial-card transition-all duration-300">
                    <div class="absolute top-2 right-2 text-xs font-bold text-[var(--accent-color)] opacity-30 text-4xl select-none">${i}</div>
                    <h3 class="font-bold text-primary mb-3 text-sm">ç¬¬ ${i} æ¬¡æµ‹å®š</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs text-secondary mb-1">åˆè¯»æ•° V<sub>åˆ</sub> (mL)</label>
                            <input type="number" id="v-start-${i}" step="0.01" class="w-full rounded p-2 border input-field text-sm tabular-nums" placeholder="0.00" oninput="liveCalc(${i})">
                        </div>
                        <div>
                            <label class="block text-xs text-secondary mb-1">ç¬¬ä¸€ç»ˆç‚¹ V<sub>ç»ˆ1</sub> (é…šé…)</label>
                            <input type="number" id="v-end1-${i}" step="0.01" class="w-full rounded p-2 border input-field text-sm tabular-nums" placeholder="mL" oninput="liveCalc(${i})">
                        </div>
                        <div>
                            <label class="block text-xs text-secondary mb-1">ç¬¬äºŒç»ˆç‚¹ V<sub>ç»ˆ2</sub> (ç”²åŸºæ©™)</label>
                            <input type="number" id="v-end2-${i}" step="0.01" class="w-full rounded p-2 border input-field text-sm tabular-nums" placeholder="mL" oninput="liveCalc(${i})">
                        </div>
                        <div class="pt-2 border-t border-dashed border-[var(--border-light)] text-xs space-y-1">
                            <div class="flex justify-between"><span class="text-secondary">V<sub>1</sub> (mL):</span> <span id="disp-v1-${i}" class="tabular-nums font-bold text-[var(--accent-color)]">-</span></div>
                            <div class="flex justify-between"><span class="text-secondary">V<sub>2</sub> (mL):</span> <span id="disp-v2-${i}" class="tabular-nums font-bold text-[var(--accent-color)]">-</span></div>
                        </div>
                    </div>
                </div>`;
                
                indicatorsHtml += `<div class="dot-indicator ${i === 1 ? 'active' : ''}" data-index="${i-1}"></div>`;
            }
            container.innerHTML = html;
            indicatorsContainer.innerHTML = indicatorsHtml;

            setupScrollObserver(container);
        }

        // ç›‘å¬æ»šåŠ¨ä½ç½®æ›´æ–°å°åœ†ç‚¹
        function setupScrollObserver(container) {
            const cards = container.querySelectorAll('.trial-card');
            const dots = document.querySelectorAll('.dot-indicator');

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const index = Array.from(cards).indexOf(entry.target);
                        updateDots(index);
                    }
                });
            }, {
                root: container,
                threshold: 0.6 
            });

            cards.forEach(card => observer.observe(card));
        }

        function updateDots(activeIndex) {
            const dots = document.querySelectorAll('.dot-indicator');
            dots.forEach((dot, idx) => {
                if (idx === activeIndex) dot.classList.add('active');
                else dot.classList.remove('active');
            });
        }

        // å®æ—¶è®¡ç®—å•æ¬¡ V1 V2
        function liveCalc(index) {
            const vStart = parseFloat(document.getElementById(`v-start-${index}`).value);
            const vEnd1 = parseFloat(document.getElementById(`v-end1-${index}`).value);
            const vEnd2 = parseFloat(document.getElementById(`v-end2-${index}`).value);
            
            const dispV1 = document.getElementById(`disp-v1-${index}`);
            const dispV2 = document.getElementById(`disp-v2-${index}`);
            
            if (!isNaN(vStart) && !isNaN(vEnd1)) {
                let v1 = vEnd1 - vStart;
                dispV1.textContent = v1.toFixed(2);
                if(v1 < 0) dispV1.classList.add('text-red-500');
                else dispV1.classList.remove('text-red-500');
            } else {
                dispV1.textContent = '-';
            }

            if (!isNaN(vEnd1) && !isNaN(vEnd2)) {
                let v2 = vEnd2 - vEnd1; 
                dispV2.textContent = v2.toFixed(2);
                if(v2 < 0) dispV2.classList.add('text-red-500');
                else dispV2.classList.remove('text-red-500');
            } else {
                dispV2.textContent = '-';
            }
        }

        function calculateResults() {
            const cHcl = parseFloat(document.getElementById('c-hcl').value);
            const vSample = parseFloat(document.getElementById('v-sample').value);
            
            if (isNaN(cHcl) || cHcl <= 0) return showToast("è¯·è¾“å…¥æœ‰æ•ˆçš„ HCl æµ“åº¦", true);
            if (isNaN(vSample) || vSample <= 0) return showToast("è¯·è¾“å…¥æœ‰æ•ˆçš„è¯•æ ·ä½“ç§¯", true);

            let results = [];
            let validTrials = 0;

            for (let i = 1; i <= 3; i++) {
                const vStartInput = document.getElementById(`v-start-${i}`);
                const vEnd1Input = document.getElementById(`v-end1-${i}`);
                const vEnd2Input = document.getElementById(`v-end2-${i}`);
                
                const vStart = parseFloat(vStartInput.value);
                const vEnd1 = parseFloat(vEnd1Input.value);
                const vEnd2 = parseFloat(vEnd2Input.value);

                if (isNaN(vStart) || isNaN(vEnd1) || isNaN(vEnd2)) {
                    results.push(null);
                    continue;
                }
                
                validTrials++;

                const V1 = vEnd1 - vStart;
                const V2 = vEnd2 - vEnd1; 
                
                const V_for_Na2CO3 = V1;
                const V_for_NaHCO3_original = V2 - V1;
                
                // è®¡ç®—æµ“åº¦
                const cNa2CO3 = (cHcl * V_for_Na2CO3) / vSample;
                const cNaHCO3 = (cHcl * V_for_NaHCO3_original) / vSample; 

                results.push({
                    vStart, vEnd1, vEnd2, V1, V2,
                    diffV: V_for_NaHCO3_original,
                    cNa2CO3, cNaHCO3
                });
            }

            if (validTrials === 0) return showToast("è¯·è‡³å°‘è¾“å…¥ä¸€ç»„å®Œæ•´æ•°æ®", true);

            // æ¸²æŸ“ç»“æœè¡¨æ ¼
            renderTable(results, cHcl);
            
            // è®¡ç®—ç»Ÿè®¡æ•°æ®
            const validResults = results.filter(r => r !== null);
            
            // Na2CO3 ç»Ÿè®¡
            const avgNa2CO3 = validResults.reduce((sum, r) => sum + r.cNa2CO3, 0) / validResults.length;
            const devNa2CO3 = validResults.reduce((sum, r) => sum + Math.abs(r.cNa2CO3 - avgNa2CO3), 0) / validResults.length;
            const radNa2CO3 = avgNa2CO3 > 0 ? (devNa2CO3 / avgNa2CO3) * 100 : 0;

            // NaHCO3 ç»Ÿè®¡
            const avgNaHCO3 = validResults.reduce((sum, r) => sum + r.cNaHCO3, 0) / validResults.length;
            const devNaHCO3 = validResults.reduce((sum, r) => sum + Math.abs(r.cNaHCO3 - avgNaHCO3), 0) / validResults.length;
            const radNaHCO3 = avgNaHCO3 > 0 ? (devNaHCO3 / avgNaHCO3) * 100 : 0;

            // æ˜¾ç¤ºç»Ÿè®¡ - åº”ç”¨4ä½æœ‰æ•ˆæ•°å­—ä¿®çº¦
            document.getElementById('avg-na2co3').textContent = roundToSigFigs(avgNa2CO3, 4) + " mol/L";
            document.getElementById('rad-na2co3').textContent = radNa2CO3.toFixed(2) + " %";
            
            document.getElementById('avg-nahco3').textContent = roundToSigFigs(avgNaHCO3, 4) + " mol/L";
            document.getElementById('rad-nahco3').textContent = radNaHCO3.toFixed(2) + " %";

            document.getElementById('result-section').classList.remove('hidden');

            // ä¿å­˜å†å²
            const record = {
                date: new Date().toISOString(),
                cHcl, vSample, results, 
                stats: { avgNa2CO3, radNa2CO3, avgNaHCO3, radNaHCO3 }
            };
            historyData.unshift(record);
            localStorage.setItem(HISTORY_KEY, JSON.stringify(historyData));
            renderHistory();
            showToast("è®¡ç®—å®Œæˆï¼");
        }

        // ç”Ÿæˆè¡¨æ ¼ HTML
        function generateTableHtml(results, cHcl, vSample) {
            const getVal = (idx, key, fixed) => {
                if (!results[idx]) return '';
                return results[idx][key].toFixed(fixed);
            };

            const getSigVal = (idx, key, sigFigs) => {
                 if (!results[idx]) return '';
                 return roundToSigFigs(results[idx][key], sigFigs);
            }

            const rows = [
                { label: `ç§»å–æ··åˆç¢±ä½“ç§¯ V<sub>æ ·</sub> (mL)`, val: () => parseFloat(vSample).toFixed(2) },
                { label: `åˆè¯»æ•° V<sub>åˆ</sub> (mL)`, key: 'vStart', fix: 2 },
                { label: `ç¬¬ä¸€ç»ˆç‚¹è¯»æ•° V<sub>ç»ˆ1</sub> (mL)`, key: 'vEnd1', fix: 2 },
                { label: `ç¬¬äºŒç»ˆç‚¹è¯»æ•° V<sub>ç»ˆ2</sub> (mL)`, key: 'vEnd2', fix: 2 },
                { label: `é…šé…æ¶ˆè€— V<sub>1</sub> (mL)`, key: 'V1', fix: 2 },
                { label: `ç”²åŸºæ©™æ¶ˆè€— V<sub>2</sub> (mL)`, key: 'V2', fix: 2 },
                { label: `V<sub>2</sub> - V<sub>1</sub> (mL)`, key: 'diffV', fix: 2 },
                // æµ“åº¦åº”ç”¨ 4 ä½æœ‰æ•ˆæ•°å­—
                { label: `HCl æµ“åº¦ (mol/L)`, val: () => roundToSigFigs(parseFloat(cHcl), 4) },
                { label: `<b>Naâ‚‚COâ‚ƒ (mol/L)</b>`, key: 'cNa2CO3', sig: 4, bold: true },
                { label: `<b>NaHCOâ‚ƒ (mol/L)</b>`, key: 'cNaHCO3', sig: 4, bold: true }, 
            ];

            let html = `<table class="result-table bg-surface w-full"><thead><tr><th style="width: 30%">æµ‹å®šæ¬¡æ•°</th><th style="width: 23%">1</th><th style="width: 23%">2</th><th style="width: 23%">3</th></tr></thead><tbody>`;
            
            rows.forEach(row => {
                html += `<tr><td class="text-left font-medium">${row.label}</td>`;
                for(let i=0; i<3; i++) {
                    let text = '';
                    if (row.val) {
                        text = row.val();
                    } else if (row.sig) {
                        // ä½¿ç”¨æœ‰æ•ˆæ•°å­—æ ¼å¼åŒ–
                        text = getSigVal(i, row.key, row.sig);
                    } else {
                        // ä½¿ç”¨å›ºå®šå°æ•°ä½æ ¼å¼åŒ– (ä½“ç§¯)
                        text = getVal(i, row.key, row.fix);
                    }
                    
                    const style = row.bold ? 'font-bold tabular-nums text-[var(--accent-color)]' : 'tabular-nums';
                    html += `<td class="${style}">${text}</td>`;
                }
                html += `</tr>`;
            });
            html += `</tbody></table>`;
            return html;
        }

        function renderTable(results, cHcl) {
            const vSample = document.getElementById('v-sample').value;
            const tableHtml = generateTableHtml(results, cHcl, vSample);
            // æå– tbody å†…å®¹å¡«å……
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = tableHtml;
            document.getElementById('result-table-body').innerHTML = tempDiv.querySelector('tbody').innerHTML;
        }

        function renderHistory() {
            const container = document.getElementById('history-container');
            container.innerHTML = '';
            
            if (historyData.length === 0) {
                container.innerHTML = '<p class="text-center text-sm text-secondary">æš‚æ— å†å²è®°å½•</p>';
                return;
            }

            historyData.forEach((rec, idx) => {
                const date = new Date(rec.date).toLocaleString('zh-CN');
                const tableHtml = generateTableHtml(rec.results, rec.cHcl, rec.vSample);
                
                const html = `
                <div class="bg-surface border border-[var(--border-light)] rounded-lg shadow-sm text-sm overflow-hidden transition-all duration-300">
                    <!-- æ‘˜è¦è¡Œ (å¯ç‚¹å‡») -->
                    <div class="history-summary-row p-4 flex justify-between items-center" onclick="toggleHistory(${idx})">
                        <div class="flex-1">
                            <div class="font-bold text-[var(--accent-color)] mb-1">${date}</div>
                            <div class="text-xs text-secondary flex gap-4">
                                <span>Naâ‚‚COâ‚ƒ: <b class="tabular-nums">${roundToSigFigs(rec.stats.avgNa2CO3, 4)} M</b></span>
                                <span>NaHCOâ‚ƒ: <b class="tabular-nums">${roundToSigFigs(rec.stats.avgNaHCO3, 4)} M</b></span>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <button onclick="event.stopPropagation(); deleteHistory(${idx})" class="text-[var(--color-error)] text-xs hover:underline">åˆ é™¤</button>
                            <svg id="arrow-${idx}" class="w-5 h-5 text-secondary expand-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                    </div>
                    
                    <!-- è¯¦æƒ…é¡µ (å±•å¼€) -->
                    <div id="detail-${idx}" class="history-details bg-[var(--bg-canvas)] px-2 sm:px-4">
                        <div class="py-4 overflow-x-auto">
                           ${tableHtml}
                           <div class="mt-3 text-xs text-secondary grid grid-cols-2 gap-2 p-2 bg-white rounded border border-[var(--border-light)]">
                                <div><b>Naâ‚‚COâ‚ƒ ç»Ÿè®¡:</b> å¹³å‡ <span class="tabular-nums">${roundToSigFigs(rec.stats.avgNa2CO3, 4)}</span> M, RAD <span class="tabular-nums">${rec.stats.radNa2CO3.toFixed(2)}</span>%</div>
                                <div><b>NaHCOâ‚ƒ ç»Ÿè®¡:</b> å¹³å‡ <span class="tabular-nums">${roundToSigFigs(rec.stats.avgNaHCO3, 4)}</span> M, RAD <span class="tabular-nums">${rec.stats.radNaHCO3.toFixed(2)}</span>%</div>
                           </div>
                        </div>
                    </div>
                </div>`;
                container.innerHTML += html;
            });
        }
        
        function toggleHistory(idx) {
            const detail = document.getElementById(`detail-${idx}`);
            const arrow = document.getElementById(`arrow-${idx}`);
            
            // Toggle current
            if (detail.classList.contains('open')) {
                detail.classList.remove('open');
                arrow.classList.remove('open');
            } else {
                detail.classList.add('open');
                arrow.classList.add('open');
            }
        }
        
        function deleteHistory(index) {
            historyData.splice(index, 1);
            localStorage.setItem(HISTORY_KEY, JSON.stringify(historyData));
            renderHistory();
        }

        function clearHistory() {
            if(confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰è®°å½•å—ï¼Ÿ')) {
                historyData = [];
                localStorage.removeItem(HISTORY_KEY);
                renderHistory();
            }
        }
        
        function exportCSV() {
            if (historyData.length === 0) return showToast("æ— æ•°æ®å¯å¯¼å‡º", true);
            
            // æ›´æ–° CSV è¡¨å¤´
            let csv = "æ—¶é—´,æµ‹å®šæ¬¡æ•°,V_åˆ(mL),V_ç»ˆ1(mL),V_ç»ˆ2(mL),V1(mL),V2(mL),V2-V1(mL),C_Na2CO3(mol/L),C_NaHCO3(mol/L)\n";
            
            historyData.forEach(rec => {
                const time = new Date(rec.date).toLocaleString().replace(',', ' ');
                rec.results.forEach((r, i) => {
                    if(!r) return;
                    // å¯¼å‡ºæ—¶ä¹Ÿä¿ç•™ 4 ä½æœ‰æ•ˆæ•°å­—
                    const cNa2CO3Sig = roundToSigFigs(r.cNa2CO3, 4);
                    const cNaHCO3Sig = roundToSigFigs(r.cNaHCO3, 4);
                    
                    csv += `${time},${i+1},${r.vStart},${r.vEnd1},${r.vEnd2},${r.V1.toFixed(2)},${r.V2.toFixed(2)},${r.diffV.toFixed(2)},${cNa2CO3Sig},${cNaHCO3Sig}\n`;
                });
            });
            
            const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `æ··åˆç¢±åˆ†æ(Bicarb)_${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- UI & åŠ¨æ•ˆé€»è¾‘ ---
        
        function showToast(msg, isError = false) {
            const toast = document.getElementById('toast-notification');
            toast.querySelector('span').innerText = msg;
            const icon = toast.querySelector('svg');
            
            if (isError) {
                icon.classList.remove('text-green-400');
                icon.classList.add('text-red-400');
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />';
            } else {
                icon.classList.remove('text-red-400');
                icon.classList.add('text-green-400');
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />';
            }
            
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }
        
        function copyText(el) {
            const text = el.innerText;
            navigator.clipboard.writeText(text).then(() => showToast("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿"));
        }

        // ä¸»é¢˜åˆ‡æ¢ - é»˜è®¤è®¾ä¸º Emerald ç»¿è‰²ç³»ï¼Œä»¥åŒºåˆ«ä¹‹å‰çš„
        const colorPalettes = {
            'starry-night': { light: { '--accent-color': '#27497d', '--accent-bg': '#e6f0ff' }, dark: { '--accent-color': '#ffdf66', '--accent-bg': '#27497d' } },
            'organic': { light: { '--accent-color': '#8c7851', '--accent-bg': '#eaddcf' }, dark: { '--accent-color': '#b39f7a', '--accent-bg': '#2b2620' } },
            'emerald': { light: { '--accent-color': '#059669', '--accent-bg': '#ecfdf5' }, dark: { '--accent-color': '#34d399', '--accent-bg': '#102d24' } }
        };
        let currentAccent = 'emerald';
        let currentMode = 'light';
        let isAnim = true;

        function setAccent(name) {
            currentAccent = name;
            applyTheme();
            document.querySelectorAll('.theme-button').forEach(b => b.classList.remove('active'));
            document.querySelector(`button[onclick="setAccent('${name}')"]`).classList.add('active');
        }
        
        function toggleMode() {
            currentMode = currentMode === 'light' ? 'dark' : 'light';
            document.getElementById('mode-text').innerText = currentMode === 'light' ? 'æµ…è‰²' : 'æ·±è‰²';
            document.body.setAttribute('data-mode', currentMode);
            applyTheme();
        }
        
        function applyTheme() {
            const p = colorPalettes[currentAccent][currentMode];
            const root = document.documentElement;
            root.style.setProperty('--accent-color', p['--accent-color']);
            root.style.setProperty('--accent-bg', p['--accent-bg']);
            // Convert Hex to RGB for rgba usage
            const hex = p['--accent-color'].replace('#', '');
            const r = parseInt(hex.substring(0,2), 16);
            const g = parseInt(hex.substring(2,4), 16);
            const b = parseInt(hex.substring(4,6), 16);
            root.style.setProperty('--accent-color-rgb', `${r}, ${g}, ${b}`);
        }

        // åŠ¨æ•ˆ
        function toggleAnimation() {
            isAnim = !isAnim;
            document.getElementById('animation-text').innerText = isAnim ? 'åŠ¨æ•ˆå¼€' : 'åŠ¨æ•ˆå…³';
            document.documentElement.style.setProperty('--animation-state', isAnim ? 'running' : 'paused');
            document.getElementById('floating-container').style.opacity = isAnim ? '1' : '0';
        }

        function createFloatingElements() { 
            const container = document.getElementById('floating-container');
            container.innerHTML = ''; 
            // æ›´æ–°åŒ–å­¦ç¬¦å·ï¼Œç§»é™¤ OH-
            const symbols = ['COâ‚ƒÂ²â»', 'Hâº', 'Naâº', 'HCOâ‚ƒâ»', 'pH', '8.3', '3.9', 'Clâ»']; 
            for (let i = 0; i < 40; i++) {
                const el = document.createElement('div');
                el.classList.add('floating-element');
                el.innerText = symbols[Math.floor(Math.random() * symbols.length)];
                // å…³é”®ä¿®å¤ï¼šä½¿ç”¨ CSS å˜é‡ç¡®ä¿ä½ç½®æ­£ç¡®åº”ç”¨
                el.style.setProperty('--random-x', Math.random() * 100 + 'vw');
                
                el.style.fontSize = (Math.random() * 1.5 + 1) + 'rem';
                el.style.animationDuration = (Math.random() * 15 + 15) + 's';
                el.style.animationDelay = (Math.random() * -20) + 's';
                container.appendChild(el);
            }
        }

        // åˆå§‹åŒ–
        window.onload = function() {
            initTrials();
            renderHistory();
            createFloatingElements();
            applyTheme(); // ç¡®ä¿é¢œè‰²æ­£ç¡®åˆå§‹åŒ–
        }

    </script>
</body>
</html>