<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EDTA æ ‡å®šè®¡ç®—å™¨ - ZnOåŸºå‡†æ³•</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            --bg-canvas: #f5f3ff; /* æµ…ç´«èƒŒæ™¯ï¼Œå‘¼åº”EDTA/æŒ‡ç¤ºå‰‚é¢œè‰² */
            --bg-surface: #ffffff;
            --text-primary: #1a1a1a;
            --text-secondary: #6b7280;
            --accent-color: #7c3aed; /* ç´«è‰²ç³» */
            --accent-bg: #ede9fe;
            --accent-hover: #6d28d9;
            --color-error: #ef4444;
            --border-light: #e5e7eb;
            --button-text: #ffffff;
            --accent-color-rgb: 124, 58, 237;
            --animation-state: running;
        }

        body {
            background-color: var(--bg-canvas);
            transition: background-color 0.5s ease, color 0.5s ease;
            background-image: radial-gradient(circle at 50% 10%, rgba(var(--accent-color-rgb), 0.1) 0%, var(--bg-canvas) 50%);
            background-size: cover;
            background-attachment: fixed;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 1.5rem 0;
            box-sizing: border-box;
            overflow-x: hidden;
        }
        
        .main-calculator-card {
            position: relative;
            z-index: 10; 
            width: 90%;
            max-width: 700px;
            margin: 0;
            margin-bottom: 4rem; 
            overflow: hidden;
            padding: 0; 
            display: flex;
            flex-direction: column;
        }

        /* --- æ ¸å¿ƒæ»‘åŠ¨å®¹å™¨ --- */
        .views-viewport {
            width: 100%;
            overflow: hidden;
            transition: height 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            position: relative;
        }

        .views-track {
            display: flex;
            width: 200%; 
            transition: transform 0.5s cubic-bezier(0.22, 1, 0.36, 1);
            align-items: flex-start; 
        }

        .single-view {
            width: 50%;
            flex-shrink: 0;
            box-sizing: border-box;
            padding: 2rem; 
        }
        
        @media (max-width: 640px) {
            .single-view { padding: 1.25rem; }
        }

        /* --- åŠ¨ç”» --- */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-stagger-enter {
            animation: fadeInUp 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
            opacity: 0;
        }
        .delay-100 { animation-delay: 0.05s; }
        .delay-200 { animation-delay: 0.1s; }
        .delay-300 { animation-delay: 0.15s; }
        .delay-400 { animation-delay: 0.2s; }

        /* --- èƒŒæ™¯ç²’å­ --- */
        #floating-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            overflow: hidden; pointer-events: none; z-index: 0;
        }
        .floating-element {
            position: absolute; top: 0; left: var(--initial-x-offset);
            color: var(--accent-color); opacity: 0.1; font-weight: 700;
            white-space: nowrap; animation: waterfall linear infinite;
            animation-play-state: var(--animation-state); user-select: none;
            font-family: 'Times New Roman', serif; 
        }
        @keyframes waterfall { 0% { transform: translateY(-100vh) rotate(0deg); } 100% { transform: translateY(200vh) rotate(360deg); } }
        
        /* --- æ·±è‰²æ¨¡å¼ --- */
        body[data-mode="dark"] {
            --bg-canvas: #0f0a1a; --bg-surface: #1e1b2e; --text-primary: #ffffff;
            --text-secondary: #a8b9d9; --color-error: #ff7f7f; --border-light: #332e40;
            --button-text: #0a0a0a;
            --accent-hover: #d8b4fe;
             background-image: radial-gradient(circle at 50% 10%, rgba(var(--accent-color-rgb), 0.2) 0%, var(--bg-canvas) 50%);
        }
        .bg-surface { background-color: var(--bg-surface); }
        .text-primary { color: var(--text-primary); }
        .text-secondary { color: var(--text-secondary); }
        .border-light { border-color: var(--border-light); }
        .accent-bg { background-color: var(--accent-bg); }
        
        /* --- ç»„ä»¶æ ·å¼ --- */
        .input-field {
            border-color: var(--border-light); color: var(--text-primary); background-color: var(--bg-surface);
            transition: all 0.3s;
        }
        .input-field:focus {
            border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(var(--accent-color-rgb), 0.3); outline: none;
        }
        .input-field.error-border {
            border-color: var(--color-error) !important;
            background-color: rgba(240, 76, 76, 0.05);
        }
        .input-read-only {
            background-color: rgba(var(--accent-color-rgb), 0.05);
            border-color: var(--accent-color);
            color: var(--accent-color);
            font-weight: bold;
            cursor: not-allowed;
        }
        
        .calculate-button {
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--accent-hover) 100%);
            color: var(--button-text);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 700;
            position: relative;
            overflow: hidden;
            border: none;
        }
        .calculate-button::after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.1); opacity: 0; transition: opacity 0.3s;
        }
        .calculate-button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(var(--accent-color-rgb), 0.4); }
        .calculate-button:hover::after { opacity: 1; }
        .calculate-button:active { transform: translateY(1px); box-shadow: 0 2px 10px rgba(var(--accent-color-rgb), 0.3); }

        .action-btn { transition: all 0.2s; opacity: 0.9; }
        .action-btn:hover { opacity: 1; transform: scale(1.05); }
        .action-btn:active { transform: scale(0.95); }

        #mode-selector {
            position: relative; z-index: 50; display: flex; flex-direction: row;
            width: 90%; max-width: 500px; margin-bottom: 1.5rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); border-radius: 12px;
            overflow: hidden; transition: all 0.5s ease-out;
        }
        .mode-tab {
            width: 50%; padding: 12px 8px; cursor: pointer; text-align: center; font-weight: 600; font-size: 0.9rem;
            color: var(--text-secondary); background-color: var(--bg-surface); transition: all 0.3s ease-in-out;
            border-right: 1px solid var(--border-light); border-bottom: 4px solid transparent;
        }
        .mode-tab:last-child { border-right: none; }
        #mode-selector .mode-tab.active-mode {
            color: var(--accent-color); background-color: var(--accent-bg);
            border-bottom-color: var(--accent-color) !important; box-shadow: 0 0 15px rgba(var(--accent-color-rgb), 0.15) inset;
        }
        @media (min-width: 640px) {
            #mode-selector {
                position: fixed; top: 50%; left: 0; transform: translateY(-50%);
                flex-direction: column; width: auto; max-width: none; margin-bottom: 0;
                box-shadow: 4px 0 12px rgba(0, 0, 0, 0.1); border-radius: 0 12px 12px 0;
            }
            .mode-tab { width: 120px; border-left: 4px solid transparent; border-right: none; border-bottom: 1px solid var(--border-light); }
            .mode-tab:last-child { border-bottom: none; }
            #mode-selector .mode-tab.active-mode { border-left-color: var(--accent-color); border-bottom-color: var(--border-light) !important; }
        }

        .theme-button { width: 24px; height: 24px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s; }
        .theme-button:hover { transform: scale(1.1); }
        .theme-button.active { box-shadow: 0 0 0 2px var(--accent-color); transform: scale(1.1); }

        #toast-notification {
            position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%) translateY(100px);
            background-color: rgba(0, 0, 0, 0.8); color: white; padding: 0.75rem 1.5rem; border-radius: 9999px;
            font-size: 0.9rem; font-weight: 500; z-index: 100; opacity: 0; pointer-events: none;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55); display: flex; align-items: center; gap: 0.5rem;
        }
        #toast-notification.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        
        .copyable-result { cursor: pointer; border-bottom: 2px dashed rgba(var(--accent-color-rgb), 0.3); }
        .page-indicators { display: flex; justify-content: center; gap: 8px; margin-bottom: 1rem; }
        .page-dot { width: 8px; height: 8px; background-color: var(--border-light); border-radius: 50%; transition: all 0.3s; }
        .page-dot.active { width: 24px; background-color: var(--accent-color); border-radius: 4px; }

        #swipe-hint {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.7); padding: 20px; border-radius: 16px; color: white;
            z-index: 200; pointer-events: none; animation: fadeOutHint 0.5s ease-in 2.5s forwards; display: none;
        }
        @keyframes fadeOutHint { to { opacity: 0; visibility: hidden; } }
        @keyframes swipeHand { 0%, 100% { transform: translateX(0); } 50% { transform: translateX(-30px); } }
        .hand-icon { font-size: 3rem; animation: swipeHand 1.5s infinite ease-in-out; }

        /* å†å²è®°å½•è¡¨æ ¼ */
        .history-table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 100%; font-size: 0.85rem; border: 1px solid var(--border-light); border-radius: 8px; overflow: hidden; }
        .history-table th { 
            background-color: var(--accent-bg); 
            color: var(--text-primary);
            font-weight: 700;
            padding: 10px 8px;
            text-align: center;
            border-bottom: 1px solid var(--border-light);
            white-space: nowrap;
        }
        .history-table td {
            padding: 8px;
            border-bottom: 1px solid var(--border-light);
            color: var(--text-secondary);
            text-align: center;
            vertical-align: middle;
        }
        .history-table tr:last-child td { border-bottom: none; }
        .history-table tr:hover { background-color: rgba(var(--accent-color-rgb), 0.03); cursor: pointer; }
        
        .clickable-row:active { background-color: rgba(var(--accent-color-rgb), 0.1); }

        .input-group-label {
            font-size: 0.7rem; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 4px; display: block;
        }
        .input-compact { width: 100%; }
        .input-compact input { text-align: center; padding: 8px 4px; font-size: 0.9rem; }

        /* è‡ªå®šä¹‰æŒ‡ç¤ºå‰‚é¢œè‰²æ¡ */
        .color-scale {
            height: 6px; width: 100%; border-radius: 3px; margin-top: 5px;
            background: linear-gradient(90deg, #9b2c2c 0%, #d6bcfa 40%, #f6e05e 100%);
        }
        .color-label { display: flex; justify-content: space-between; font-size: 0.65rem; color: var(--text-secondary); margin-top: 2px; }

        /* Modal Styles */
        #detail-modal { transition: opacity 0.3s ease; }
        #detail-modal.hidden { opacity: 0; pointer-events: none; }
        #detail-modal:not(.hidden) { opacity: 1; pointer-events: auto; }
        
        .mass-mode-toggle {
            display: flex; gap: 10px; margin-bottom: 6px; font-size: 0.8rem; color: var(--text-secondary);
        }
        .mass-mode-label { cursor: pointer; display: flex; align-items: center; gap: 4px; }
        .mass-mode-radio { accent-color: var(--accent-color); }
    </style>
</head>
<body data-mode="light">
    
    <div id="floating-container"></div>
    <div id="swipe-hint"><div class="hand-icon">ğŸ‘†</div><div class="mt-2 font-bold">å·¦å³æ»‘åŠ¨åˆ‡æ¢æ¨¡å¼</div></div>
    <div id="toast-notification">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
        <span>ç»“æœå·²å¤åˆ¶</span>
    </div>
    
    <!-- æ¨¡æ€æ¡† (Modal) -->
    <div id="detail-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
        <!-- èƒŒæ™¯é®ç½© -->
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeModal()"></div>
        <!-- å†…å®¹å¡ç‰‡ -->
        <div class="relative bg-surface w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden transform transition-all scale-100 border border-[var(--border-light)]">
             <div class="bg-[var(--accent-bg)] px-6 py-4 flex justify-between items-center border-b border-[var(--border-light)]">
                 <h3 class="font-bold text-[var(--accent-color)] text-lg">å®éªŒè¯¦æƒ…</h3>
                 <button onclick="closeModal()" class="text-[var(--text-secondary)] hover:text-[var(--text-primary)]">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                 </button>
             </div>
             <div class="p-6 overflow-y-auto max-h-[70vh]" id="modal-content">
                 <!-- åŠ¨æ€æ³¨å…¥å†…å®¹ -->
             </div>
        </div>
    </div>
    
    <div id="mode-selector">
        <div id="tab-prep" class="mode-tab active-mode" onclick="setMode('prep')">
            <div class="text-lg">âš–ï¸</div> é”Œæ¶²é…åˆ¶
        </div>
        <div id="tab-titration" class="mode-tab" onclick="setMode('titration')">
            <div class="text-lg">ğŸ§ª</div> EDTAæ ‡å®š
        </div>
    </div>
    
    <div class="page-indicators sm:hidden">
        <div id="dot-prep" class="page-dot active"></div>
        <div id="dot-titration" class="page-dot"></div>
    </div>

    <!-- ä¸»å¡ç‰‡ -->
    <div class="main-calculator-card bg-surface shadow-2xl rounded-2xl border-t-8 border-[var(--accent-color)] transition-colors duration-500">
        
        <!-- é¡¶éƒ¨æ§åˆ¶åŒº -->
        <div class="px-6 py-4 border-b border-[var(--border-light)] transition-colors duration-500 bg-surface z-20 relative">
            <div class="flex flex-col space-y-3">
                <div class="flex flex-wrap items-center justify-between sm:justify-start sm:space-x-4">
                    <div class="flex items-center space-x-2">
                        <button onclick="toggleMode()" class="px-3 py-1 bg-[var(--accent-bg)] rounded-full text-[var(--text-primary)] hover:bg-[var(--border-light)] text-xs font-bold transition-colors active:scale-95 border border-[var(--border-light)]">
                            <span id="mode-text">æµ…è‰²</span>
                        </button>
                        <button onclick="toggleAnimation()" class="px-3 py-1 bg-[var(--accent-bg)] rounded-full text-[var(--text-primary)] hover:bg-[var(--border-light)] text-xs font-bold transition-colors active:scale-95 border border-[var(--border-light)]">
                            <span id="animation-text">åŠ¨æ•ˆ: å¼€</span>
                        </button>
                    </div>
                    
                    <div class="flex items-center space-x-2 sm:ml-auto">
                        <button id="accent-violet" onclick="setAccent('violet')" class="theme-button active" style="background: #8b5cf6;" title="ç´«ç½—å…° (EDTA)"></button>
                        <button id="accent-organic" onclick="setAccent('organic')" class="theme-button" style="background: #8c7851;" title="æœ‰æœºé‡‘"></button>
                        <button id="accent-starry-night" onclick="setAccent('starry-night')" class="theme-button" style="background: #27497d;" title="æ˜Ÿæœˆå¤œ"></button>
                        <button id="accent-emerald" onclick="setAccent('emerald')" class="theme-button" style="background: #059669;" title="ç¥–æ¯ç»¿"></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- è§†å›¾è§†å£ Viewport -->
        <div id="views-viewport" class="views-viewport">
            <div id="views-track" class="views-track">
                
                <!-- æ¨¡å¼ä¸€ï¼šé”Œæ ‡å‡†æº¶æ¶²é…åˆ¶ -->
                <div id="view-prep" class="single-view">
                    <div class="space-y-6">
                        <div class="animate-target delay-100 text-center">
                            <h1 class="text-2xl font-black text-primary mb-1">åŸºå‡†é”Œæº¶æ¶²é…åˆ¶</h1>
                            <p class="text-[var(--text-secondary)] text-sm">ZnO + 2HCl â†’ ZnClâ‚‚ + Hâ‚‚O</p>
                        </div>

                        <div class="bg-[var(--accent-bg)] p-4 rounded-xl border border-light transition-colors duration-500 animate-target delay-200 shadow-sm">
                            <h2 class="text-sm font-bold text-primary mb-3 uppercase tracking-wide opacity-80 border-b border-[rgba(0,0,0,0.1)] pb-1">åŸºå‡†ç‰©è´¨å‚æ•°</h2>
                            <div class="grid grid-cols-1 gap-3">
                                <div>
                                    <label class="block text-xs font-bold text-secondary mb-1">åŸºå‡†ç‰©è´¨</label>
                                    <input type="text" value="æ°§åŒ–é”Œ (ZnO)" disabled class="w-full rounded-lg p-2 border input-field text-sm bg-gray-50 text-gray-500">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-secondary mb-1">æ‘©å°”è´¨é‡ (g/mol)</label>
                                    <input type="number" id="molar-mass-zno" value="81.38" disabled
                                           class="w-full rounded-lg p-2 border input-field text-sm bg-gray-50 text-gray-500">
                                </div>
                            </div>
                        </div>

                        <div class="space-y-4 animate-target delay-300">
                            <div>
                                <label class="block text-sm font-bold text-primary mb-1">ZnO ç§°å–è´¨é‡ (g)</label>
                                
                                <!-- è´¨é‡è¾“å…¥æ¨¡å¼åˆ‡æ¢ -->
                                <div class="mass-mode-toggle">
                                    <label class="mass-mode-label">
                                        <input type="radio" name="massModePrep" value="direct" class="mass-mode-radio" checked onchange="togglePrepMassMode()"> 
                                        ç›´æ¥è¾“å…¥
                                    </label>
                                    <label class="mass-mode-label">
                                        <input type="radio" name="massModePrep" value="diff" class="mass-mode-radio" onchange="togglePrepMassMode()"> 
                                        å‡é‡æ³• (m = |mâ‚ - mâ‚‚|)
                                    </label>
                                </div>

                                <!-- ç›´æ¥è¾“å…¥ -->
                                <div id="prep-mass-direct">
                                    <input type="number" id="mass-zno" placeholder="æ¨è 0.4000 - 0.5000" min="0" step="0.0001"
                                        class="block w-full rounded-md p-3 border input-field font-medium" oninput="preventNegative(this); hideMessages()">
                                </div>

                                <!-- å‡é‡æ³•è¾“å…¥ -->
                                <div id="prep-mass-diff" class="hidden grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="text-[10px] text-secondary font-bold uppercase mb-1">æ€»é‡ mâ‚ (g)</label>
                                        <input type="number" id="mass-zno-m1" placeholder="æ€»é‡" min="0" step="0.0001"
                                            class="block w-full rounded-md p-3 border input-field font-medium" oninput="preventNegative(this); hideMessages()">
                                    </div>
                                    <div>
                                        <label class="text-[10px] text-secondary font-bold uppercase mb-1">ä½™é‡ mâ‚‚ (g)</label>
                                        <input type="number" id="mass-zno-m2" placeholder="ä½™é‡" min="0" step="0.0001"
                                            class="block w-full rounded-md p-3 border input-field font-medium" oninput="preventNegative(this); hideMessages()">
                                    </div>
                                </div>

                                <p class="text-xs text-secondary mt-1 ml-1">ç²¾ç¡®è‡³ 0.0001 g</p>
                            </div>

                            <div>
                                <label class="block text-sm font-bold text-primary mb-1">å®šå®¹ä½“ç§¯ (mL)</label>
                                <input type="number" id="volume-flask" value="250" min="0"
                                       class="block w-full rounded-md p-3 border input-field font-medium" oninput="preventNegative(this); hideMessages()">
                            </div>

                            <button onclick="calculateZnConc()" class="w-full py-3 rounded-lg shadow-lg text-lg calculate-button mt-4">è®¡ç®—é”Œæ ‡å‡†æº¶æ¶²æµ“åº¦</button>
                        </div>

                        <div id="prep-result-box" class="mt-4 p-5 bg-surface rounded-xl border-2 border-[var(--accent-color)] hidden animate-target shadow-md">
                            <h2 class="text-sm font-bold text-[var(--accent-color)] mb-1 uppercase tracking-wider">è®¡ç®—ç»“æœ (C<sub>Zn</sub>)</h2>
                            <div class="flex items-baseline space-x-2">
                                <span id="zinc-concentration" class="text-4xl font-extrabold text-[var(--accent-color)] copyable-result" onclick="copyResult(this)">0.0000</span> 
                                <span class="text-xl font-bold text-[var(--accent-color)]">mol/L</span>
                            </div>
                            <p class="text-xs text-green-600 mt-2 font-bold flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
                                å·²è‡ªåŠ¨åº”ç”¨åˆ°æ ‡å®šé¡µé¢
                            </p>
                        </div>

                        <div class="pt-6 border-t border-light animate-target delay-400">
                             <div class="flex justify-between items-center mb-3">
                                 <h2 class="text-sm font-bold text-secondary">é…åˆ¶è®°å½• (ç‚¹å‡»ä½¿ç”¨)</h2>
                                 <button onclick="clearPrepHistory()" class="action-btn px-3 py-1.5 bg-[var(--color-error)] text-white rounded-lg text-xs font-bold shadow-sm">æ¸…ç©º</button>
                             </div>
                             <div id="prep-history-container" class="overflow-x-auto"></div>
                        </div>
                    </div>
                </div>
                
                <!-- æ¨¡å¼äºŒï¼šEDTA æ ‡å®š -->
                <div id="view-titration" class="single-view">
                    <div class="space-y-6">
                        <div class="animate-target delay-100 text-center">
                             <h1 class="text-2xl font-black text-primary mb-1">EDTA æµ“åº¦æ ‡å®š</h1>
                             <p class="text-[var(--text-secondary)] text-sm">æŒ‡ç¤ºå‰‚ï¼šäºŒç”²é…šæ©™ (ç´«çº¢ â†’ äº®é»„)</p>
                             <div class="w-32 mx-auto mt-2">
                                 <div class="color-scale"></div>
                                 <div class="color-label"><span>ç´«çº¢</span><span>ç»ˆç‚¹</span><span>äº®é»„</span></div>
                             </div>
                        </div>
                         
                        <div class="bg-[var(--accent-bg)] p-4 rounded-xl border border-light transition-colors duration-500 animate-target delay-200 shadow-sm">
                            <h2 class="text-sm font-bold text-primary mb-3 uppercase tracking-wide opacity-80 border-b border-[rgba(0,0,0,0.1)] pb-1">æ»´å®šå‚æ•°</h2>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="input-group-label">C<sub>Zn</sub> (mol/L) <span class="text-xs font-normal normal-case opacity-70">(å¯ç¼–è¾‘)</span></label>
                                    <input type="number" id="conc-zn-input" step="0.0001" min="0" class="w-full rounded-lg p-2 border input-field text-sm font-bold" oninput="preventNegative(this)">
                                </div>
                                <div>
                                    <label class="input-group-label">ç§»å–ä½“ç§¯ V<sub>Zn</sub> (mL)</label>
                                    <input type="number" id="vol-pipette" value="25.00" step="0.01" min="0" class="w-full rounded-lg p-2 border input-field text-sm" oninput="preventNegative(this)">
                                </div>
                            </div>
                        </div>
                        
                        <div class="animate-target delay-300">
                            <h2 class="text-sm font-bold text-primary mb-2 pl-1">æ»´å®šæ•°æ® (EDTA æ¶ˆè€—é‡)</h2>
                            
                            <!-- è¡¨å¤´ -->
                            <div class="grid grid-cols-[20px_1fr_1fr_1fr] gap-2 mb-2 px-1">
                                <div></div>
                                <div class="text-xs font-bold text-secondary text-center">åˆè¯»æ•° (mL)</div>
                                <div class="text-xs font-bold text-secondary text-center">ç»ˆè¯»æ•° (mL)</div>
                                <div class="text-xs font-bold text-secondary text-center">æ¶ˆè€— V (mL)</div>
                            </div>

                            <div id="trials-container" class="space-y-3">
                                <!-- Trial 1 -->
                                <div class="grid grid-cols-[20px_1fr_1fr_1fr] gap-2 items-center">
                                    <span class="font-bold text-secondary text-sm text-center">1</span>
                                    <div class="input-compact">
                                        <input type="number" id="v-start-1" placeholder="0.00" step="0.01" min="0" class="w-full rounded-lg border input-field font-medium" oninput="preventNegative(this); calcDelta(1)" onchange="formatDecimal(this, 2)">
                                    </div>
                                    <div class="input-compact">
                                        <input type="number" id="v-end-1" placeholder="0.00" step="0.01" min="0" class="w-full rounded-lg border input-field font-medium" oninput="preventNegative(this); calcDelta(1)" onchange="formatDecimal(this, 2)">
                                    </div>
                                    <div class="input-compact">
                                        <input type="text" id="v-delta-1" placeholder="-" disabled class="w-full rounded-lg border input-field bg-gray-50 text-gray-500 font-bold text-center">
                                    </div>
                                </div>
                                <!-- Trial 2 -->
                                <div class="grid grid-cols-[20px_1fr_1fr_1fr] gap-2 items-center">
                                    <span class="font-bold text-secondary text-sm text-center">2</span>
                                    <div class="input-compact">
                                        <input type="number" id="v-start-2" placeholder="0.00" step="0.01" min="0" class="w-full rounded-lg border input-field font-medium" oninput="preventNegative(this); calcDelta(2)" onchange="formatDecimal(this, 2)">
                                    </div>
                                    <div class="input-compact">
                                        <input type="number" id="v-end-2" placeholder="0.00" step="0.01" min="0" class="w-full rounded-lg border input-field font-medium" oninput="preventNegative(this); calcDelta(2)" onchange="formatDecimal(this, 2)">
                                    </div>
                                    <div class="input-compact">
                                        <input type="text" id="v-delta-2" placeholder="-" disabled class="w-full rounded-lg border input-field bg-gray-50 text-gray-500 font-bold text-center">
                                    </div>
                                </div>
                                <!-- Trial 3 -->
                                <div class="grid grid-cols-[20px_1fr_1fr_1fr] gap-2 items-center">
                                    <span class="font-bold text-secondary text-sm text-center">3</span>
                                    <div class="input-compact">
                                        <input type="number" id="v-start-3" placeholder="0.00" step="0.01" min="0" class="w-full rounded-lg border input-field font-medium" oninput="preventNegative(this); calcDelta(3)" onchange="formatDecimal(this, 2)">
                                    </div>
                                    <div class="input-compact">
                                        <input type="number" id="v-end-3" placeholder="0.00" step="0.01" min="0" class="w-full rounded-lg border input-field font-medium" oninput="preventNegative(this); calcDelta(3)" onchange="formatDecimal(this, 2)">
                                    </div>
                                    <div class="input-compact">
                                        <input type="text" id="v-delta-3" placeholder="-" disabled class="w-full rounded-lg border input-field bg-gray-50 text-gray-500 font-bold text-center">
                                    </div>
                                </div>
                            </div>
                            <div id="volume-warning" class="text-[var(--color-error)] text-xs font-bold text-center mt-2 hidden">âš ï¸ ç»ˆè¯»æ•°å¿…é¡»å¤§äºåˆè¯»æ•°</div>
                            <button onclick="calculateEDTA()" class="w-full py-3 rounded-lg shadow-lg text-lg calculate-button mt-6">è®¡ç®— EDTA æµ“åº¦</button>
                        </div>
                        
                        <div id="titration-result-box" class="mt-4 p-5 bg-surface rounded-xl border-2 border-[var(--accent-color)] hidden animate-target shadow-md">
                            <div class="flex justify-between items-center mb-3">
                                <span class="text-sm font-bold text-primary">å¹³å‡æµ“åº¦ C<sub>EDTA</sub></span>
                                <span id="avg-edta" class="text-2xl font-black text-[var(--accent-color)] copyable-result" onclick="copyResult(this)">0.0000</span>
                            </div>
                            <div class="flex justify-between items-center text-sm border-t border-light pt-2">
                                <div class="flex items-center">
                                    <span class="text-primary font-bold mr-2">ç›¸å¯¹å¹³å‡åå·®:</span>
                                    <span id="rsd-value" class="font-bold text-lg text-[var(--text-primary)] transition-colors duration-300">0.00%</span>
                                    <span id="rsd-alert" class="hidden ml-2 text-[var(--color-error)] font-bold text-xs bg-red-50 px-2 py-0.5 rounded border border-red-100 animate-pulse">âš ï¸ åå·®è¿‡å¤§</span>
                                </div>
                                <span class="text-xs text-secondary">(4ä½æœ‰æ•ˆæ•°å­—)</span>
                            </div>
                        </div>

                        <div class="pt-6 border-t border-light animate-target delay-400">
                            <div class="flex justify-between items-center mb-3">
                                <h2 class="text-sm font-bold text-secondary">æ ‡å®šè®°å½• (ç‚¹å‡»è¡ŒæŸ¥çœ‹è¯¦æƒ…)</h2>
                                <div class="space-x-2">
                                    <button onclick="exportCSV()" class="action-btn px-3 py-1.5 bg-[#10B981] text-white rounded-lg text-xs font-bold shadow-sm">å¯¼å‡º CSV</button>
                                    <button onclick="clearTitrationHistory()" class="action-btn px-3 py-1.5 bg-[var(--color-error)] text-white rounded-lg text-xs font-bold shadow-sm">æ¸…ç©º</button>
                                </div>
                            </div>
                            <div id="titration-history-container" class="overflow-x-auto"></div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <div id="error-box" class="mx-6 mb-4 p-3 bg-red-50 border border-red-200 text-red-600 rounded-lg hidden text-sm font-bold text-center">
            <p id="error-message"></p>
        </div>

    </div>

    <script>
        // --- å¸¸é‡ä¸é…ç½® ---
        const M_ZnO = 81.38; // g/mol
        
        let titrationHistoryData = [];
        let prepHistoryData = [];
        let currentAccent = 'violet', currentMode = 'prep', isAnimationEnabled = true;
        let prepMassMode = 'direct';
        
        // è®°å½•ä¸Šä¸€æ¬¡è®¡ç®—æ—¶çš„çŠ¶æ€ï¼Œé¿å…é‡å¤æ·»åŠ å†å²
        let lastPrepState = null;
        let lastTitrationState = null;
        
        // é…è‰²æ–¹æ¡ˆ
        const colorPalettes = {
            'violet': { light: { '--accent-color': '#8b5cf6', '--accent-hover': '#7c3aed', '--accent-bg': '#f3efff', '--button-text': '#ffffff' }, dark: { '--accent-color': '#d8b4fe', '--accent-hover': '#e9d5ff', '--accent-bg': '#2c1e45', '--button-text': '#0a0a0a' } },
            'organic': { light: { '--accent-color': '#8c7851', '--accent-hover': '#7a6845', '--accent-bg': '#eaddcf', '--button-text': '#ffffff' }, dark: { '--accent-color': '#b39f7a', '--accent-hover': '#d4c095', '--accent-bg': '#2b2620', '--button-text': '#141414' } },
            'starry-night': { light: { '--accent-color': '#1f488e', '--accent-hover': '#163a75', '--accent-bg': '#e6f0ff', '--button-text': '#ffffff' }, dark: { '--accent-color': '#ffdf66', '--accent-hover': '#ffea99', '--accent-bg': '#27497d', '--button-text': '#0a0a0a' } },
            'emerald': { light: { '--accent-color': '#059669', '--accent-hover': '#047857', '--accent-bg': '#ecfdf5', '--button-text': '#ffffff' }, dark: { '--accent-color': '#34d399', '--accent-hover': '#6ee7b7', '--accent-bg': '#102d24', '--button-text': '#0a0a0a' } },
        };

        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : '0,0,0';
        }

        function applyTheme(accentName, modeName) {
            currentAccent = accentName; currentMode = modeName;
            const p = colorPalettes[accentName][modeName];
            document.body.setAttribute('data-mode', modeName);
            for (const [k, v] of Object.entries(p)) document.documentElement.style.setProperty(k, v);
            document.documentElement.style.setProperty('--accent-color-rgb', hexToRgb(p['--accent-color']));
            updateUIState();
        }

        function updateUIState() {
            document.querySelectorAll('.theme-button').forEach(b => b.classList.remove('active'));
            document.getElementById(`accent-${currentAccent}`).classList.add('active');
            document.getElementById('mode-text').textContent = currentMode === 'light' ? 'æµ…è‰²' : 'æ·±è‰²';
            document.getElementById('animation-text').textContent = isAnimationEnabled ? 'åŠ¨æ•ˆ: å¼€' : 'åŠ¨æ•ˆ: å…³';
            localStorage.setItem('edtaConfig', JSON.stringify({ accent: currentAccent, mode: currentMode, anim: isAnimationEnabled }));
        }

        window.toggleMode = () => applyTheme(currentAccent, document.body.getAttribute('data-mode') === 'light' ? 'dark' : 'light');
        window.setAccent = (name) => applyTheme(name, document.body.getAttribute('data-mode'));
        window.toggleAnimation = () => {
            isAnimationEnabled = !isAnimationEnabled;
            document.documentElement.style.setProperty('--animation-state', isAnimationEnabled ? 'running' : 'paused');
            updateUIState();
        };

        // --- æ ¸å¿ƒåˆ‡æ¢é€»è¾‘ ---
        window.setMode = function(modeName) {
            document.querySelectorAll('.mode-tab').forEach(el => el.classList.remove('active-mode'));
            document.getElementById(`tab-${modeName}`).classList.add('active-mode');
            document.querySelectorAll('.page-dot').forEach(el => el.classList.remove('active'));
            document.getElementById(`dot-${modeName}`).classList.add('active');

            const track = document.getElementById('views-track');
            track.style.transform = `translateX(${modeName === 'prep' ? '0%' : '-50%'})`;

            setTimeout(() => adjustHeight(modeName), 50);
            triggerAnimations(modeName);
            hideMessages();
        };

        function adjustHeight(modeName) {
            const activeView = document.getElementById(`view-${modeName}`);
            const viewport = document.getElementById('views-viewport');
            if (activeView && viewport) {
                viewport.style.height = activeView.scrollHeight + 'px';
            }
        }
        
        window.addEventListener('resize', () => {
             const activeMode = document.getElementById('tab-prep').classList.contains('active-mode') ? 'prep' : 'titration';
             adjustHeight(activeMode);
        });

        function triggerAnimations(modeName) {
            document.querySelectorAll('.animate-target').forEach(el => {
                el.classList.remove('animate-stagger-enter');
                el.style.opacity = '0';
            });
            const activeView = document.getElementById(`view-${modeName}`);
            void activeView.offsetWidth; 
            activeView.querySelectorAll('.animate-target').forEach(el => el.classList.add('animate-stagger-enter'));
        }

        // --- è¾…åŠ©åŠŸèƒ½ ---
        function hideMessages() {
            document.getElementById('prep-result-box').classList.add('hidden');
            document.getElementById('titration-result-box').classList.add('hidden');
            document.getElementById('error-box').classList.add('hidden');
            document.getElementById('volume-warning').classList.add('hidden');
            const activeMode = document.getElementById('tab-prep').classList.contains('active-mode') ? 'prep' : 'titration';
            setTimeout(() => adjustHeight(activeMode), 100);
        }

        function showError(msg) {
            const box = document.getElementById('error-box');
            document.getElementById('error-message').textContent = msg;
            box.classList.remove('hidden');
            const activeMode = document.getElementById('tab-prep').classList.contains('active-mode') ? 'prep' : 'titration';
            setTimeout(() => adjustHeight(activeMode), 100);
        }

        window.preventNegative = function(el) {
            if (el.value < 0) el.value = Math.abs(el.value);
        }
        
        window.formatDecimal = function(el, precision) {
            if (el.value === '') return;
            const val = parseFloat(el.value);
            if (!isNaN(val)) {
                el.value = val.toFixed(precision);
            }
        }

        // 4ä½æœ‰æ•ˆæ•°å­—ä¿®çº¦é€»è¾‘
        function toSigFigs(num, n) {
            if (num === 0) return "0.0000";
            return num.toPrecision(n);
        }

        // --- æ¨¡æ€æ¡†é€»è¾‘ ---
        window.showDetail = function(idx) {
            const data = titrationHistoryData[idx];
            if(!data) return;
            
            const modal = document.getElementById('detail-modal');
            const content = document.getElementById('modal-content');
            
            // å…¼å®¹æ€§å¤„ç†ï¼šå¦‚æœæ•°æ®é‡Œæœ‰ rad åˆ™ç”¨ radï¼Œå¦åˆ™ç”¨ rsdï¼ˆå¹¶æ ‡æ³¨ä¸ºRSDï¼‰
            const devValue = data.rad !== undefined ? data.rad : data.rsd;
            const devLabel = data.rad !== undefined ? "ç›¸å¯¹å¹³å‡åå·®" : "RSD";
            
            let html = `
                <div class="space-y-4">
                    <div class="flex justify-between items-center text-sm border-b border-[var(--border-light)] pb-2">
                        <span class="text-[var(--text-secondary)]">æ—¶é—´: ${new Date(data.t).toLocaleString()}</span>
                        <span class="font-bold text-[var(--accent-color)] text-lg">${data.c_edta_avg} M</span>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 text-sm bg-[var(--bg-canvas)] border border-[var(--border-light)] p-3 rounded-lg">
                        <div>
                            <span class="block text-xs text-[var(--text-secondary)]">C(Zn) åŸºå‡†</span>
                            <span class="font-bold text-[var(--text-primary)]">${data.c_zn} M</span>
                        </div>
                        <div>
                            <span class="block text-xs text-[var(--text-secondary)]">V(Zn) ç§»å–</span>
                            <span class="font-bold text-[var(--text-primary)]">${data.v_zn} mL</span>
                        </div>
                        <div>
                            <span class="block text-xs text-[var(--text-secondary)]">${devLabel}</span>
                            <span class="${devValue > 0.3 ? 'text-red-500 font-bold' : 'text-[var(--text-primary)]'}">${devValue.toFixed(2)}%</span>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="text-xs font-bold text-[var(--text-secondary)] uppercase mb-2">å¹³è¡Œæµ‹å®šè¯¦æƒ…</h4>
                        <table class="w-full text-sm text-center border border-[var(--border-light)] rounded overflow-hidden">
                            <thead class="bg-[var(--accent-bg)] text-[var(--text-primary)]">
                                <tr>
                                    <th class="py-2">#</th>
                                    <th class="py-2">åˆè¯»æ•°</th>
                                    <th class="py-2">ç»ˆè¯»æ•°</th>
                                    <th class="py-2">æ¶ˆè€—(mL)</th>
                                    <th class="py-2">C(M)</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-[var(--border-light)]">
            `;
            
            data.trials.forEach(t => {
                html += `
                    <tr>
                        <td class="py-2 text-[var(--text-secondary)]">${t.id}</td>
                        <td class="py-2 text-[var(--text-primary)]">${t.v_start !== undefined ? t.v_start.toFixed(2) : '-'}</td>
                        <td class="py-2 text-[var(--text-primary)]">${t.v_end !== undefined ? t.v_end.toFixed(2) : '-'}</td>
                        <td class="py-2 font-medium text-[var(--text-primary)]">${t.v_used.toFixed(2)}</td>
                        <td class="py-2 text-[var(--accent-color)] font-bold">${toSigFigs(t.c, 4)}</td>
                    </tr>
                `;
            });
            
            html += `
                            </tbody>
                        </table>
                    </div>
                    <div class="text-right">
                         <button onclick="deleteTitrationItem(${idx})" class="text-xs text-red-500 hover:underline">åˆ é™¤æ­¤æ¡è®°å½•</button>
                    </div>
                </div>
            `;
            
            content.innerHTML = html;
            modal.classList.remove('hidden');
        };

        window.closeModal = function() {
            document.getElementById('detail-modal').classList.add('hidden');
        }

        window.deleteTitrationItem = function(idx) {
            if(confirm('ç¡®å®šåˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
                delTitrationHistory(idx);
                closeModal();
            }
        }

        // --- è®¡ç®—æ¨¡å¼ä¸€ï¼šé”Œæ¶²é…åˆ¶ ---
        window.togglePrepMassMode = function() {
            const radios = document.getElementsByName('massModePrep');
            let val = 'direct';
            for (const r of radios) if(r.checked) val = r.value;
            prepMassMode = val;
            
            document.getElementById('prep-mass-direct').classList.toggle('hidden', val !== 'direct');
            document.getElementById('prep-mass-diff').classList.toggle('hidden', val !== 'diff');
            hideMessages();
            setTimeout(() => adjustHeight('prep'), 50);
        }

        window.calculateZnConc = function() {
            let mass = 0;
            let massDetails = {};
            let m1, m2;

            if (prepMassMode === 'direct') {
                mass = parseFloat(document.getElementById('mass-zno').value);
                massDetails = { mode: 'direct', m: mass };
            } else {
                m1 = parseFloat(document.getElementById('mass-zno-m1').value);
                m2 = parseFloat(document.getElementById('mass-zno-m2').value);
                if (isNaN(m1) || isNaN(m2)) {
                    return showError("è¯·è¾“å…¥å®Œæ•´çš„è´¨é‡æ•°æ®");
                }
                mass = Math.abs(m1 - m2);
                massDetails = { mode: 'diff', m1, m2, m: mass };
            }

            const volume = parseFloat(document.getElementById('volume-flask').value);
            
            if (isNaN(mass) || mass <= 0) return showError("è´¨é‡æ— æ•ˆ");
            if (isNaN(volume) || volume <= 0) return showError("è¯·è¾“å…¥æœ‰æ•ˆçš„å®šå®¹ä½“ç§¯");

            // è®¡ç®—æµ“åº¦ C = m / (M * V_L)
            const conc = mass / (M_ZnO * (volume / 1000));
            
            // æ˜¾ç¤ºç»“æœ (4ä½æœ‰æ•ˆæ•°å­—)
            const displayConc = toSigFigs(conc, 4);
            document.getElementById('zinc-concentration').textContent = displayConc;
            
            // è‡ªåŠ¨å¡«å……åˆ°Tab 2
            document.getElementById('conc-zn-input').value = conc.toFixed(5);
            
            document.getElementById('prep-result-box').classList.remove('hidden');
            
            // æ„å»ºå½“å‰çŠ¶æ€å­—ç¬¦ä¸²ï¼Œç”¨äºå»é‡
            const currentState = JSON.stringify({
                mode: prepMassMode,
                m: prepMassMode === 'direct' ? mass : null,
                m1: prepMassMode === 'diff' ? m1 : null,
                m2: prepMassMode === 'diff' ? m2 : null,
                vol: volume
            });

            // ä»…å½“çŠ¶æ€æ”¹å˜æ—¶ä¿å­˜å†å²
            if (currentState !== lastPrepState) {
                prepHistoryData.unshift({
                    t: new Date(),
                    massInfo: massDetails,
                    vol: volume,
                    conc: conc,
                    concDisplay: displayConc
                });
                savePrepHistory();
                lastPrepState = currentState;
            }

            setTimeout(() => adjustHeight('prep'), 100);
        };
        
        window.usePrepData = function(idx) {
            const data = prepHistoryData[idx];
            if (data) {
                document.getElementById('conc-zn-input').value = data.conc.toFixed(5);
                setMode('titration');
                
                // ç®€å•çš„è§†è§‰åé¦ˆ
                const input = document.getElementById('conc-zn-input');
                input.classList.add('ring-2', 'ring-green-400');
                setTimeout(() => input.classList.remove('ring-2', 'ring-green-400'), 1000);
            }
        }

        window.renderPrepHistory = function() {
            const el = document.getElementById('prep-history-container');
            if(!el) return;
            if(!prepHistoryData.length) {
                el.innerHTML = '<p class="text-xs text-center p-4 text-gray-400">æš‚æ— è®°å½•</p>';
                return;
            }
            
            let h = '<table class="history-table"><thead><tr><th>æ—¶é—´</th><th>è´¨é‡(g)</th><th>ä½“ç§¯(mL)</th><th>C(Zn)</th><th>æ“ä½œ</th></tr></thead><tbody>';
            
            prepHistoryData.forEach((d, i) => {
                const time = new Date(d.t).toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'});
                let massStr = d.massInfo.m.toFixed(4);
                if(d.massInfo.mode === 'diff') {
                    massStr += ` <span class="text-[9px] text-gray-400 block">(${d.massInfo.m1}-${d.massInfo.m2})</span>`;
                }
                
                h += `<tr class="clickable-row" onclick="usePrepData(${i})">
                    <td>${time}</td>
                    <td>${massStr}</td>
                    <td>${d.vol}</td>
                    <td class="font-bold text-[var(--accent-color)]">${d.concDisplay}</td>
                    <td><span class="text-xs text-green-600 font-bold border border-green-200 bg-green-50 px-2 py-0.5 rounded whitespace-nowrap">ä½¿ç”¨</span></td>
                </tr>`;
            });
            el.innerHTML = h + '</tbody></table>';
        }
        
        window.savePrepHistory = () => {
            localStorage.setItem('edta_prep_history', JSON.stringify(prepHistoryData));
            renderPrepHistory();
        }
        window.clearPrepHistory = () => {
            prepHistoryData = [];
            savePrepHistory();
            lastPrepState = null; // é‡ç½®çŠ¶æ€ï¼Œå…è®¸ä¸‹æ¬¡ç›¸åŒè¾“å…¥ä¿å­˜
        }

        // --- è®¡ç®—æ¨¡å¼äºŒï¼šEDTA æ ‡å®š ---
        window.calcDelta = function(id) {
            const start = parseFloat(document.getElementById(`v-start-${id}`).value);
            const end = parseFloat(document.getElementById(`v-end-${id}`).value);
            const deltaInput = document.getElementById(`v-delta-${id}`);
            
            if (!isNaN(start) && !isNaN(end)) {
                if (end > start) {
                    deltaInput.value = (end - start).toFixed(2);
                    deltaInput.classList.remove('error-border');
                    document.getElementById('volume-warning').classList.add('hidden');
                } else {
                    deltaInput.value = "Error";
                    deltaInput.classList.add('error-border');
                    document.getElementById('volume-warning').classList.remove('hidden');
                }
            } else {
                deltaInput.value = "";
            }
        }

        window.calculateEDTA = function() {
            const c_Zn = parseFloat(document.getElementById('conc-zn-input').value);
            const v_pipette = parseFloat(document.getElementById('vol-pipette').value);
            
            if (isNaN(c_Zn) || c_Zn <= 0) return showError("è¯·è¾“å…¥æœ‰æ•ˆçš„é”Œæ ‡å‡†æº¶æ¶²æµ“åº¦");
            if (isNaN(v_pipette) || v_pipette <= 0) return showError("è¯·è¾“å…¥æœ‰æ•ˆçš„ç§»å–ä½“ç§¯");

            let trials = [];
            
            // æ”¶é›†è¾“å…¥æ•°æ®ç”¨äºçŠ¶æ€æ¯”è¾ƒ
            let currentInputs = [c_Zn, v_pipette];

            for(let i=1; i<=3; i++) {
                const v_start = parseFloat(document.getElementById(`v-start-${i}`).value);
                const v_end = parseFloat(document.getElementById(`v-end-${i}`).value);
                
                // æ·»åŠ åˆ°çŠ¶æ€æ•°ç»„
                currentInputs.push(document.getElementById(`v-start-${i}`).value); 
                currentInputs.push(document.getElementById(`v-end-${i}`).value);

                if (!isNaN(v_start) && !isNaN(v_end) && v_end > v_start) {
                    const v_consumed = v_end - v_start;
                    
                    // åŸç†ï¼šn(EDTA) = n(Zn) => C(EDTA) * V(EDTA) = C(Zn) * V(Zn)
                    // C(EDTA) = (C(Zn) * V(Zn)) / V(EDTA)
                    const c_edta = (c_Zn * v_pipette) / v_consumed;
                    
                    trials.push({ 
                        id: i, 
                        v_start: v_start, // è®°å½•åˆè¯»æ•°
                        v_end: v_end,     // è®°å½•ç»ˆè¯»æ•°
                        v_used: v_consumed, 
                        c: c_edta 
                    });
                }
            }
            
            if(trials.length < 2) return showError("è¯·è‡³å°‘è¾“å…¥2ç»„æœ‰æ•ˆçš„æ»´å®šæ•°æ®");
            
            // è®¡ç®—ç»Ÿè®¡é‡
            const avg = trials.reduce((a,b)=>a+b.c,0)/trials.length;
            
            // æ”¹ä¸ºè®¡ç®—å¹³å‡åå·® (Average Deviation)
            const sumAbsDev = trials.reduce((a,b)=>a+Math.abs(b.c-avg), 0);
            const avgDev = sumAbsDev / trials.length;
            
            // è®¡ç®—ç›¸å¯¹å¹³å‡åå·® (Relative Average Deviation, RAD)
            const rad = (avgDev / avg) * 100;

            // æ˜¾ç¤ºç»“æœ - ä¸¥æ ¼4ä½æœ‰æ•ˆæ•°å­—
            const avg_display = toSigFigs(avg, 4);

            document.getElementById('avg-edta').textContent = avg_display;
            
            const rsdEl = document.getElementById('rsd-value');
            const rsdAlert = document.getElementById('rsd-alert');
            
            rsdEl.textContent = rad.toFixed(2) + '%';
            
            if(rad > 0.30) {
                rsdEl.className = "font-black text-lg text-[var(--color-error)]";
                if(rsdAlert) rsdAlert.classList.remove('hidden');
            } else {
                 rsdEl.className = "font-bold text-lg text-[var(--text-primary)]";
                 if(rsdAlert) rsdAlert.classList.add('hidden');
            }
            
            document.getElementById('titration-result-box').classList.remove('hidden');

            // æ„å»ºå½“å‰çŠ¶æ€å­—ç¬¦ä¸²
            const currentState = JSON.stringify(currentInputs);

            // ä»…å½“çŠ¶æ€æ”¹å˜æ—¶ä¿å­˜å†å²
            if (currentState !== lastTitrationState) {
                titrationHistoryData.unshift({
                    t: new Date(),
                    c_zn: c_Zn,
                    v_zn: v_pipette,
                    c_edta_avg: avg_display,
                    rad: rad, // ä¿å­˜æ–°çš„ RAD æ•°æ®
                    trials: trials
                });
                saveTitrationHistory();
                lastTitrationState = currentState;
            }

            setTimeout(() => adjustHeight('titration'), 100);
        };

        // å†å²è®°å½•
        window.renderTitrationHistory = function() {
            const el = document.getElementById('titration-history-container');
            if (!el) return;
            
            if(!titrationHistoryData.length) { 
                el.innerHTML = '<p class="text-xs text-center p-4 text-gray-400">æš‚æ— å†å²è®°å½•</p>'; 
                return; 
            }

            let h = '<table class="history-table"><thead><tr>';
            h += '<th>æ—¶é—´</th><th>C(Zn)</th><th>C(EDTA)</th><th>ç›¸å¯¹å¹³å‡åå·®</th><th>æ“ä½œ</th></tr></thead><tbody>';

            titrationHistoryData.forEach((d, i) => {
                const time = new Date(d.t).toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'});
                // å…¼å®¹æ—§æ•°æ® (RSD) å’Œæ–°æ•°æ® (RAD)
                const devValue = d.rad !== undefined ? d.rad : d.rsd;
                
                h += `<tr class="clickable-row" onclick="showDetail(${i})">`;
                h += `<td>${time}</td>`;
                h += `<td>${toSigFigs(parseFloat(d.c_zn), 4)}</td>`;
                h += `<td class="font-bold text-[var(--accent-color)]">${d.c_edta_avg}</td>`;
                h += `<td class="${devValue > 0.3 ? 'text-red-500 font-bold' : ''}">${devValue.toFixed(2)}%</td>`;
                h += `<td><span class="text-xs text-blue-500 underline">è¯¦æƒ…</span></td></tr>`;
            });
            el.innerHTML = h + '</tbody></table>';
        }
        
        window.saveTitrationHistory = () => {
            localStorage.setItem('edta_history', JSON.stringify(titrationHistoryData));
            renderTitrationHistory();
        };
        window.delTitrationHistory = (idx) => {
            titrationHistoryData.splice(idx,1);
            saveTitrationHistory();
            setTimeout(() => adjustHeight('titration'), 50);
        };
        window.clearTitrationHistory = () => {
            titrationHistoryData = [];
            saveTitrationHistory();
            lastTitrationState = null; // é‡ç½®çŠ¶æ€
            setTimeout(() => adjustHeight('titration'), 50);
        };
        
        window.exportCSV = function() {
             if (!titrationHistoryData.length) return showError("æ— æ•°æ®å¯å¯¼å‡º");
             
             let csv = "æ—¶é—´,C_Zn(mol/L),V_Zn(mL),C_EDTA_Avg(mol/L),ç›¸å¯¹å¹³å‡åå·®(%),Trial1_Start,Trial1_End,Trial1_V,Trial1_C,Trial2_Start,Trial2_End,Trial2_V,Trial2_C,Trial3_Start,Trial3_End,Trial3_V,Trial3_C\n";
             
             titrationHistoryData.forEach(d => {
                 const devValue = d.rad !== undefined ? d.rad : d.rsd;
                 let row = `${new Date(d.t).toLocaleString()},${d.c_zn},${d.v_zn},${d.c_edta_avg},${devValue.toFixed(2)}`;
                 
                 for(let i=0; i<3; i++) {
                     const t = d.trials.find(x => x.id === i+1);
                     if(t) row += `,${t.v_start},${t.v_end},${t.v_used.toFixed(2)},${toSigFigs(t.c, 4)}`;
                     else row += `,-,-,-,-`;
                 }
                 csv += row + "\n";
             });
             
             const blob = new Blob(["\ufeff"+csv], {type: 'text/csv;charset=utf-8'});
             const url = URL.createObjectURL(blob);
             const a = document.createElement('a');
             a.href = url;
             a.download = `edta_standardization.csv`;
             a.click();
        }

        window.copyResult = (el) => {
            navigator.clipboard.writeText(el.textContent);
            const t = document.getElementById('toast-notification');
            t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2000);
        };

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            try {
                const cfg = JSON.parse(localStorage.getItem('edtaConfig'));
                if(cfg) { applyTheme(cfg.accent, cfg.mode); isAnimationEnabled = cfg.anim; }
                else applyTheme('violet', 'light');
                
                titrationHistoryData = JSON.parse(localStorage.getItem('edta_history')||'[]');
                prepHistoryData = JSON.parse(localStorage.getItem('edta_prep_history')||'[]');
                
                renderTitrationHistory();
                renderPrepHistory();
                
                setTimeout(() => setMode('prep'), 100);
                
                // èƒŒæ™¯ç²’å­ï¼šç”ŸæˆåŒ–å­¦ç¬¦å·
                const fc = document.getElementById('floating-container');
                const symbols = ['ZnÂ²âº', 'EDTA', 'Hâ‚‚YÂ²â»', 'Clâ»', 'ZnO', 'Hâº', 'pH=5', 'Zn-Y', 'mol/L', 'buffer', 'NHâ‚ƒ'];
                
                for(let i=0;i<40;i++) { 
                    const d = document.createElement('div'); 
                    d.className='floating-element';
                    d.textContent = symbols[Math.floor(Math.random()*symbols.length)];
                    d.style.setProperty('--initial-x-offset', Math.random()*100+'vw');
                    const scale = 0.8 + Math.random() * 1.5;
                    d.style.fontSize = scale + 'rem';
                    d.style.animationDuration = (15 + Math.random() * 25) + 's';
                    d.style.animationDelay = -Math.random()*30+'s';
                    fc.appendChild(d);
                }
                
                // é¦–æ¬¡è®¿é—®æç¤ºæ»‘åŠ¨
                if(window.innerWidth < 640 && !localStorage.getItem('seenSwipeEDTA')) {
                    document.getElementById('swipe-hint').style.display = 'flex';
                    localStorage.setItem('seenSwipeEDTA','1');
                }
            } catch(e) { console.error(e); }
        });

        // è§¦æ‘¸æ»‘åŠ¨é€»è¾‘
        let tx = 0, ty = 0;
        let isSwipeIgnored = false;

        document.addEventListener('touchstart', e => { 
            tx = e.touches[0].clientX; 
            ty = e.touches[0].clientY;
            // å¿½ç•¥ Modal å’Œæ»šåŠ¨å®¹å™¨å†…çš„æ»‘åŠ¨
            const scrollContainer = e.target.closest('.overflow-x-auto, #modal-content');
            if (scrollContainer && scrollContainer.scrollHeight > scrollContainer.clientHeight) {
                isSwipeIgnored = true;
            } else {
                isSwipeIgnored = false;
            }
        }, {passive:true});

        document.addEventListener('touchend', e => {
            if (isSwipeIgnored) return;
            const dx = e.changedTouches[0].clientX - tx;
            const dy = e.changedTouches[0].clientY - ty;
            
            if(Math.abs(dx) > 60 && Math.abs(dx) > Math.abs(dy)*2) {
                const active = document.getElementById('tab-prep').classList.contains('active-mode');
                if(dx < 0 && active) setMode('titration');
                if(dx > 0 && !active) setMode('prep');
            }
        }, {passive:true});

    </script>
</body>
</html>