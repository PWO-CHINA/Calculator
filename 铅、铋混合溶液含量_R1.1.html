<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é“…é“‹åˆé‡‘å«é‡æµ‹å®šè®¡ç®—å™¨ (EDTAè¿ç»­æ»´å®šæ³•)</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ä¼˜åŒ–æ’ç‰ˆå±‚çº§ - æ”¹ç”¨ç³»ç»Ÿé»˜è®¤å­—ä½“æ ˆ */
        :root {
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            --bg-canvas: #f0f5f9;
            --bg-surface: #ffffff;
            --text-primary: #1a1a1a;
            --text-secondary: #6b7280;
            --accent-color: #7c3aed; /* é»˜è®¤ä¸ºç´«è‰² */
            --accent-color-dark: #6d28d9; /* æ·±è‰²ç”¨äºæ¸å˜ */
            --accent-bg: #f5f3ff;
            --color-error: #ef4444;
            --color-warning: #f59e0b;
            --border-light: #e0e0e0;
            --button-text: #ffffff;
            --accent-color-rgb: 124, 58, 237;
            --animation-state: running;
        }

        body {
            background-color: var(--bg-canvas);
            transition: background-color 0.5s ease, color 0.5s ease;
            background-image: radial-gradient(
                circle at 50% 10%, 
                rgba(var(--accent-color-rgb), 0.08) 0%, 
                var(--bg-canvas) 60%
            );
            background-size: cover;
            background-attachment: fixed;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 1.5rem 0;
            box-sizing: border-box;
            overflow-x: hidden;
            position: relative;
        }
        
        .main-calculator-card {
            position: relative;
            z-index: 20;
            width: 90%;
            max-width: 800px;
            margin: 0;
            margin-bottom: 4rem; 
        }

        /* --- åŠ¨ç”»èƒŒæ™¯ --- */
        #floating-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            overflow: hidden;
            pointer-events: none; 
            z-index: 1;
        }
        
        .floating-element {
            position: absolute;
            top: 0;
            left: var(--random-x);
            color: var(--accent-color);
            opacity: 0.12;
            font-weight: 700;
            line-height: 1;
            white-space: nowrap;
            animation: waterfall linear infinite;
            animation-play-state: var(--animation-state);
            user-select: none;
            font-family: 'Times New Roman', serif;
            will-change: transform;
            transform: translate3d(0, -100vh, 0); 
        }

        @keyframes waterfall {
            0% { transform: translate3d(0, -100vh, 0); }
            100% { transform: translate3d(0, 150vh, 0); }
        }
        
        /* --- æ·±è‰²æ¨¡å¼ --- */
        body[data-mode="dark"] {
            --bg-canvas: #0f172a;           
            --bg-surface: #1e293b;          
            --text-primary: #f8fafc;        
            --text-secondary: #94a3b8;      
            --color-error: #f87171;         
            --border-light: #334155;        
            --button-text: #0f172a;         
             background-image: radial-gradient(
                circle at 50% 10%, 
                rgba(var(--accent-color-rgb), 0.15) 0%, 
                var(--bg-canvas) 50%
            );
        }

        /* é€šç”¨ç±» */
        .bg-surface { background-color: var(--bg-surface); }
        .text-primary { color: var(--text-primary); }
        .text-secondary { color: var(--text-secondary); }
        .border-light { border-color: var(--border-light); }
        .accent-bg { background-color: var(--accent-bg); }
        
        /* è¾“å…¥æ¡†æ ·å¼ */
        .input-field {
            border-color: var(--border-light);
            color: var(--text-primary);
            background-color: var(--bg-surface);
            transition: border-color 0.3s, background-color 0.5s;
        }
        .input-field:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(var(--accent-color-rgb), 0.3);
            outline: none;
        }

        .theme-button { 
            position: relative; 
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .theme-button:hover {
            transform: scale(1.1);
        }
        .theme-button.active {
            transform: scale(1.15);
            box-shadow: 0 0 0 2px var(--bg-surface), 0 0 0 4px var(--text-primary);
        }

        /* è¡¨æ ¼æ ·å¼ */
        .result-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        .result-table th, .result-table td {
            padding: 10px 8px;
            text-align: center;
            border: 1px solid var(--border-light);
            color: var(--text-primary);
        }
        .result-table th {
            background-color: var(--accent-bg); 
            color: var(--text-primary);
            font-weight: 700;
        }
        .result-table tr:hover td {
            background-color: rgba(var(--accent-color-rgb), 0.05);
        }

        /* æŒ‰é’®åŠ¨æ•ˆ - ä¼˜åŒ–ç‰ˆ */
        .calculate-button {
            /* ä½¿ç”¨æ¸å˜èƒŒæ™¯ï¼Œæ›´å…·ç°ä»£æ„Ÿ */
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--accent-color-dark) 100%);
            color: var(--button-text); 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            font-weight: 700;
            border: none;
            position: relative;
            overflow: hidden;
        }
        .calculate-button::after {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0.15), transparent);
            pointer-events: none;
        }
        .calculate-button:hover {
            filter: brightness(1.1); 
            box-shadow: 0 8px 20px -4px rgba(var(--accent-color-rgb), 0.5); 
            transform: translateY(-2px); 
        }
        .calculate-button:active {
            filter: brightness(0.95); 
            transform: scale(0.98); 
            box-shadow: 0 4px 10px -2px rgba(var(--accent-color-rgb), 0.3);
        }
        .active-scale-98:active { transform: scale(0.98); }

        .main-title { font-size: 1.8rem; font-weight: 900; letter-spacing: -0.05em; line-height: 1.2; }
        .section-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 0.5rem; color: var(--text-primary); }

        /* Toast æç¤ºæ ·å¼ */
        #toast-notification {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background-color: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(4px);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-size: 0.9rem;
            font-weight: 500;
            z-index: 100;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            pointer-events: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        #toast-notification.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        
        .copyable-result {
            cursor: pointer;
            border-bottom: 1px dashed var(--accent-color);
        }
        .copyable-result:active { opacity: 0.7; }

        .text-warning { color: var(--color-warning); }
        .text-error { color: var(--color-error); }
        
        /* é’ˆå¯¹å°å±å¹•ä¼˜åŒ–è¡¨æ ¼ */
        @media (max-width: 640px) {
            .result-table { display: block; overflow-x: auto; white-space: nowrap; }
        }

        /* --- ç§»åŠ¨ç«¯æ¨ªå‘æ»šåŠ¨ä¼˜åŒ– --- */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .dot-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--border-light);
            transition: all 0.3s ease;
        }
        .dot-indicator.active {
            background-color: var(--accent-color);
            transform: scale(1.2);
            width: 20px;
            border-radius: 4px;
        }

        @keyframes swipe-hint {
            0%, 100% { transform: translateX(0); opacity: 0.5; }
            50% { transform: translateX(10px); opacity: 1; }
        }
        .swipe-hint-icon {
            animation: swipe-hint 1.5s infinite;
        }

        /* å†å²è®°å½•å±•å¼€æ ·å¼ */
        .history-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            opacity: 0;
        }
        .history-details.open {
            max-height: 1000px;
            opacity: 1;
            margin-top: 1rem;
        }
        .history-summary-row {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .history-summary-row:hover {
            background-color: rgba(var(--accent-color-rgb), 0.05);
        }
        .expand-icon {
            transition: transform 0.3s;
        }
        .expand-icon.open {
            transform: rotate(180deg);
        }
        
        /* è­¦å‘ŠåŠ¨ç”» */
        @keyframes pulse-error {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .data-warning {
            animation: pulse-error 2s infinite;
            color: var(--color-error);
            font-weight: 900;
        }
    </style>
</head>
<body data-mode="light">
    
    <div id="floating-container"></div>
    
    <!-- Toast Notification -->
    <div id="toast-notification">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
        <span>å†…å®¹å·²å¤åˆ¶</span>
    </div>

    <div class="main-calculator-card bg-surface shadow-2xl rounded-2xl p-6 sm:p-8 space-y-6 border-t-8 border-[var(--accent-color)] transition-colors duration-500">

        <!-- é¡¶éƒ¨æ§åˆ¶åŒº -->
        <div class="flex flex-col space-y-4 pb-4 border-b border-[var(--border-light)] transition-colors duration-500">
            <div class="flex justify-between items-center">
                <div class="flex flex-wrap items-center space-x-3">
                    <span class="text-sm font-medium text-[var(--text-secondary)]">ç•Œé¢æ¨¡å¼:</span>
                    <button onclick="toggleMode()" class="px-3 py-1 bg-[var(--accent-bg)] rounded-full text-[var(--text-primary)] border border-[var(--border-light)] text-xs font-bold active-scale-98">
                        <span id="mode-text">æµ…è‰²</span>
                    </button>
                    <button onclick="toggleAnimation()" class="px-3 py-1 bg-[var(--accent-bg)] rounded-full text-[var(--text-primary)] border border-[var(--border-light)] text-xs font-bold active-scale-98">
                        <span id="animation-text">åŠ¨æ•ˆå¼€</span>
                    </button>
                </div>
                <!-- ä¸»é¢˜è‰²é€‰æ‹© -->
                <div class="flex items-center space-x-2">
                    <button onclick="setAccent('purple')" class="theme-button w-6 h-6 rounded-full active" style="background: #7c3aed;" title="ç´«ç½—å…° (äºŒç”²é…šæ©™)"></button>
                    <button onclick="setAccent('emerald')" class="theme-button w-6 h-6 rounded-full" style="background: #059669;" title="ç¥–æ¯ç»¿"></button>
                    <button onclick="setAccent('blue')" class="theme-button w-6 h-6 rounded-full" style="background: #2563eb;" title="å®éªŒå®¤è“"></button>
                    <button onclick="setAccent('amber')" class="theme-button w-6 h-6 rounded-full" style="background: #f59e0b;" title="äº®é»„è‰²/æ©™è‰²"></button>
                </div>
            </div>
            
            <div class="text-center space-y-2">
                <h1 class="main-title text-primary">EDTA æ ‡å‡†æº¶æ¶²æ»´å®šæµ‹å®š<br>é“…ã€é“‹æ··åˆæº¶æ¶²å«é‡</h1>
                <p class="text-[var(--text-secondary)] text-sm">pHæ§åˆ¶æ³•è¿ç»­æ»´å®š (BiÂ³âº at pHâ‰ˆ1, PbÂ²âº at pHâ‰ˆ5-6)</p>
            </div>
        </div>
        
        <!-- å…¨å±€å‚æ•°è®¾ç½® -->
        <div class="bg-[var(--accent-bg)] p-4 rounded-lg border border-[var(--border-light)] transition-colors duration-500">
            <h2 class="section-title">ğŸ§ª å®éªŒå…¬å…±å‚æ•°</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="sm:col-span-2 lg:col-span-1">
                    <label class="block text-xs font-bold text-primary mb-1">EDTA æµ“åº¦ c (mol/L)</label>
                    <input type="number" id="c-edta" min="0" oninput="if(value<0)value=0" placeholder="0.0500" class="w-full rounded-lg p-2 border input-field tabular-nums" onchange="formatInputSigFigs(this, 4)">
                </div>
                <div class="sm:col-span-2 lg:col-span-1">
                    <label class="block text-xs font-bold text-primary mb-1">è¯•æ ·æ€»è´¨é‡ m (g)</label>
                    <input type="number" id="m-sample" min="0" oninput="if(value<0)value=0" placeholder="0.6000" class="w-full rounded-lg p-2 border input-field tabular-nums" onchange="formatInputSigFigs(this, 4)">
                </div>
                <div>
                    <label class="block text-xs font-bold text-primary mb-1">å®šå®¹ä½“ç§¯ (mL)</label>
                    <input type="number" id="v-total" min="0" oninput="if(value<0)value=0" value="100.0" class="w-full rounded-lg p-2 border input-field tabular-nums">
                </div>
                <div>
                    <label class="block text-xs font-bold text-primary mb-1">ç§»å–ä½“ç§¯ (mL)</label>
                    <input type="number" id="v-pipette" min="0" oninput="if(value<0)value=0" value="25.00" class="w-full rounded-lg p-2 border input-field tabular-nums">
                </div>
            </div>
        </div>

        <!-- æ•°æ®è¾“å…¥åŒº (3æ¬¡æµ‹å®š - ç§»åŠ¨ç«¯æ”¯æŒæ¨ªå‘æ»‘åŠ¨) -->
        <div class="space-y-4">
            <div class="flex justify-between items-end">
                <h2 class="section-title flex items-center gap-2">
                    ğŸ“Š å¹³è¡Œæµ‹å®šæ•°æ®å½•å…¥
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-[var(--accent-color)] lg:hidden swipe-hint-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7" />
                    </svg>
                </h2>
                <span class="text-xs text-[var(--text-secondary)]">è¯»æ•°ç²¾ç¡®åˆ° 0.01 mL</span>
            </div>
            
            <div id="trials-container" class="flex lg:grid lg:grid-cols-3 gap-4 overflow-x-auto lg:overflow-visible snap-x snap-mandatory hide-scrollbar pb-2">
                <!-- åŠ¨æ€ç”Ÿæˆçš„è¾“å…¥å¡ç‰‡ -->
            </div>
            
            <div id="trial-indicators" class="flex justify-center space-x-2 lg:hidden">
                <!-- JS å¡«å…… dots -->
            </div>
        </div>

        <!-- è®¡ç®—æŒ‰é’® -->
        <button onclick="calculateResults()" class="w-full flex justify-center py-3 px-4 rounded-lg shadow-lg text-lg calculate-button mt-4">
            è®¡ç®—è´¨é‡åˆ†æ•° & å‡†ç¡®æ€§åˆ¤å®š
        </button>

        <!-- ç»“æœå±•ç¤ºåŒº -->
        <div id="result-section" class="hidden space-y-6">
            
            <!-- å‡†ç¡®æ€§è­¦å‘ŠåŒº -->
            <div id="accuracy-alert" class="hidden p-4 bg-red-50 border-l-4 border-red-500 rounded-r shadow-sm flex items-start">
                <svg class="h-6 w-6 text-red-500 mr-2 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                <div>
                    <h4 class="text-red-700 font-bold text-sm">æ•°æ®å¼‚å¸¸è­¦å‘Š</h4>
                    <p class="text-red-600 text-xs mt-1">æ£€æµ‹åˆ°è®¡ç®—å¾—å‡ºçš„(é“…+é“‹)ç†è®ºè´¨é‡æ€»å’Œå¤§äºæ‚¨ç§°é‡çš„è¯•æ ·è´¨é‡ï¼è¯·æ£€æŸ¥ï¼š<br>1. ç§°é‡è´¨é‡è¾“å…¥æ˜¯å¦æ­£ç¡®<br>2. æ»´å®šç®¡è¯»æ•°æ˜¯å¦å­˜åœ¨è¯¯å·®<br>3. EDTA æµ“åº¦æ˜¯å¦å‡†ç¡®</p>
                </div>
            </div>

            <!-- ç»Ÿè®¡ç»“æœå¡ç‰‡ (ç§»åˆ°å‰é¢) -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="p-4 rounded-lg border border-[var(--border-light)] bg-surface shadow-sm relative overflow-hidden" id="card-bi">
                    <div class="absolute top-0 right-0 p-2 opacity-5 text-4xl font-serif font-bold">Bi</div>
                    <h3 class="font-bold text-[var(--accent-color)] mb-2 border-b pb-2">é“‹ (Bi) åˆ†æç»“æœ</h3>
                    <div class="flex justify-between mb-1">
                        <span class="text-sm text-secondary">å¹³å‡æµ“åº¦:</span>
                        <span class="font-bold text-primary tabular-nums" id="avg-conc-bi">-</span>
                    </div>
                    <div class="flex justify-between mb-1">
                        <span class="text-sm text-secondary">ç›¸å¯¹æ ‡å‡†åå·® (RSD):</span>
                        <span class="font-bold text-primary tabular-nums" id="rsd-bi">-</span>
                    </div>
                    <div class="flex justify-between mt-2 pt-2 border-t border-dashed border-[var(--border-light)]">
                        <span class="text-sm font-bold text-primary">è´¨é‡åˆ†æ•° (%):</span>
                        <span class="font-bold text-[var(--accent-color)] text-lg tabular-nums copyable-result" onclick="copyText(this)" id="final-percent-bi">-</span>
                    </div>
                </div>
                <div class="p-4 rounded-lg border border-[var(--border-light)] bg-surface shadow-sm relative overflow-hidden" id="card-pb">
                    <div class="absolute top-0 right-0 p-2 opacity-5 text-4xl font-serif font-bold">Pb</div>
                    <h3 class="font-bold text-[var(--accent-color)] mb-2 border-b pb-2">é“… (Pb) åˆ†æç»“æœ</h3>
                    <div class="flex justify-between mb-1">
                        <span class="text-sm text-secondary">å¹³å‡æµ“åº¦:</span>
                        <span class="font-bold text-primary tabular-nums" id="avg-conc-pb">-</span>
                    </div>
                    <div class="flex justify-between mb-1">
                        <span class="text-sm text-secondary">ç›¸å¯¹æ ‡å‡†åå·® (RSD):</span>
                        <span class="font-bold text-primary tabular-nums" id="rsd-pb">-</span>
                    </div>
                    <div class="flex justify-between mt-2 pt-2 border-t border-dashed border-[var(--border-light)]">
                        <span class="text-sm font-bold text-primary">è´¨é‡åˆ†æ•° (%):</span>
                        <span class="font-bold text-[var(--accent-color)] text-lg tabular-nums copyable-result" onclick="copyText(this)" id="final-percent-pb">-</span>
                    </div>
                </div>
            </div>

            <!-- è¡¨æ ¼ (ç§»åˆ°åé¢) -->
            <div class="border-t-2 border-[var(--accent-color)] pt-6 mt-6">
                <h2 class="section-title text-center mb-4">ğŸ“ æ•°æ®è®°å½•ä¸å¤„ç†è¡¨</h2>
                <div class="overflow-x-auto rounded-lg shadow-sm border border-[var(--border-light)]">
                    <table class="result-table bg-surface">
                        <thead>
                            <tr>
                                <th style="width: 30%">æµ‹å®šæ¬¡æ•°</th>
                                <th style="width: 23%">1</th>
                                <th style="width: 23%">2</th>
                                <th style="width: 23%">3</th>
                            </tr>
                        </thead>
                        <tbody id="result-table-body">
                            <!-- JS å¡«å…… -->
                        </tbody>
                    </table>
                </div>
            </div>
            
        </div>

        <!-- å†å²è®°å½•æ§åˆ¶ -->
        <div class="pt-6 border-t border-[var(--border-light)]">
            <div class="flex justify-between items-center mb-4">
                <h2 class="section-title mb-0">ğŸ’¾ å†å²è®°å½•</h2>
                <div class="space-x-2">
                     <button onclick="exportCSV()" class="px-3 py-1.5 bg-[#10b981] text-white rounded text-sm font-medium hover:bg-[#059669] transition active-scale-98">
                        å¯¼å‡º CSV
                    </button>
                    <button onclick="clearHistory()" class="px-3 py-1.5 bg-[var(--color-error)] text-white rounded text-sm font-medium hover:opacity-90 transition active-scale-98">
                        æ¸…ç©º
                    </button>
                </div>
            </div>
            <p class="text-xs text-[var(--text-secondary)] mb-4">ç‚¹å‡»è®°å½•è¡Œå¯æŸ¥çœ‹/æ”¶èµ·å®Œæ•´æ•°æ®è¡¨</p>
            <div id="history-container" class="space-y-3">
                <!-- å†å²å¡ç‰‡ -->
            </div>
        </div>

    </div>

    <script>
        // --- æ ¸å¿ƒé€»è¾‘ ---
        
        const HISTORY_KEY = 'pbBiTitrationHistory_v2';
        let historyData = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
        
        let lastSubmissionHash = "";

        // åŸå­é‡å¸¸é‡ (g/mol)
        const ATOMIC_WEIGHT_Bi = 208.98;
        const ATOMIC_WEIGHT_Pb = 207.2;

        function roundToSigFigs(num, sigFigs) {
            if (num === 0) return "0.0000".substring(0, sigFigs + 1);
            if (isNaN(num)) return "-";

            const absNum = Math.abs(num);
            const d = Math.floor(Math.log10(absNum));
            const shift = sigFigs - 1 - d;
            const magnitude = Math.pow(10, shift);
            const shifted = num * magnitude;

            let roundedShifted;
            const integerPart = Math.floor(shifted);
            const fractionalPart = shifted - integerPart;
            
            const epsilon = 1e-10;

            if (Math.abs(fractionalPart - 0.5) < epsilon) {
                if (integerPart % 2 === 0) {
                    roundedShifted = integerPart;
                } else {
                    roundedShifted = integerPart + 1;
                }
            } else if (fractionalPart > 0.5) {
                roundedShifted = Math.ceil(shifted);
            } else {
                roundedShifted = Math.floor(shifted);
            }

            const result = roundedShifted / magnitude;
            const decimalPlaces = Math.max(0, shift);
            return result.toFixed(decimalPlaces);
        }

        function formatInputSigFigs(input, sigFigs) {
            const val = parseFloat(input.value);
            if (!isNaN(val) && val !== 0) {
                input.value = roundToSigFigs(val, sigFigs);
            }
        }

        function initTrials() {
            const container = document.getElementById('trials-container');
            const indicatorsContainer = document.getElementById('trial-indicators');
            let html = '';
            let indicatorsHtml = '';

            for (let i = 1; i <= 3; i++) {
                html += `
                <div class="min-w-[85%] sm:min-w-[45%] lg:min-w-0 lg:w-full flex-shrink-0 snap-center p-4 rounded-lg border border-[var(--border-light)] bg-surface shadow-sm relative trial-card transition-all duration-300">
                    <div class="absolute top-2 right-2 text-xs font-bold text-[var(--accent-color)] opacity-30 text-4xl select-none">${i}</div>
                    <h3 class="font-bold text-primary mb-3 text-sm">ç¬¬ ${i} æ¬¡æµ‹å®š</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs text-secondary mb-1">åˆè¯»æ•° V<sub>åˆ</sub> (mL)</label>
                            <input type="number" id="v-start-${i}" min="0" oninput="if(value<0)value=0; liveCalc(${i})" step="0.01" class="w-full rounded p-2 border input-field text-sm tabular-nums" placeholder="0.00">
                        </div>
                        <div>
                            <label class="block text-xs text-secondary mb-1">ç¬¬ä¸€ç»ˆç‚¹ V<sub>1</sub> (pHâ‰ˆ1, Bi)</label>
                            <input type="number" id="v-end1-${i}" min="0" oninput="if(value<0)value=0; liveCalc(${i})" step="0.01" class="w-full rounded p-2 border input-field text-sm tabular-nums" placeholder="mL">
                        </div>
                        <div>
                            <label class="block text-xs text-secondary mb-1">ç¬¬äºŒç»ˆç‚¹ V<sub>2</sub> (pHâ‰ˆ5, Pb)</label>
                            <input type="number" id="v-end2-${i}" min="0" oninput="if(value<0)value=0; liveCalc(${i})" step="0.01" class="w-full rounded p-2 border input-field text-sm tabular-nums" placeholder="mL">
                        </div>
                        <div class="pt-2 border-t border-dashed border-[var(--border-light)] text-xs space-y-1">
                            <div class="flex justify-between"><span class="text-secondary">æ¶ˆè€— V<sub>Bi</sub> (mL):</span> <span id="disp-vBi-${i}" class="tabular-nums font-bold text-[var(--accent-color)]">-</span></div>
                            <div class="flex justify-between"><span class="text-secondary">æ¶ˆè€— V<sub>Pb</sub> (mL):</span> <span id="disp-vPb-${i}" class="tabular-nums font-bold text-[var(--accent-color)]">-</span></div>
                        </div>
                    </div>
                </div>`;
                
                indicatorsHtml += `<div class="dot-indicator ${i === 1 ? 'active' : ''}" data-index="${i-1}"></div>`;
            }
            container.innerHTML = html;
            indicatorsContainer.innerHTML = indicatorsHtml;

            setupScrollObserver(container);
        }

        function setupScrollObserver(container) {
            const cards = container.querySelectorAll('.trial-card');
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const index = Array.from(cards).indexOf(entry.target);
                        updateDots(index);
                    }
                });
            }, { root: container, threshold: 0.6 });

            cards.forEach(card => observer.observe(card));
        }

        function updateDots(activeIndex) {
            const dots = document.querySelectorAll('.dot-indicator');
            dots.forEach((dot, idx) => {
                if (idx === activeIndex) dot.classList.add('active');
                else dot.classList.remove('active');
            });
        }

        function liveCalc(index) {
            const vStart = parseFloat(document.getElementById(`v-start-${index}`).value);
            const vEnd1 = parseFloat(document.getElementById(`v-end1-${index}`).value);
            const vEnd2 = parseFloat(document.getElementById(`v-end2-${index}`).value);
            
            const dispVBi = document.getElementById(`disp-vBi-${index}`);
            const dispVPb = document.getElementById(`disp-vPb-${index}`);
            
            if (!isNaN(vStart) && !isNaN(vEnd1)) {
                let vBi = vEnd1 - vStart;
                dispVBi.textContent = vBi.toFixed(2);
                dispVBi.className = vBi < 0 ? 'text-red-500 font-bold tabular-nums' : 'text-[var(--accent-color)] font-bold tabular-nums';
            } else {
                dispVBi.textContent = '-';
            }

            if (!isNaN(vEnd1) && !isNaN(vEnd2)) {
                let vPb = vEnd2 - vEnd1; 
                dispVPb.textContent = vPb.toFixed(2);
                dispVPb.className = vPb < 0 ? 'text-red-500 font-bold tabular-nums' : 'text-[var(--accent-color)] font-bold tabular-nums';
            } else {
                dispVPb.textContent = '-';
            }
        }

        // RSD è®¡ç®—è¾…åŠ©å‡½æ•°
        function calcRSD(arr) {
            if (arr.length < 2) return 0;
            const mean = arr.reduce((a, b) => a + b) / arr.length;
            const sumSqDiff = arr.reduce((a, b) => a + Math.pow(b - mean, 2), 0);
            const stdDev = Math.sqrt(sumSqDiff / (arr.length - 1));
            return (stdDev / mean) * 100;
        }
        
        function calcMean(arr) {
            return arr.length ? arr.reduce((a, b) => a + b) / arr.length : 0;
        }

        function calculateResults() {
            const cEDTA = parseFloat(document.getElementById('c-edta').value);
            const mSample = parseFloat(document.getElementById('m-sample').value);
            const vTotal = parseFloat(document.getElementById('v-total').value);
            const vPipette = parseFloat(document.getElementById('v-pipette').value);
            
            if (isNaN(cEDTA) || cEDTA <= 0) return showToast("è¯·è¾“å…¥æœ‰æ•ˆçš„ EDTA æµ“åº¦", true);
            if (isNaN(mSample) || mSample <= 0) return showToast("è¯·è¾“å…¥æœ‰æ•ˆçš„è¯•æ ·è´¨é‡", true);
            if (isNaN(vTotal) || vTotal <= 0) return showToast("å®šå®¹ä½“ç§¯æ— æ•ˆ", true);
            if (isNaN(vPipette) || vPipette <= 0) return showToast("ç§»å–ä½“ç§¯æ— æ•ˆ", true);

            let results = [];
            let validTrials = 0;
            let rawInputs = { c: cEDTA, m: mSample, vt: vTotal, vp: vPipette, data: [] };
            
            let concBiArr = [];
            let concPbArr = [];

            for (let i = 1; i <= 3; i++) {
                const vStart = parseFloat(document.getElementById(`v-start-${i}`).value);
                const vEnd1 = parseFloat(document.getElementById(`v-end1-${i}`).value);
                const vEnd2 = parseFloat(document.getElementById(`v-end2-${i}`).value);
                
                rawInputs.data.push({ s: vStart, e1: vEnd1, e2: vEnd2 });

                if (isNaN(vStart) || isNaN(vEnd1) || isNaN(vEnd2)) {
                    results.push(null);
                    continue;
                }
                
                validTrials++;

                const V_Bi = vEnd1 - vStart;
                const V_Pb = vEnd2 - vEnd1;
                
                // 1. è®¡ç®—æ‘©å°”æµ“åº¦ C (mol/L)
                // C_metal = C_EDTA * V_metal / V_pipette
                const concBi = (cEDTA * V_Bi) / vPipette;
                const concPb = (cEDTA * V_Pb) / vPipette;
                
                concBiArr.push(concBi);
                concPbArr.push(concPb);

                results.push({
                    vStart, vEnd1, vEnd2, V_Bi, V_Pb,
                    concBi, concPb
                });
            }

            if (validTrials === 0) return showToast("è¯·è‡³å°‘è¾“å…¥ä¸€ç»„å®Œæ•´æ•°æ®", true);
            
            // 2. ç»Ÿè®¡è®¡ç®—
            const avgConcBi = calcMean(concBiArr);
            const rsdBi = calcRSD(concBiArr);
            
            const avgConcPb = calcMean(concPbArr);
            const rsdPb = calcRSD(concPbArr);
            
            // 3. ä½¿ç”¨å¹³å‡æµ“åº¦è®¡ç®—æœ€ç»ˆè´¨é‡åˆ†æ•°
            // m_total = C_avg * V_total * M_atomic
            // percent = m_total / m_sample * 100
            const totalMolesBi = avgConcBi * (vTotal / 1000); // mol
            const calcTotalMassBi = totalMolesBi * ATOMIC_WEIGHT_Bi; // g
            const finalPercentBi = (calcTotalMassBi / mSample) * 100;
            
            const totalMolesPb = avgConcPb * (vTotal / 1000); // mol
            const calcTotalMassPb = totalMolesPb * ATOMIC_WEIGHT_Pb; // g
            const finalPercentPb = (calcTotalMassPb / mSample) * 100;
            
            // 4. å®éªŒå‡†ç¡®æ€§åˆ¤å®š (è®¡ç®—æ€»è´¨é‡æ˜¯å¦è¶…è¿‡ç§°é‡è´¨é‡)
            const calcTotalMassSum = calcTotalMassBi + calcTotalMassPb;
            const isAbnormal = calcTotalMassSum > mSample;

            // æ¸²æŸ“
            const stats = { 
                avgConcBi, rsdBi, finalPercentBi, 
                avgConcPb, rsdPb, finalPercentPb,
                isAbnormal
            };
            
            renderTable(results, cEDTA, mSample, stats);
            updateStatsView(stats);
            
            // å¤„ç†å¼‚å¸¸è­¦å‘Š
            const alertBox = document.getElementById('accuracy-alert');
            const resultCards = [document.getElementById('card-bi'), document.getElementById('card-pb')];
            
            if (isAbnormal) {
                alertBox.classList.remove('hidden');
                document.getElementById('final-percent-bi').classList.add('data-warning');
                document.getElementById('final-percent-pb').classList.add('data-warning');
                showToast("è­¦å‘Šï¼šè®¡ç®—è´¨é‡è¶…å‡ºè¯•æ ·æ€»é‡ï¼", true);
            } else {
                alertBox.classList.add('hidden');
                document.getElementById('final-percent-bi').classList.remove('data-warning');
                document.getElementById('final-percent-pb').classList.remove('data-warning');
            }

            document.getElementById('result-section').classList.remove('hidden');

            // å†å²è®°å½•
            const currentHash = JSON.stringify(rawInputs);
            if (currentHash === lastSubmissionHash) {
                showToast("è®¡ç®—ç»“æœå·²åˆ·æ–° (æ•°æ®æœªå˜)");
            } else {
                const record = {
                    date: new Date().toISOString(),
                    cEDTA, mSample, vTotal, vPipette, results, stats
                };
                historyData.unshift(record);
                localStorage.setItem(HISTORY_KEY, JSON.stringify(historyData));
                renderHistory();
                
                lastSubmissionHash = currentHash;
                showToast("è®¡ç®—å®Œæˆï¼");
            }
        }
        
        function updateStatsView(stats) {
            document.getElementById('avg-conc-bi').textContent = roundToSigFigs(stats.avgConcBi, 4) + " mol/L";
            document.getElementById('rsd-bi').textContent = stats.rsdBi.toFixed(2) + " %";
            document.getElementById('final-percent-bi').textContent = roundToSigFigs(stats.finalPercentBi, 4) + " %";
            
            document.getElementById('avg-conc-pb').textContent = roundToSigFigs(stats.avgConcPb, 4) + " mol/L";
            document.getElementById('rsd-pb').textContent = stats.rsdPb.toFixed(2) + " %";
            document.getElementById('final-percent-pb').textContent = roundToSigFigs(stats.finalPercentPb, 4) + " %";
        }

        function generateTableHtml(results, cEDTA, mSample, stats) {
            const getVal = (idx, key, fixed) => {
                if (!results[idx]) return '';
                return results[idx][key].toFixed(fixed);
            };

            const getSigVal = (idx, key, sigFigs) => {
                 if (!results[idx]) return '';
                 return roundToSigFigs(results[idx][key], sigFigs);
            }

            const rows = [
                { label: `è¯•æ ·æ€»è´¨é‡ m (g)`, val: () => parseFloat(mSample).toFixed(4) },
                { label: `åˆè¯»æ•° V<sub>åˆ</sub> (mL)`, key: 'vStart', fix: 2 },
                { label: `ç¬¬ä¸€ç»ˆç‚¹ V<sub>1</sub> (mL)`, key: 'vEnd1', fix: 2 },
                { label: `ç¬¬äºŒç»ˆç‚¹ V<sub>2</sub> (mL)`, key: 'vEnd2', fix: 2 },
                { label: `V<sub>Bi</sub> (mL)`, key: 'V_Bi', fix: 2 },
                { label: `V<sub>Pb</sub> (mL)`, key: 'V_Pb', fix: 2 },
                { label: `EDTA æµ“åº¦ (mol/L)`, val: () => roundToSigFigs(parseFloat(cEDTA), 4) },
                { label: `C (BiÂ³âº) (mol/L)`, key: 'concBi', sig: 4, color: true },
                { label: `C (PbÂ²âº) (mol/L)`, key: 'concPb', sig: 4, color: true },
            ];

            let html = `<table class="result-table bg-surface w-full"><thead><tr><th style="width: 30%">æµ‹å®šæ¬¡æ•°</th><th style="width: 23%">1</th><th style="width: 23%">2</th><th style="width: 23%">3</th></tr></thead><tbody>`;
            
            // å¸¸è§„è¡Œ
            rows.forEach(row => {
                html += `<tr><td class="text-left font-medium">${row.label}</td>`;
                for(let i=0; i<3; i++) {
                    let text = '';
                    if (row.val) {
                        text = row.val();
                    } else if (row.sig) {
                        text = getSigVal(i, row.key, row.sig);
                    } else {
                        text = getVal(i, row.key, row.fix);
                    }
                    
                    let style = 'tabular-nums';
                    if (row.bold) style += ' font-bold text-[var(--accent-color)]';
                    else if (row.color) style += ' text-[var(--accent-color)] font-medium';
                    
                    html += `<td class="${style}">${text}</td>`;
                }
                html += `</tr>`;
            });

            // å¦‚æœåŒ…å« stats å¯¹è±¡ï¼Œè¿½åŠ åˆå¹¶å•å…ƒæ ¼çš„ç»Ÿè®¡è¡Œ
            if (stats) {
                // Bi ç»Ÿè®¡
                html += `<tr class="bg-[var(--accent-bg)]/20"><td class="text-left font-bold text-primary">Bi å¹³å‡æµ“åº¦</td><td colspan="3" class="font-bold tabular-nums text-[var(--accent-color)]">${roundToSigFigs(stats.avgConcBi, 4)} mol/L</td></tr>`;
                html += `<tr><td class="text-left font-bold text-primary">Bi RSD</td><td colspan="3" class="tabular-nums">${stats.rsdBi.toFixed(2)} %</td></tr>`;
                html += `<tr class="border-b-2 border-[var(--border-light)]"><td class="text-left font-bold text-primary">Bi è´¨é‡åˆ†æ•°</td><td colspan="3" class="font-bold tabular-nums text-[var(--accent-color)] text-lg">${roundToSigFigs(stats.finalPercentBi, 4)} %</td></tr>`;
                
                // Pb ç»Ÿè®¡
                html += `<tr class="bg-[var(--accent-bg)]/20"><td class="text-left font-bold text-primary">Pb å¹³å‡æµ“åº¦</td><td colspan="3" class="font-bold tabular-nums text-[var(--accent-color)]">${roundToSigFigs(stats.avgConcPb, 4)} mol/L</td></tr>`;
                html += `<tr><td class="text-left font-bold text-primary">Pb RSD</td><td colspan="3" class="tabular-nums">${stats.rsdPb.toFixed(2)} %</td></tr>`;
                html += `<tr><td class="text-left font-bold text-primary">Pb è´¨é‡åˆ†æ•°</td><td colspan="3" class="font-bold tabular-nums text-[var(--accent-color)] text-lg">${roundToSigFigs(stats.finalPercentPb, 4)} %</td></tr>`;
            }

            html += `</tbody></table>`;
            return html;
        }

        function renderTable(results, cEDTA, mSample, stats) {
            const tableHtml = generateTableHtml(results, cEDTA, mSample, stats);
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = tableHtml;
            document.getElementById('result-table-body').innerHTML = tempDiv.querySelector('tbody').innerHTML;
        }

        function renderHistory() {
            const container = document.getElementById('history-container');
            container.innerHTML = '';
            
            if (historyData.length === 0) {
                container.innerHTML = '<p class="text-center text-sm text-secondary">æš‚æ— å†å²è®°å½•</p>';
                return;
            }

            historyData.forEach((rec, idx) => {
                const date = new Date(rec.date).toLocaleString('zh-CN');
                // å†å²è®°å½•ä¹Ÿéœ€è¦æ˜¾ç¤ºå®Œæ•´çš„åˆå¹¶ç»Ÿè®¡è¡Œï¼Œä¼ å…¥ rec.stats
                const tableHtml = generateTableHtml(rec.results, rec.cEDTA, rec.mSample, rec.stats);
                const warnClass = rec.stats.isAbnormal ? 'border-red-400 border-l-4' : '';
                
                const html = `
                <div class="bg-surface border border-[var(--border-light)] rounded-lg shadow-sm text-sm overflow-hidden transition-all duration-300 ${warnClass}">
                    <div class="history-summary-row p-4 flex justify-between items-center" onclick="toggleHistory(${idx})">
                        <div class="flex-1">
                            <div class="font-bold text-[var(--accent-color)] mb-1">${date} ${rec.stats.isAbnormal ? '<span class="text-red-500 text-xs ml-2">(æ•°æ®å¼‚å¸¸)</span>' : ''}</div>
                            <div class="text-xs text-secondary flex gap-4">
                                <span>Bi: <b class="tabular-nums">${roundToSigFigs(rec.stats.finalPercentBi, 4)}%</b></span>
                                <span>Pb: <b class="tabular-nums">${roundToSigFigs(rec.stats.finalPercentPb, 4)}%</b></span>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <button onclick="event.stopPropagation(); deleteHistory(${idx})" class="text-[var(--color-error)] text-xs hover:underline">åˆ é™¤</button>
                            <svg id="arrow-${idx}" class="w-5 h-5 text-secondary expand-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                    </div>
                    
                    <div id="detail-${idx}" class="history-details bg-[var(--bg-canvas)] px-2 sm:px-4">
                        <div class="py-4 overflow-x-auto">
                           ${tableHtml}
                        </div>
                    </div>
                </div>`;
                container.innerHTML += html;
            });
        }
        
        function toggleHistory(idx) {
            const detail = document.getElementById(`detail-${idx}`);
            const arrow = document.getElementById(`arrow-${idx}`);
            if (detail.classList.contains('open')) {
                detail.classList.remove('open');
                arrow.classList.remove('open');
            } else {
                detail.classList.add('open');
                arrow.classList.add('open');
            }
        }
        
        function deleteHistory(index) {
            historyData.splice(index, 1);
            localStorage.setItem(HISTORY_KEY, JSON.stringify(historyData));
            renderHistory();
        }

        function clearHistory() {
            if(confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰è®°å½•å—ï¼Ÿ')) {
                historyData = [];
                localStorage.removeItem(HISTORY_KEY);
                renderHistory();
            }
        }
        
        function exportCSV() {
            if (historyData.length === 0) return showToast("æ— æ•°æ®å¯å¯¼å‡º", true);
            
            let csv = "æ—¶é—´,æµ‹å®šæ¬¡æ•°,V_åˆ(mL),V_1(mL),V_2(mL),V_Bi(mL),V_Pb(mL),C_Bi(mol/L),C_Pb(mol/L),Biå«é‡(%),Pbå«é‡(%),æ•°æ®å¼‚å¸¸\n";
            
            historyData.forEach(rec => {
                const time = new Date(rec.date).toLocaleString().replace(',', ' ');
                const isAbnormal = rec.stats.isAbnormal ? "æ˜¯" : "å¦";
                const biPct = roundToSigFigs(rec.stats.finalPercentBi, 4);
                const pbPct = roundToSigFigs(rec.stats.finalPercentPb, 4);

                rec.results.forEach((r, i) => {
                    if(!r) return;
                    const cBi = roundToSigFigs(r.concBi, 4);
                    const cPb = roundToSigFigs(r.concPb, 4);
                    csv += `${time},${i+1},${r.vStart},${r.vEnd1},${r.vEnd2},${r.V_Bi.toFixed(2)},${r.V_Pb.toFixed(2)},${cBi},${cPb},${biPct},${pbPct},${isAbnormal}\n`;
                });
            });
            
            const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `é“…é“‹åˆé‡‘å«é‡åˆ†æ_${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- UI & åŠ¨æ•ˆé€»è¾‘ ---
        
        function showToast(msg, isError = false) {
            const toast = document.getElementById('toast-notification');
            toast.querySelector('span').innerText = msg;
            const icon = toast.querySelector('svg');
            
            if (isError) {
                icon.classList.remove('text-green-400');
                icon.classList.add('text-red-400');
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />';
            } else {
                icon.classList.remove('text-red-400');
                icon.classList.add('text-green-400'); 
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />';
            }
            
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }
        
        function copyText(el) {
            const text = el.innerText;
            navigator.clipboard.writeText(text).then(() => showToast("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿"));
        }

        // ä¸»é¢˜åˆ‡æ¢ - å¢åŠ äº† Amber (äº®é»„è‰²/æ©™è‰²)
        const colorPalettes = {
            'purple': { 
                light: { '--accent-color': '#7c3aed', '--accent-color-dark': '#6d28d9', '--accent-bg': '#f5f3ff' }, 
                dark: { '--accent-color': '#a78bfa', '--accent-color-dark': '#8b5cf6', '--accent-bg': '#2e1065' } 
            },
            'emerald': { 
                light: { '--accent-color': '#059669', '--accent-color-dark': '#047857', '--accent-bg': '#ecfdf5' }, 
                dark: { '--accent-color': '#34d399', '--accent-color-dark': '#10b981', '--accent-bg': '#102d24' } 
            },
            'blue': { 
                light: { '--accent-color': '#2563eb', '--accent-color-dark': '#1d4ed8', '--accent-bg': '#eff6ff' }, 
                dark: { '--accent-color': '#60a5fa', '--accent-color-dark': '#3b82f6', '--accent-bg': '#172554' } 
            },
            'amber': { 
                light: { '--accent-color': '#f59e0b', '--accent-color-dark': '#d97706', '--accent-bg': '#fffbeb' }, 
                // ä¿®æ”¹ï¼šæ·±è‰²æ¨¡å¼ä¸‹ä½¿ç”¨æ·±æ£•è‰²èƒŒæ™¯(#2d2110)è€Œéæ·±çº¢è‰²(#451a03)ï¼›æŒ‰é’®ä½¿ç”¨æ›´æ·±çš„æ©™è‰²(#f59e0b)è€Œéäº®é»„(#fbbf24)
                dark: { '--accent-color': '#f59e0b', '--accent-color-dark': '#b45309', '--accent-bg': '#2d2110' } 
            }
        };
        let currentAccent = 'purple';
        let currentMode = 'light';
        let isAnim = true;

        function setAccent(name) {
            currentAccent = name;
            applyTheme();
            document.querySelectorAll('.theme-button').forEach(b => b.classList.remove('active'));
            document.querySelector(`button[onclick="setAccent('${name}')"]`).classList.add('active');
        }
        
        function toggleMode() {
            currentMode = currentMode === 'light' ? 'dark' : 'light';
            document.getElementById('mode-text').innerText = currentMode === 'light' ? 'æµ…è‰²' : 'æ·±è‰²';
            document.body.setAttribute('data-mode', currentMode);
            applyTheme();
        }
        
        function applyTheme() {
            const p = colorPalettes[currentAccent][currentMode];
            const root = document.documentElement;
            root.style.setProperty('--accent-color', p['--accent-color']);
            root.style.setProperty('--accent-color-dark', p['--accent-color-dark']);
            root.style.setProperty('--accent-bg', p['--accent-bg']);
            const hex = p['--accent-color'].replace('#', '');
            const r = parseInt(hex.substring(0,2), 16);
            const g = parseInt(hex.substring(2,4), 16);
            const b = parseInt(hex.substring(4,6), 16);
            root.style.setProperty('--accent-color-rgb', `${r}, ${g}, ${b}`);
        }

        // åŠ¨æ•ˆ
        function toggleAnimation() {
            isAnim = !isAnim;
            document.getElementById('animation-text').innerText = isAnim ? 'åŠ¨æ•ˆå¼€' : 'åŠ¨æ•ˆå…³';
            document.documentElement.style.setProperty('--animation-state', isAnim ? 'running' : 'paused');
            document.getElementById('floating-container').style.opacity = isAnim ? '1' : '0';
        }

        function createFloatingElements() { 
            const container = document.getElementById('floating-container');
            container.innerHTML = ''; 
            const symbols = ['PbÂ²âº', 'BiÂ³âº', 'Yâ´â»', 'EDTA', 'pHâ‰ˆ1', 'pHâ‰ˆ5', 'HNOâ‚ƒ', 'BiYâ»', 'PbYÂ²â»']; 
            for (let i = 0; i < 40; i++) {
                const el = document.createElement('div');
                el.classList.add('floating-element');
                el.innerText = symbols[Math.floor(Math.random() * symbols.length)];
                el.style.setProperty('--random-x', Math.random() * 100 + 'vw');
                el.style.fontSize = (Math.random() * 1.5 + 1) + 'rem';
                el.style.animationDuration = (Math.random() * 15 + 15) + 's';
                el.style.animationDelay = (Math.random() * -20) + 's';
                container.appendChild(el);
            }
        }

        window.onload = function() {
            initTrials();
            renderHistory();
            createFloatingElements();
            applyTheme(); 
        }

    </script>
</body>
</html>