<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ°§åŒ–é’™ä¸­é’™å«é‡çš„æµ‹å®š (é«˜é”°é…¸é’¾æ»´å®šæ³•)</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* åŸºç¡€æ ·å¼è®¾ç½® */
        :root {
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            /* é»˜è®¤ç´«è‰²è°ƒï¼Œå‘¼åº”é«˜é”°é…¸é’¾ */
            --bg-canvas: #faf5ff; 
            --bg-surface: #ffffff;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --accent-color: #7c3aed; /* é«˜é”°é…¸é’¾ç´« */
            --accent-color-dark: #6d28d9;
            --accent-bg: #f3e8ff;
            --color-error: #ef4444;
            --color-warning: #f59e0b;
            --border-light: #e9d5ff;
            --button-text: #ffffff;
            --accent-color-rgb: 124, 58, 237;
            --animation-state: running;
        }

        body {
            background-color: var(--bg-canvas);
            transition: background-color 0.5s ease, color 0.5s ease;
            background-image: radial-gradient(
                circle at 50% 10%, 
                rgba(var(--accent-color-rgb), 0.1) 0%, 
                var(--bg-canvas) 60%
            );
            background-size: cover;
            background-attachment: fixed;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 1.5rem 0;
            box-sizing: border-box;
            overflow-x: hidden;
            position: relative;
        }
        
        .main-calculator-card {
            position: relative;
            z-index: 20;
            width: 90%;
            max-width: 900px; /* ç¨å¾®åŠ å®½ä»¥å®¹çº³3ä¸ªå¡ç‰‡ */
            margin: 0;
            margin-bottom: 4rem; 
        }

        /* --- åŠ¨ç”»èƒŒæ™¯ --- */
        #floating-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            overflow: hidden;
            pointer-events: none; 
            z-index: 1;
        }
        
        .floating-element {
            position: absolute;
            top: 0;
            left: var(--random-x);
            color: var(--accent-color);
            opacity: 0.12;
            font-weight: 700;
            line-height: 1;
            white-space: nowrap;
            animation: waterfall linear infinite;
            animation-play-state: var(--animation-state);
            user-select: none;
            font-family: 'Times New Roman', serif;
            will-change: transform;
            transform: translate3d(0, -100vh, 0); 
        }

        @keyframes waterfall {
            0% { transform: translate3d(0, -100vh, 0); }
            100% { transform: translate3d(0, 150vh, 0); }
        }
        
        /* --- æ·±è‰²æ¨¡å¼ --- */
        body[data-mode="dark"] {
            --bg-canvas: #0f172a;           
            --bg-surface: #1e293b;          
            --text-primary: #f8fafc;        
            --text-secondary: #94a3b8;      
            --color-error: #f87171;         
            --border-light: #334155;        
            --button-text: #0f172a;         
             background-image: radial-gradient(
                circle at 50% 10%, 
                rgba(var(--accent-color-rgb), 0.2) 0%, 
                var(--bg-canvas) 50%
            );
        }

        /* é€šç”¨ç±» */
        .bg-surface { background-color: var(--bg-surface); }
        .text-primary { color: var(--text-primary); }
        .text-secondary { color: var(--text-secondary); }
        .border-light { border-color: var(--border-light); }
        .accent-bg { background-color: var(--accent-bg); }
        
        /* è¾“å…¥æ¡†æ ·å¼ */
        .input-field {
            border-color: var(--border-light);
            color: var(--text-primary);
            background-color: var(--bg-surface);
            transition: border-color 0.3s, background-color 0.5s;
        }
        .input-field:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(var(--accent-color-rgb), 0.3);
            outline: none;
        }
        .input-disabled {
            background-color: rgba(0,0,0,0.05);
            cursor: not-allowed;
        }

        .theme-button { 
            position: relative; 
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .theme-button:hover {
            transform: scale(1.1);
        }
        .theme-button.active {
            transform: scale(1.15);
            box-shadow: 0 0 0 2px var(--bg-surface), 0 0 0 4px var(--text-primary);
        }

        /* è¡¨æ ¼æ ·å¼ */
        .result-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        .result-table th, .result-table td {
            padding: 10px 8px;
            text-align: center;
            border: 1px solid var(--border-light);
            color: var(--text-primary);
        }
        .result-table th {
            background-color: var(--accent-bg); 
            color: var(--text-primary);
            font-weight: 700;
        }
        .result-table tr:hover td {
            background-color: rgba(var(--accent-color-rgb), 0.05);
        }
        /* å­æ ‡é¢˜è¡Œæ ·å¼ */
        .table-subheader {
            background-color: rgba(var(--accent-color-rgb), 0.1);
            font-weight: bold;
            color: var(--text-secondary);
            font-size: 0.85rem;
            text-align: left;
            padding-left: 1rem;
        }

        /* æŒ‰é’®åŠ¨æ•ˆ */
        .calculate-button {
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--accent-color-dark) 100%);
            color: var(--button-text); 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            font-weight: 700;
            border: none;
            position: relative;
            overflow: hidden;
        }
        .calculate-button::after {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0.15), transparent);
            pointer-events: none;
        }
        .calculate-button:hover {
            filter: brightness(1.1); 
            box-shadow: 0 8px 20px -4px rgba(var(--accent-color-rgb), 0.5); 
            transform: translateY(-2px); 
        }
        .calculate-button:active {
            filter: brightness(0.95); 
            transform: scale(0.98); 
            box-shadow: 0 4px 10px -2px rgba(var(--accent-color-rgb), 0.3);
        }
        .active-scale-98:active { transform: scale(0.98); }

        .main-title { font-size: 1.8rem; font-weight: 900; letter-spacing: -0.05em; line-height: 1.2; }
        .section-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 0.5rem; color: var(--text-primary); }

        /* Toast æç¤ºæ ·å¼ */
        #toast-notification {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background-color: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(4px);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-size: 0.9rem;
            font-weight: 500;
            z-index: 100;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            pointer-events: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        #toast-notification.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        
        .copyable-result { cursor: pointer; border-bottom: 1px dashed var(--accent-color); }
        .copyable-result:active { opacity: 0.7; }

        /* é’ˆå¯¹å°å±å¹•ä¼˜åŒ–è¡¨æ ¼ */
        @media (max-width: 640px) {
            .result-table { display: block; overflow-x: auto; white-space: nowrap; }
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .dot-indicator {
            width: 8px; height: 8px; border-radius: 50%;
            background-color: var(--border-light);
            transition: all 0.3s ease;
        }
        .dot-indicator.active {
            background-color: var(--accent-color);
            transform: scale(1.2); width: 20px; border-radius: 4px;
        }

        @keyframes swipe-hint {
            0%, 100% { transform: translateX(0); opacity: 0.5; }
            50% { transform: translateX(10px); opacity: 1; }
        }
        .swipe-hint-icon { animation: swipe-hint 1.5s infinite; }

        /* å†å²è®°å½•å±•å¼€æ ·å¼ */
        .history-details {
            max-height: 0; overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out; opacity: 0;
        }
        .history-details.open { max-height: 1000px; opacity: 1; margin-top: 1rem; }
        .history-summary-row { cursor: pointer; transition: background-color 0.2s; }
        .history-summary-row:hover { background-color: rgba(var(--accent-color-rgb), 0.05); }
        .expand-icon { transition: transform 0.3s; }
        .expand-icon.open { transform: rotate(180deg); }
        
        .reaction-card {
            background-color: var(--bg-canvas);
            border-left: 4px solid var(--accent-color);
        }
        .formula { font-family: 'Times New Roman', serif; }

        /* è¯•å‰‚å¡ç‰‡ç‰¹æ®Šæ ·å¼ */
        .trial-card.blank-card {
            border-top: 4px solid #94a3b8; /* ç°è‰²åŒºåˆ†ç©ºç™½å®éªŒ */
        }
        .trial-card.sample-card {
            border-top: 4px solid var(--accent-color);
        }
        
        /* éšè—å…ƒç´ çš„ç±» */
        .hidden-card {
            display: none !important;
        }
    </style>
</head>
<body data-mode="light">
    
    <div id="floating-container"></div>
    
    <!-- Toast Notification -->
    <div id="toast-notification">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
        <span>å†…å®¹å·²å¤åˆ¶</span>
    </div>

    <div class="main-calculator-card bg-surface shadow-2xl rounded-2xl p-6 sm:p-8 space-y-6 border-t-8 border-[var(--accent-color)] transition-colors duration-500">

        <!-- é¡¶éƒ¨æ§åˆ¶åŒº -->
        <div class="flex flex-col space-y-4 pb-4 border-b border-[var(--border-light)] transition-colors duration-500">
            <div class="flex justify-between items-center">
                <div class="flex flex-wrap items-center space-x-3">
                    <span class="text-sm font-medium text-[var(--text-secondary)]">ç•Œé¢æ¨¡å¼:</span>
                    <button onclick="toggleMode()" class="px-3 py-1 bg-[var(--accent-bg)] rounded-full text-[var(--text-primary)] border border-[var(--border-light)] text-xs font-bold active-scale-98">
                        <span id="mode-text">æµ…è‰²</span>
                    </button>
                    <button onclick="toggleAnimation()" class="px-3 py-1 bg-[var(--accent-bg)] rounded-full text-[var(--text-primary)] border border-[var(--border-light)] text-xs font-bold active-scale-98">
                        <span id="animation-text">åŠ¨æ•ˆå¼€</span>
                    </button>
                </div>
                <!-- ä¸»é¢˜è‰²é€‰æ‹© -->
                <div class="flex items-center space-x-2">
                    <button onclick="setAccent('purple')" class="theme-button w-6 h-6 rounded-full active" style="background: #7c3aed;" title="é«˜é”°é…¸é’¾ç´«"></button>
                    <button onclick="setAccent('blue')" class="theme-button w-6 h-6 rounded-full" style="background: #0284c7;" title="é’™è¯•å‰‚è“"></button>
                    <button onclick="setAccent('emerald')" class="theme-button w-6 h-6 rounded-full" style="background: #059669;" title="è‰é…¸ç»¿"></button>
                    <button onclick="setAccent('pink')" class="theme-button w-6 h-6 rounded-full" style="background: #db2777;" title="ç»ˆç‚¹ç²‰"></button>
                </div>
            </div>
            
            <div class="text-center space-y-2">
                <h1 class="main-title text-primary">æ°§åŒ–é’™ä¸­é’™å«é‡çš„æµ‹å®š<br><span class="text-lg opacity-80 font-normal">(é«˜é”°é…¸é’¾æ°§åŒ–è¿˜åŸæ»´å®šæ³•)</span></h1>
            </div>

            <!-- åŸç†å±•å¼€æŠ˜å  -->
            <div class="border border-[var(--border-light)] rounded-lg overflow-hidden">
                <button onclick="togglePrinciple()" class="w-full px-4 py-2 bg-[var(--accent-bg)] text-left flex justify-between items-center text-sm font-bold text-[var(--accent-color)]">
                    <span>ğŸ“– å®éªŒåŸç†ä¸ååº”å¼ (å®šå®¹æ³•)</span>
                    <svg id="principle-arrow" class="w-4 h-4 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div id="principle-content" class="hidden p-4 text-sm text-[var(--text-secondary)] space-y-3 bg-[var(--bg-canvas)]">
                    <div class="space-y-1">
                        <p class="font-bold">1. è¯•æ ·åˆ¶å¤‡ (å®šå®¹):</p>
                        <p class="text-xs text-gray-500">ç§°å–è´¨é‡ m çš„è¯•æ ·ï¼Œæº¶è§£å¹¶å®šå®¹è‡³ V<sub>æ€»</sub> (å¦‚250mL)ã€‚æ¯æ¬¡ç§»å– V<sub>ç§»</sub> (å¦‚25mL) è¿›è¡Œæ»´å®šã€‚</p>
                        <p class="formula pl-4 text-xs font-bold text-[var(--accent-color)]">ç¨€é‡Šå€æ•° f = V<sub>æ€»</sub> / V<sub>ç§»</sub></p>
                    </div>
                    <div class="space-y-1">
                        <p class="font-bold">2. æ²‰æ·€ä¸æº¶è§£:</p>
                        <p class="formula pl-4">CaÂ²âº + Câ‚‚Oâ‚„Â²â» â‡Œ CaCâ‚‚Oâ‚„â†“</p>
                        <p class="formula pl-4">CaCâ‚‚Oâ‚„ + Hâ‚‚SOâ‚„ â‡Œ CaSOâ‚„ + Hâ‚‚Câ‚‚Oâ‚„</p>
                    </div>
                    <div class="space-y-1">
                        <p class="font-bold">3. æ»´å®šä¸è®¡ç®—:</p>
                        <p class="formula pl-4">5n(CaÂ²âº) = 2n(MnOâ‚„â»)</p>
                        <p class="formula pl-4 text-xs">n(Ca)<sub>æ€»é‡</sub> = 2.5 Ã— n(KMnOâ‚„) Ã— f</p>
                        <p class="formula pl-4 text-xs">æ³¨æ„: c(KMnOâ‚„) éœ€ä¿ç•™4ä½æœ‰æ•ˆæ•°å­— (å³å°æ•°ç‚¹å5ä½, å¦‚0.02000)</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å…¨å±€å‚æ•°è®¾ç½® -->
        <div class="bg-[var(--accent-bg)] p-4 rounded-lg border border-[var(--border-light)] transition-colors duration-500">
            <h2 class="section-title">ğŸ§ª å®éªŒå…¬å…±å‚æ•°</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <div>
                    <label class="block text-xs font-bold text-primary mb-1">c(KMnOâ‚„) (mol/L)</label>
                    <input type="number" id="c-std" min="0" oninput="if(value<0)value=0" placeholder="0.02000" class="w-full rounded-lg p-2 border input-field tabular-nums" onchange="formatInputSigFigs(this, 5)">
                    <span class="text-[10px] text-gray-400">éœ€ä¿ç•™5ä½å°æ•°ä»¥æ»¡è¶³4ä½æœ‰æ•ˆæ•°å­—</span>
                </div>
                <div>
                    <label class="block text-xs font-bold text-primary mb-1">M(Ca) (g/mol)</label>
                    <input type="number" id="m-molar" value="40.08" class="w-full rounded-lg p-2 border input-field tabular-nums opacity-90" onchange="formatInputSigFigs(this, 2)">
                </div>
                 <div>
                    <label class="block text-xs font-bold text-primary mb-1">å®šå®¹ä½“ç§¯ V<sub>æ€»</sub> (mL)</label>
                    <input type="number" id="v-total-vol" value="250.00" class="w-full rounded-lg p-2 border input-field tabular-nums" onchange="formatInputSigFigs(this, 2)">
                </div>
                <div>
                    <label class="block text-xs font-bold text-primary mb-1">ç§»å–ä½“ç§¯ V<sub>ç§»</sub> (mL)</label>
                    <input type="number" id="v-aliquot" value="25.00" class="w-full rounded-lg p-2 border input-field tabular-nums" onchange="formatInputSigFigs(this, 2)">
                </div>
            </div>
        </div>

        <!-- æ•°æ®è¾“å…¥åŒº -->
        <div class="space-y-4">
            
            <!-- æ­¥éª¤1: è¯•æ ·ç§°é‡ (ç‹¬ç«‹å¡ç‰‡) -->
            <div class="p-4 rounded-lg border border-[var(--border-light)] bg-surface shadow-sm relative">
                <div class="flex justify-between items-center mb-3">
                     <h2 class="section-title flex items-center gap-2 mb-0">
                        âš–ï¸ æ­¥éª¤ 1: è¯•æ ·é…åˆ¶ä¸ç§°é‡
                    </h2>
                     <span class="text-xs text-[var(--text-secondary)]">ç§°å–è¯•æ ·æº¶è§£å¹¶å®šå®¹</span>
                </div>
               
                <div class="bg-[var(--bg-canvas)] p-3 rounded border border-[var(--border-light)]">
                    <p class="text-xs font-bold text-[var(--accent-color)] mb-2">æ°§åŒ–é’™è¯•æ ·æ€»è´¨é‡ (å®šå®¹å‰)</p>
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-4 items-end">
                        <div>
                            <label class="block text-[10px] text-secondary">ç§°é‡ç“¶+æ · mâ‚ (g)</label>
                            <input type="number" id="m1-total" oninput="liveCalcTotalMass()" step="0.0001" class="w-full rounded p-2 border input-field text-sm tabular-nums" placeholder="1.5000">
                        </div>
                        <div>
                            <label class="block text-[10px] text-secondary">ç§°é‡ç“¶/ä½™æ · mâ‚‚ (g)</label>
                            <input type="number" id="m2-total" oninput="liveCalcTotalMass()" step="0.0001" class="w-full rounded p-2 border input-field text-sm tabular-nums" placeholder="0.0000">
                        </div>
                        <div class="flex flex-col justify-end">
                             <div class="flex justify-between text-sm border-t-2 border-[var(--accent-color)] pt-2">
                                <span class="text-secondary font-bold">è¯•æ ·æ€»é‡ m:</span>
                                <span id="disp-m-total" class="font-bold text-[var(--accent-color)] tabular-nums">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ­¥éª¤2: æ»´å®šæ•°æ® -->
            <div class="flex flex-col gap-2 pt-2">
                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-end">
                    <h2 class="section-title flex items-center gap-2 mb-0">
                        ğŸ’§ æ­¥éª¤ 2: ç§»å–æ»´å®šæ•°æ®å½•å…¥
                        <span class="text-xs font-normal bg-gray-200 text-gray-700 px-2 py-0.5 rounded-full">ç©ºç™½ + å¹³è¡Œæ ·</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-[var(--accent-color)] lg:hidden swipe-hint-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7" />
                        </svg>
                    </h2>
                    <!-- ç¬¬äºŒç»„å¼€å…³ -->
                    <div class="flex items-center space-x-2 bg-surface p-2 rounded-lg border border-[var(--border-light)] mt-2 sm:mt-0 shadow-sm">
                        <input type="checkbox" id="use-group-2" class="w-4 h-4 text-[var(--accent-color)] rounded border-gray-300 focus:ring-[var(--accent-color)]" onchange="toggleGroup2()">
                        <label for="use-group-2" class="text-sm font-bold text-primary cursor-pointer select-none">å¯ç”¨ç¬¬ 2 ç»„å¹³è¡Œå®éªŒ</label>
                    </div>
                </div>
            </div>
            
            <div id="trials-container" class="flex lg:grid lg:grid-cols-3 gap-4 overflow-x-auto lg:overflow-visible snap-x snap-mandatory hide-scrollbar pb-2">
                <!-- å¡ç‰‡1: ç©ºç™½å®éªŒ -->
                <div class="w-full flex-shrink-0 snap-center lg:w-auto p-4 rounded-lg border bg-surface shadow-sm relative trial-card blank-card transition-all duration-300">
                    <div class="absolute top-2 right-2 text-xs font-bold text-gray-300 text-4xl select-none">B</div>
                    <h3 class="font-bold text-gray-600 mb-3 text-sm flex items-center">
                        <span class="w-2 h-2 rounded-full bg-gray-400 mr-2"></span>
                        ç©ºç™½å¯¹ç…§å®éªŒ
                    </h3>
                    
                    <div class="space-y-3">
                        <div class="bg-gray-50 p-2 rounded border border-gray-200 opacity-60">
                            <div class="text-xs text-gray-400 italic text-center py-2">
                                ä¸åŠ è¯•æ ·æº¶æ¶²<br>æŒ‰åŒæ ·æ­¥éª¤æ»´å®š
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs text-secondary mb-1">ç©ºç™½ V<sub>åˆ</sub> (mL)</label>
                            <input type="number" id="v-start-0" min="0" oninput="liveCalcVol(0)" step="0.01" class="w-full rounded p-2 border input-field text-sm tabular-nums" placeholder="0.00">
                        </div>
                        <div>
                            <label class="block text-xs text-secondary mb-1">ç©ºç™½ V<sub>ç»ˆ</sub> (mL)</label>
                            <input type="number" id="v-end-0" min="0" oninput="liveCalcVol(0)" step="0.01" class="w-full rounded p-2 border input-field text-sm tabular-nums" placeholder="0.05">
                        </div>
                        
                        <div class="pt-2 border-t border-dashed border-[var(--border-light)] text-xs flex justify-between items-center">
                             <span class="text-secondary font-bold">ç©ºç™½æ¶ˆè€— Vâ‚€ (mL):</span> 
                             <span id="disp-v-0" class="tabular-nums font-bold text-gray-600 text-sm">-</span>
                        </div>
                    </div>
                </div>

                <!-- å¡ç‰‡2: å¹³è¡Œæ ·1 -->
                <div class="w-full flex-shrink-0 snap-center lg:w-auto p-4 rounded-lg border bg-surface shadow-sm relative trial-card sample-card transition-all duration-300">
                    <div class="absolute top-2 right-2 text-xs font-bold text-[var(--accent-color)] opacity-20 text-4xl select-none">1</div>
                    <h3 class="font-bold text-primary mb-3 text-sm flex items-center">
                        <span class="w-2 h-2 rounded-full bg-[var(--accent-color)] mr-2"></span>
                        ç¬¬ 1 ç»„å¹³è¡Œå®éªŒ
                    </h3>
                    <div class="text-xs text-[var(--text-secondary)] mb-3 bg-[var(--accent-bg)] p-1 rounded inline-block">
                        ç§»å– V<sub>ç§»</sub> æº¶æ¶²è¿›è¡Œæ»´å®š
                    </div>
                    
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs text-secondary mb-1">æ»´å®šç®¡åˆè¯»æ•° V<sub>åˆ</sub> (mL)</label>
                            <input type="number" id="v-start-1" min="0" oninput="liveCalcVol(1)" step="0.01" class="w-full rounded p-2 border input-field text-sm tabular-nums" placeholder="0.00">
                        </div>
                        <div>
                            <label class="block text-xs text-secondary mb-1">æ»´å®šç®¡ç»ˆè¯»æ•° V<sub>ç»ˆ</sub> (mL)</label>
                            <input type="number" id="v-end-1" min="0" oninput="liveCalcVol(1)" step="0.01" class="w-full rounded p-2 border input-field text-sm tabular-nums" placeholder="20.00">
                        </div>
                        
                        <div class="pt-2 border-t border-dashed border-[var(--border-light)] text-xs flex justify-between items-center">
                             <span class="text-secondary">æ€»æ¶ˆè€— Vâ‚ (mL):</span> 
                             <span id="disp-v-1" class="tabular-nums font-bold text-[var(--accent-color)] text-sm">-</span>
                        </div>
                    </div>
                </div>

                <!-- å¡ç‰‡3: å¹³è¡Œæ ·2 (é»˜è®¤éšè—) -->
                <div id="trial-card-2" class="hidden-card w-full flex-shrink-0 snap-center lg:w-auto p-4 rounded-lg border bg-surface shadow-sm relative trial-card sample-card transition-all duration-300">
                    <div class="absolute top-2 right-2 text-xs font-bold text-[var(--accent-color)] opacity-20 text-4xl select-none">2</div>
                    <h3 class="font-bold text-primary mb-3 text-sm flex items-center">
                        <span class="w-2 h-2 rounded-full bg-[var(--accent-color)] mr-2"></span>
                        ç¬¬ 2 ç»„å¹³è¡Œå®éªŒ
                    </h3>
                    <div class="text-xs text-[var(--text-secondary)] mb-3 bg-[var(--accent-bg)] p-1 rounded inline-block">
                        ç§»å– V<sub>ç§»</sub> æº¶æ¶²è¿›è¡Œæ»´å®š
                    </div>
                    
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs text-secondary mb-1">æ»´å®šç®¡åˆè¯»æ•° V<sub>åˆ</sub> (mL)</label>
                            <input type="number" id="v-start-2" min="0" oninput="liveCalcVol(2)" step="0.01" class="w-full rounded p-2 border input-field text-sm tabular-nums" placeholder="0.00">
                        </div>
                        <div>
                            <label class="block text-xs text-secondary mb-1">æ»´å®šç®¡ç»ˆè¯»æ•° V<sub>ç»ˆ</sub> (mL)</label>
                            <input type="number" id="v-end-2" min="0" oninput="liveCalcVol(2)" step="0.01" class="w-full rounded p-2 border input-field text-sm tabular-nums" placeholder="20.00">
                        </div>
                        
                        <div class="pt-2 border-t border-dashed border-[var(--border-light)] text-xs flex justify-between items-center">
                             <span class="text-secondary">æ€»æ¶ˆè€— Vâ‚‚ (mL):</span> 
                             <span id="disp-v-2" class="tabular-nums font-bold text-[var(--accent-color)] text-sm">-</span>
                        </div>
                    </div>
                </div>

            </div>
            
            <div id="trial-indicators" class="flex justify-center space-x-2 lg:hidden">
                <div class="dot-indicator active" data-index="0"></div>
                <div class="dot-indicator" data-index="1"></div>
                <div class="dot-indicator hidden" id="dot-indicator-2" data-index="2"></div>
            </div>
        </div>

        <!-- è®¡ç®—æŒ‰é’® -->
        <button onclick="calculateResults()" class="w-full flex justify-center py-3 px-4 rounded-lg shadow-lg text-lg calculate-button mt-4">
            è®¡ç®—é’™å«é‡ & ç»Ÿè®¡ç»“æœ
        </button>

        <!-- ç»“æœå±•ç¤ºåŒº -->
        <div id="result-section" class="hidden space-y-6">
            
            <!-- ç»Ÿè®¡ç»“æœå¡ç‰‡ -->
            <div class="grid grid-cols-1 gap-4">
                <div class="p-5 rounded-lg border border-[var(--border-light)] bg-surface shadow-sm relative overflow-hidden" id="card-cu">
                    <div class="absolute top-0 right-0 p-2 opacity-10 text-6xl font-serif font-bold text-[var(--accent-color)]">Ca</div>
                    <h3 class="font-bold text-[var(--accent-color)] mb-4 border-b pb-2">è®¡ç®—ç»“æœæ±‡æ€» (Calcium)</h3>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-8 gap-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-secondary">å¹³å‡è´¨é‡åˆ†æ•° w(Ca):</span>
                            <span class="font-bold text-[var(--accent-color)] text-2xl tabular-nums copyable-result" onclick="copyText(this)" id="final-avg-percent">-</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-secondary">ç›¸å¯¹å¹³å‡åå·® (RAD):</span>
                            <div class="flex items-center gap-2">
                                <span class="font-bold text-primary tabular-nums text-lg" id="final-rad">-</span>
                            </div>
                        </div>
                        <div class="flex justify-between items-center border-t border-dashed pt-2 col-span-1 sm:col-span-2">
                             <span class="text-xs text-secondary">ç¨€é‡Šå€æ•° f (V<sub>æ€»</sub>/V<sub>ç§»</sub>):</span>
                             <span class="text-sm font-medium tabular-nums" id="final-dilution-factor">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è¡¨æ ¼ -->
            <div class="border-t-2 border-[var(--accent-color)] pt-6 mt-6">
                <h2 class="section-title text-center mb-4">ğŸ“ æ•°æ®è®°å½•ä¸å¤„ç†è¡¨</h2>
                <div class="overflow-x-auto rounded-lg shadow-sm border border-[var(--border-light)]">
                    <table class="result-table bg-surface">
                        <thead id="result-table-head">
                            <!-- JS å¡«å…… -->
                        </thead>
                        <tbody id="result-table-body">
                            <!-- JS å¡«å…… -->
                        </tbody>
                    </table>
                </div>
            </div>
            
        </div>

        <!-- å†å²è®°å½•æ§åˆ¶ -->
        <div class="pt-6 border-t border-[var(--border-light)]">
            <div class="flex justify-between items-center mb-4">
                <h2 class="section-title mb-0">ğŸ’¾ å†å²è®°å½•</h2>
                <div class="space-x-2">
                     <button onclick="exportCSV()" class="px-3 py-1.5 bg-[#10b981] text-white rounded text-sm font-medium hover:bg-[#059669] transition active-scale-98">
                        å¯¼å‡º CSV
                    </button>
                    <button onclick="clearHistory()" class="px-3 py-1.5 bg-[var(--color-error)] text-white rounded text-sm font-medium hover:opacity-90 transition active-scale-98">
                        æ¸…ç©º
                    </button>
                </div>
            </div>
            <div id="history-container" class="space-y-3">
                <!-- å†å²å¡ç‰‡ -->
            </div>
        </div>

    </div>

    <script>
        // --- æ ¸å¿ƒé€»è¾‘ ---
        
        // æ›´æ¢Keyä»¥å¼ºåˆ¶ä½¿ç”¨æ–°æ•°æ®ç»“æ„
        const HISTORY_KEY = 'caTitrationHistory_v5_full_record';
        let historyData = [];
        try {
            const raw = localStorage.getItem(HISTORY_KEY);
            historyData = raw ? JSON.parse(raw) : [];
        } catch(e) {
            console.error("å†å²è®°å½•è§£æå¤±è´¥", e);
            historyData = [];
        }
        
        let lastSubmissionHash = "";

        // é»˜è®¤é…ç½®
        const DEFAULT_MOLAR_MASS = 40.08;

        function formatInputSigFigs(input, sigFigs) {
            const val = parseFloat(input.value);
            if (!isNaN(val) && val !== 0) {
                input.value = val.toFixed(sigFigs);
            }
        }
        
        function toggleGroup2() {
            const checkbox = document.getElementById('use-group-2');
            const card2 = document.getElementById('trial-card-2');
            const dot2 = document.getElementById('dot-indicator-2');
            
            if (checkbox.checked) {
                card2.classList.remove('hidden-card');
                dot2.classList.remove('hidden');
                // è‡ªåŠ¨å¯¹é½æ»šåŠ¨
                setTimeout(() => {
                    card2.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                }, 100);
            } else {
                card2.classList.add('hidden-card');
                dot2.classList.add('hidden');
            }
        }

        // åˆå§‹åŒ–æ»šåŠ¨ç›‘å¬
        document.addEventListener('DOMContentLoaded', () => {
            const container = document.getElementById('trials-container');
            if(container) {
                const cards = container.querySelectorAll('.trial-card');
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const index = Array.from(cards).indexOf(entry.target);
                            updateDots(index);
                        }
                    });
                }, { root: container, threshold: 0.6 });
                cards.forEach(card => observer.observe(card));
            }
        });

        function updateDots(activeIndex) {
            const dots = document.querySelectorAll('.dot-indicator');
            dots.forEach((dot, idx) => {
                if (idx === activeIndex) dot.classList.add('active');
                else dot.classList.remove('active');
            });
        }

        function liveCalcTotalMass() {
            const m1El = document.getElementById(`m1-total`);
            const m2El = document.getElementById(`m2-total`);
            if(!m1El || !m2El) return;

            const m1 = parseFloat(m1El.value);
            const m2 = parseFloat(m2El.value);
            const disp = document.getElementById(`disp-m-total`);
            if (!isNaN(m1) && !isNaN(m2)) {
                const diff = m1 - m2;
                disp.textContent = diff.toFixed(4) + " g";
                if (diff <= 0) disp.classList.add('text-red-500');
                else disp.classList.remove('text-red-500');
            } else {
                disp.textContent = "-";
            }
        }

        function liveCalcVol(i) {
            const v1El = document.getElementById(`v-start-${i}`);
            const v2El = document.getElementById(`v-end-${i}`);
            if(!v1El || !v2El) return;

            const v1 = parseFloat(v1El.value);
            const v2 = parseFloat(v2El.value);
            const disp = document.getElementById(`disp-v-${i}`);
            if (!isNaN(v1) && !isNaN(v2)) {
                const diff = v2 - v1;
                disp.textContent = diff.toFixed(2);
                if (diff <= 0) disp.classList.add('text-red-500');
                else disp.classList.remove('text-red-500');
            } else {
                disp.textContent = "-";
            }
        }

        function calcRAD(arr) {
            if (arr.length < 2) return null; // åªæœ‰1ä¸ªæ•°æ®æ—¶æ— æ³•è®¡ç®—
            const mean = arr.reduce((a, b) => a + b) / arr.length;
            if (mean === 0) return 0;
            const sumAbsDiff = arr.reduce((sum, val) => sum + Math.abs(val - mean), 0);
            const meanDev = sumAbsDiff / arr.length;
            return (meanDev / mean) * 100;
        }
        
        function calcMean(arr) {
            return arr.length ? arr.reduce((a, b) => a + b) / arr.length : 0;
        }

        function getSafeValue(id) {
            const el = document.getElementById(id);
            if (!el) {
                console.error(`Missing element with ID: ${id}`);
                return NaN;
            }
            return parseFloat(el.value);
        }

        function calculateResults() {
            console.log("Starting calculation...");
            try {
                const cStd = getSafeValue('c-std');
                const mMolar = getSafeValue('m-molar');
                const vTotalVol = getSafeValue('v-total-vol');
                const vAliquot = getSafeValue('v-aliquot');
                const m1Total = getSafeValue('m1-total');
                const m2Total = getSafeValue('m2-total');
                const useGroup2 = document.getElementById('use-group-2') ? document.getElementById('use-group-2').checked : false;
                
                // éªŒè¯å…¬å…±å‚æ•°
                if (isNaN(cStd) || cStd <= 0) return showToast("è¯·è¾“å…¥æœ‰æ•ˆçš„ KMnOâ‚„ æµ“åº¦", true);
                if (isNaN(mMolar) || mMolar <= 0) return showToast("è¯·è¾“å…¥æœ‰æ•ˆçš„æ‘©å°”è´¨é‡", true);
                if (isNaN(vTotalVol) || vTotalVol <= 0) return showToast("è¯·è¾“å…¥æœ‰æ•ˆçš„å®šå®¹ä½“ç§¯", true);
                if (isNaN(vAliquot) || vAliquot <= 0) return showToast("è¯·è¾“å…¥æœ‰æ•ˆçš„ç§»å–ä½“ç§¯", true);
                
                // éªŒè¯è¯•æ ·è´¨é‡
                const mSampleTotal = m1Total - m2Total;
                if (isNaN(mSampleTotal) || mSampleTotal <= 0) return showToast("è¯·è¾“å…¥æœ‰æ•ˆçš„è¯•æ ·æ€»è´¨é‡", true);
                
                // è®¡ç®—ç¨€é‡Šå€æ•°
                const dilutionFactor = vTotalVol / vAliquot;

                // 1. è·å–ç©ºç™½å®éªŒæ•°æ®
                const vBlankStart = getSafeValue('v-start-0');
                const vBlankEnd = getSafeValue('v-end-0');
                let vBlank = 0;
                if (isNaN(vBlankStart) || isNaN(vBlankEnd)) {
                    if(!confirm("æ£€æµ‹åˆ°ç©ºç™½å®éªŒæ•°æ®ä¸å®Œæ•´ï¼Œæ˜¯å¦å‡è®¾ç©ºç™½æ¶ˆè€—ä¸º 0 mL ç»§ç»­è®¡ç®—ï¼Ÿ")) return;
                    vBlank = 0;
                } else {
                    vBlank = vBlankEnd - vBlankStart;
                }

                let results = [];
                let percentArr = [];
                let validCount = 0;
                let rawInputs = { c: cStd, m: mMolar, m1Total, m2Total, vTotalVol, vAliquot, vBlankStart, vBlankEnd, useGroup2, data: [] };

                const iterations = useGroup2 ? 2 : 1;

                // 2. å¾ªç¯å¤„ç†
                for (let i = 1; i <= iterations; i++) {
                    const vStart = getSafeValue(`v-start-${i}`);
                    const vEnd = getSafeValue(`v-end-${i}`);
                    
                    if (isNaN(vStart) || isNaN(vEnd)) {
                        results.push(null); // æ•°æ®ä¸å…¨
                        continue;
                    }

                    const vTotal = vEnd - vStart;
                    const vNet = vTotal - vBlank; // æ‰£é™¤ç©ºç™½

                    validCount++;
                    
                    const n_KMnO4 = cStd * (vNet / 1000);
                    const n_Ca_aliquot = 2.5 * n_KMnO4;
                    const n_Ca_total = n_Ca_aliquot * dilutionFactor;
                    const m_Ca_total = n_Ca_total * mMolar;
                    const percent = (m_Ca_total / mSampleTotal) * 100;

                    if (percent < 0) {
                         results.push({ error: "ç»“æœä¸ºè´Ÿ (ç©ºç™½å€¼è¿‡å¤§?)" });
                         continue;
                    }

                    percentArr.push(percent);

                    results.push({
                        id: i,
                        vStart, vEnd, vTotal, vNet,
                        percent
                    });
                    rawInputs.data.push({ vStart, vEnd });
                }

                if (validCount === 0) return showToast("è¯·è‡³å°‘è¾“å…¥ä¸€ç»„å®Œæ•´çš„æœ‰æ•ˆæ»´å®šæ•°æ®", true);

                const avgPercent = calcMean(percentArr);
                const rad = calcRAD(percentArr);

                // å°†æ‰€æœ‰åŸå§‹æ•°æ®æ‰“åŒ…è¿› stats
                const stats = { 
                    avgPercent, rad, 
                    vBlank, vBlankStart, vBlankEnd,
                    dilutionFactor, 
                    mSampleTotal, m1Total, m2Total,
                    vTotalVol, vAliquot, 
                    groupCount: iterations 
                };
                
                renderTable(results, cStd, stats);
                updateStatsView(stats);
                
                const resultSection = document.getElementById('result-section');
                if(resultSection) resultSection.classList.remove('hidden');

                // å†å²è®°å½•é€»è¾‘
                const currentHash = JSON.stringify(rawInputs);
                if (currentHash === lastSubmissionHash) {
                    showToast("è®¡ç®—ç»“æœå·²æ›´æ–°");
                } else {
                    const record = {
                        date: new Date().toISOString(),
                        cStd, mMolar, results, stats
                    };
                    historyData.unshift(record);
                    try {
                         localStorage.setItem(HISTORY_KEY, JSON.stringify(historyData));
                    } catch(e) { console.error("Storage error", e); }
                    
                    renderHistory();
                    lastSubmissionHash = currentHash;
                    showToast("è®¡ç®—å®Œæˆï¼");
                }
            } catch(e) {
                console.error("Calculation Error:", e);
                alert("è®¡ç®—ç¨‹åºå‘ç”Ÿé”™è¯¯ï¼Œè¯¦æƒ…è¯·æŸ¥çœ‹æ§åˆ¶å°: " + e.message);
            }
        }
        
        function updateStatsView(stats) {
            const avgElem = document.getElementById('final-avg-percent');
            if(avgElem) avgElem.textContent = stats.avgPercent.toFixed(2) + " %";
            
            const radElem = document.getElementById('final-rad');
            if(radElem) {
                if (stats.rad === null) {
                    radElem.textContent = "N/A";
                    radElem.className = "font-bold text-gray-400 text-lg";
                } else {
                    radElem.textContent = stats.rad.toFixed(2) + " %";
                    if (stats.rad > 0.2) radElem.className = "font-bold text-orange-500 tabular-nums text-lg";
                    else radElem.className = "font-bold text-green-600 tabular-nums text-lg";
                }
            }
            
            const fElem = document.getElementById('final-dilution-factor');
            if(fElem) fElem.textContent = stats.dilutionFactor.toFixed(2);
            
            const blankElem = document.getElementById('final-blank-vol');
            if(blankElem) blankElem.textContent = stats.vBlank.toFixed(2) + " mL";
        }

        function generateTableHtml(results, cStd, stats) {
            if (!stats) return '';

            const getVal = (idx, key, fixed) => {
                if (!results || !results[idx] || results[idx].error) return '-';
                return Number(results[idx][key]).toFixed(fixed);
            };

            const count = stats.groupCount || 2; 

            // åŠ¨æ€è¡Œï¼šä¸»ä½“æ•°æ®
            const rows = [
                { label: `V<sub>åˆ</sub> (mL)`, key: 'vStart', fix: 2 },
                { label: `V<sub>ç»ˆ</sub> (mL)`, key: 'vEnd', fix: 2 },
                { label: `æ€»ä½“ç§¯ V (mL)`, key: 'vTotal', fix: 2 },
                { label: `å‡€ä½“ç§¯ (V-Vâ‚€) (mL)`, key: 'vNet', fix: 2, bold: true, color: false },
                { label: `w(Ca) (%)`, key: 'percent', fix: 2, color: true },
            ];
            
            let header = `<thead><tr><th style="width: 30%">é¡¹ç›® \\ ç»„åˆ«</th>`;
            for(let i=1; i<=count; i++) {
                header += `<th style="width: ${70/count}%">å¹³è¡Œæ · ${i}</th>`;
            }
            header += `</tr></thead>`;

            let body = `<tbody>`;
            
            // å®‰å…¨ç±»å‹è½¬æ¢
            const m1TotalSafe = Number(stats.m1Total || 0).toFixed(4);
            const m2TotalSafe = Number(stats.m2Total || 0).toFixed(4);
            const mSampleSafe = Number(stats.mSampleTotal || 0).toFixed(4);
            
            const fSafe = Number(stats.dilutionFactor || 0).toFixed(2);
            const cStdSafe = Number(cStd || 0).toFixed(5);
            
            const vBlankStartSafe = Number(stats.vBlankStart || 0).toFixed(2);
            const vBlankEndSafe = Number(stats.vBlankEnd || 0).toFixed(2);
            const vBlankSafe = Number(stats.vBlank || 0).toFixed(2);

            // 1. ç§°é‡è®°å½•å—
            body += `<tr><td colspan="${count+1}" class="table-subheader">I. è¯•æ ·ç§°é‡è®°å½•</td></tr>`;
            body += `<tr><td class="text-left font-medium">ç§°é‡ç“¶+æ · mâ‚ (g)</td><td colspan="${count}" class="tabular-nums">${m1TotalSafe}</td></tr>`;
            body += `<tr><td class="text-left font-medium">ç§°é‡ç“¶/ä½™æ · mâ‚‚ (g)</td><td colspan="${count}" class="tabular-nums">${m2TotalSafe}</td></tr>`;
            body += `<tr><td class="text-left font-medium">è¯•æ ·æ€»è´¨é‡ m (g)</td><td colspan="${count}" class="tabular-nums font-bold text-primary">${mSampleSafe}</td></tr>`;
            
            // 2. æº¶æ¶²å‚æ•°å—
            body += `<tr><td colspan="${count+1}" class="table-subheader">II. æº¶æ¶²é…åˆ¶å‚æ•°</td></tr>`;
            body += `<tr><td class="text-left font-medium">ç¨€é‡Šå€æ•° f</td><td colspan="${count}" class="tabular-nums">${fSafe}</td></tr>`;
            body += `<tr><td class="text-left font-medium">c(KMnOâ‚„) (mol/L)</td><td colspan="${count}" class="tabular-nums">${cStdSafe}</td></tr>`;
            
            // 3. ç©ºç™½å¯¹ç…§å—
            body += `<tr><td colspan="${count+1}" class="table-subheader">III. ç©ºç™½å¯¹ç…§è®°å½•</td></tr>`;
            body += `<tr><td class="text-left font-medium">ç©ºç™½ V<sub>åˆ</sub> (mL)</td><td colspan="${count}" class="tabular-nums">${vBlankStartSafe}</td></tr>`;
            body += `<tr><td class="text-left font-medium">ç©ºç™½ V<sub>ç»ˆ</sub> (mL)</td><td colspan="${count}" class="tabular-nums">${vBlankEndSafe}</td></tr>`;
            body += `<tr><td class="text-left font-medium">ç©ºç™½æ¶ˆè€— Vâ‚€ (mL)</td><td colspan="${count}" class="tabular-nums text-gray-500">${vBlankSafe}</td></tr>`;

            // 4. å¹³è¡Œæ ·æµ‹å®šå—
            body += `<tr><td colspan="${count+1}" class="table-subheader">IV. å¹³è¡Œæ ·æµ‹å®š</td></tr>`;
            rows.forEach(row => {
                body += `<tr><td class="text-left font-medium">${row.label}</td>`;
                for(let i=0; i<count; i++) {
                    let text = getVal(i, row.key, row.fix);
                    
                    let style = 'tabular-nums';
                    if (row.bold) style += ' font-bold text-primary';
                    if (row.color) style += ' font-bold text-[var(--accent-color)]';
                    
                    body += `<td class="${style}">${text}</td>`;
                }
                body += `</tr>`;
            });

            if (stats) {
                const avgNum = Number(stats.avgPercent || 0);
                body += `<tr class="bg-[var(--accent-bg)]/20"><td class="text-left font-bold text-primary">å¹³å‡å«é‡ wÌ„ (%)</td><td colspan="${count}" class="font-bold tabular-nums text-[var(--accent-color)] text-lg">${avgNum.toFixed(2)} %</td></tr>`;
                
                let radText = stats.rad === null ? "N/A" : Number(stats.rad).toFixed(2) + " %";
                body += `<tr><td class="text-left font-bold text-primary">ç›¸å¯¹å¹³å‡åå·® (RAD)</td><td colspan="${count}" class="tabular-nums">${radText}</td></tr>`;
            }

            body += `</tbody>`;
            return `<table class="result-table bg-surface w-full">${header}${body}</table>`;
        }

        function renderTable(results, cStd, stats) {
            const tableHtml = generateTableHtml(results, cStd, stats);
            const headElem = document.getElementById('result-table-head');
            const bodyElem = document.getElementById('result-table-body');
            
            if(headElem && bodyElem) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = tableHtml;
                headElem.innerHTML = tempDiv.querySelector('thead').innerHTML;
                bodyElem.innerHTML = tempDiv.querySelector('tbody').innerHTML;
            }
        }

        function renderHistory() {
            const container = document.getElementById('history-container');
            if(!container) return;
            container.innerHTML = '';
            
            if (historyData.length === 0) {
                container.innerHTML = '<p class="text-center text-sm text-secondary">æš‚æ— å†å²è®°å½•</p>';
                return;
            }

            historyData.forEach((rec, idx) => {
                const date = new Date(rec.date).toLocaleString('zh-CN');
                // å¥å£®æ€§æ£€æŸ¥ï¼šç¡®ä¿ stats å­˜åœ¨ï¼Œå¦åˆ™è·³è¿‡
                if (!rec.stats) return;

                const tableHtml = generateTableHtml(rec.results, rec.cStd, rec.stats);
                
                const mSampleSafe = Number(rec.stats.mSampleTotal || 0).toFixed(4);
                const fSafe = Number(rec.stats.dilutionFactor || 0).toFixed(1);
                
                const html = `
                <div class="bg-surface border border-[var(--border-light)] rounded-lg shadow-sm text-sm overflow-hidden transition-all duration-300">
                    <div class="history-summary-row p-4 flex justify-between items-center" onclick="toggleHistory(${idx})">
                        <div class="flex-1">
                            <div class="font-bold text-[var(--accent-color)] mb-1">${date}</div>
                            <div class="text-xs text-secondary flex gap-4">
                                <span>wÌ„(Ca): <b class="tabular-nums">${Number(rec.stats.avgPercent || 0).toFixed(2)}%</b></span>
                                <span>m: ${mSampleSafe}g</span>
                                <span class="hidden sm:inline">f: ${fSafe}</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <button onclick="event.stopPropagation(); deleteHistory(${idx})" class="text-[var(--color-error)] text-xs hover:underline">åˆ é™¤</button>
                            <svg id="arrow-${idx}" class="w-5 h-5 text-secondary expand-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                    </div>
                    <div id="detail-${idx}" class="history-details bg-[var(--bg-canvas)] px-2 sm:px-4">
                        <div class="py-4 overflow-x-auto">
                           ${tableHtml}
                        </div>
                    </div>
                </div>`;
                container.innerHTML += html;
            });
        }
        
        function toggleHistory(idx) {
            const detail = document.getElementById(`detail-${idx}`);
            const arrow = document.getElementById(`arrow-${idx}`);
            if (detail.classList.contains('open')) {
                detail.classList.remove('open');
                arrow.classList.remove('open');
            } else {
                detail.classList.add('open');
                arrow.classList.add('open');
            }
        }
        
        function deleteHistory(index) {
            historyData.splice(index, 1);
            localStorage.setItem(HISTORY_KEY, JSON.stringify(historyData));
            renderHistory();
        }

        function clearHistory() {
            if(confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰è®°å½•å—ï¼Ÿ')) {
                historyData = [];
                localStorage.removeItem(HISTORY_KEY);
                renderHistory();
            }
        }
        
        function exportCSV() {
            if (historyData.length === 0) return showToast("æ— æ•°æ®å¯å¯¼å‡º", true);
            
            // æ›´æ–° CSV è¡¨å¤´ï¼ŒåŠ å…¥è¯¦ç»†ç§°é‡å’Œç©ºç™½æ•°æ®
            let csv = "æ—¶é—´,ç»„åˆ«,m1(g),m2(g),è¯•æ ·æ€»è´¨é‡m(g),å®šå®¹V_total(mL),ç§»å–V_aliquot(mL),ç¨€é‡Šå€æ•°f,c_KMnO4(mol/L),ç©ºç™½V_start(mL),ç©ºç™½V_end(mL),ç©ºç™½V0(mL),è¯•æ ·V_start(mL),è¯•æ ·V_end(mL),è¯•æ ·V_total(mL),è¯•æ ·V_net(mL),w_Ca(%),Avg_w(%),RAD(%)\n";
            
            historyData.forEach(rec => {
                if(!rec.stats) return;

                const time = new Date(rec.date).toLocaleString().replace(',', ' ');
                const avg = Number(rec.stats.avgPercent || 0).toFixed(2);
                const rad = rec.stats.rad === null ? 'N/A' : Number(rec.stats.rad).toFixed(2);
                
                // åŸå§‹æ•°æ®æå–
                const m1 = Number(rec.stats.m1Total || 0).toFixed(4);
                const m2 = Number(rec.stats.m2Total || 0).toFixed(4);
                const mSample = Number(rec.stats.mSampleTotal || 0).toFixed(4);
                const f = Number(rec.stats.dilutionFactor || 0).toFixed(2);
                const vTot = Number(rec.stats.vTotalVol || 0).toFixed(2);
                const vAli = Number(rec.stats.vAliquot || 0).toFixed(2);
                
                const vbStart = Number(rec.stats.vBlankStart || 0).toFixed(2);
                const vbEnd = Number(rec.stats.vBlankEnd || 0).toFixed(2);
                const vBlank = Number(rec.stats.vBlank || 0).toFixed(2);

                rec.results.forEach((r) => {
                    if(!r || r.error) return;
                    csv += `${time},å¹³è¡Œæ ·${r.id},${m1},${m2},${mSample},${vTot},${vAli},${f},${rec.cStd},${vbStart},${vbEnd},${vBlank},${r.vStart},${r.vEnd},${Number(r.vTotal).toFixed(2)},${Number(r.vNet).toFixed(2)},${Number(r.percent).toFixed(2)},${avg},${rad}\n`;
                });
            });
            
            const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `é’™å«é‡åˆ†ææ•°æ®_${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function togglePrinciple() {
            const content = document.getElementById('principle-content');
            const arrow = document.getElementById('principle-arrow');
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                arrow.classList.add('rotate-180');
            } else {
                content.classList.add('hidden');
                arrow.classList.remove('rotate-180');
            }
        }

        function showToast(msg, isError = false) {
            const toast = document.getElementById('toast-notification');
            if(!toast) return;
            const span = toast.querySelector('span');
            if(span) span.innerText = msg;
            
            const icon = toast.querySelector('svg');
            
            if (isError && icon) {
                icon.classList.remove('text-green-400');
                icon.classList.add('text-red-400');
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />';
            } else if (icon) {
                icon.classList.remove('text-red-400');
                icon.classList.add('text-green-400'); 
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />';
            }
            
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }
        
        function copyText(el) {
            const text = el.innerText;
            navigator.clipboard.writeText(text).then(() => showToast("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿"));
        }

        const colorPalettes = {
            'purple': { 
                light: { '--accent-color': '#7c3aed', '--accent-color-dark': '#6d28d9', '--accent-bg': '#f3e8ff' }, 
                dark: { '--accent-color': '#a78bfa', '--accent-color-dark': '#8b5cf6', '--accent-bg': '#2e1065' } 
            },
            'blue': { 
                light: { '--accent-color': '#0284c7', '--accent-color-dark': '#0369a1', '--accent-bg': '#e0f2fe' }, 
                dark: { '--accent-color': '#38bdf8', '--accent-color-dark': '#0ea5e9', '--accent-bg': '#082f49' } 
            },
            'emerald': { 
                light: { '--accent-color': '#059669', '--accent-color-dark': '#047857', '--accent-bg': '#ecfdf5' }, 
                dark: { '--accent-color': '#34d399', '--accent-color-dark': '#10b981', '--accent-bg': '#102d24' } 
            },
            'pink': { 
                light: { '--accent-color': '#db2777', '--accent-color-dark': '#be185d', '--accent-bg': '#fce7f3' }, 
                dark: { '--accent-color': '#f472b6', '--accent-color-dark': '#ec4899', '--accent-bg': '#500724' } 
            }
        };
        let currentAccent = 'purple';
        let currentMode = 'light';
        let isAnim = true;

        function setAccent(name) {
            currentAccent = name;
            applyTheme();
            document.querySelectorAll('.theme-button').forEach(b => b.classList.remove('active'));
            const btn = document.querySelector(`button[onclick="setAccent('${name}')"]`);
            if(btn) btn.classList.add('active');
        }
        
        function toggleMode() {
            currentMode = currentMode === 'light' ? 'dark' : 'light';
            const modeText = document.getElementById('mode-text');
            if(modeText) modeText.innerText = currentMode === 'light' ? 'æµ…è‰²' : 'æ·±è‰²';
            document.body.setAttribute('data-mode', currentMode);
            applyTheme();
        }
        
        function applyTheme() {
            const p = colorPalettes[currentAccent][currentMode];
            const root = document.documentElement;
            root.style.setProperty('--accent-color', p['--accent-color']);
            root.style.setProperty('--accent-color-dark', p['--accent-color-dark']);
            root.style.setProperty('--accent-bg', p['--accent-bg']);
            const hex = p['--accent-color'].replace('#', '');
            const r = parseInt(hex.substring(0,2), 16);
            const g = parseInt(hex.substring(2,4), 16);
            const b = parseInt(hex.substring(4,6), 16);
            root.style.setProperty('--accent-color-rgb', `${r}, ${g}, ${b}`);
        }

        function toggleAnimation() {
            isAnim = !isAnim;
            const animText = document.getElementById('animation-text');
            if(animText) animText.innerText = isAnim ? 'åŠ¨æ•ˆå¼€' : 'åŠ¨æ•ˆå…³';
            document.documentElement.style.setProperty('--animation-state', isAnim ? 'running' : 'paused');
            const floatCont = document.getElementById('floating-container');
            if(floatCont) floatCont.style.opacity = isAnim ? '1' : '0';
        }

        function createFloatingElements() { 
            const container = document.getElementById('floating-container');
            if(!container) return;
            container.innerHTML = ''; 
            const symbols = ['CaÂ²âº', 'MnOâ‚„â»', 'Câ‚‚Oâ‚„Â²â»', 'CaCâ‚‚Oâ‚„', 'Hâº', 'COâ‚‚', 'MnÂ²âº', 'ç´«çº¢', 'æ— è‰²', 'æ²‰æ·€']; 
            for (let i = 0; i < 35; i++) {
                const el = document.createElement('div');
                el.classList.add('floating-element');
                el.innerText = symbols[Math.floor(Math.random() * symbols.length)];
                el.style.setProperty('--random-x', Math.random() * 100 + 'vw');
                el.style.fontSize = (Math.random() * 1.5 + 0.8) + 'rem';
                el.style.animationDuration = (Math.random() * 15 + 10) + 's';
                el.style.animationDelay = (Math.random() * -20) + 's';
                container.appendChild(el);
            }
        }

        window.onload = function() {
            renderHistory();
            createFloatingElements();
            applyTheme(); 
            toggleGroup2(); // åˆå§‹åŒ–çŠ¶æ€
        }

    </script>
</body>
</html>