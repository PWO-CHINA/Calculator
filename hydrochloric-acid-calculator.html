<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é«˜çº§åŒ–å­¦è®¡ç®—å™¨ - ç¨€é‡Šä¸æ ‡å®š</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ä½¿ç”¨ Inter å­—ä½“ä½œä¸ºé»˜è®¤å­—ä½“ï¼ŒåŒæ—¶ä¼˜åŒ–æ’ç‰ˆå±‚çº§ */
        :root {
            font-family: 'Inter', sans-serif;
            --bg-canvas: #f0f5f9;
            --bg-surface: #ffffff;
            --text-primary: #1a1a1a;
            --text-secondary: #6b7280;
            --accent-color: #8c7851;
            --accent-bg: #eaddcf;
            --color-error: #f04c4c;
            --border-light: #e0e0e0;
            --button-text: #ffffff;
            --accent-color-rgb: 140, 120, 81;
            --animation-state: running;
        }

        body {
            background-color: var(--bg-canvas);
            transition: background-color 0.5s ease, color 0.5s ease;
            background-image: radial-gradient(
                circle at 50% 10%, 
                rgba(var(--accent-color-rgb), 0.07) 0%, 
                var(--bg-canvas) 50%
            );
            background-size: cover;
            background-attachment: fixed;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 1.5rem 0;
            box-sizing: border-box;
             /* é˜²æ­¢ç§»åŠ¨ç«¯æ¨ªå‘æº¢å‡º */
            overflow-x: hidden;
        }
        
        .main-calculator-card {
            position: relative;
            z-index: 10; 
            width: 90%;
            max-width: 500px;
            margin: 0;
            /* ç§»åŠ¨ç«¯åº•éƒ¨ç•™ç™½ï¼Œé˜²æ­¢å†…å®¹è¢« Toast é®æŒ¡ */
            margin-bottom: 4rem; 
        }

        /* --- åŠ¨ç”»ä¿®æ­£ --- */
        #floating-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none; 
            z-index: 0;
        }
        
        .floating-element {
            position: absolute;
            top: 0;
            left: var(--initial-x-offset); 
            color: var(--accent-color);
            opacity: 0.1;
            font-weight: 900;
            line-height: 1;
            white-space: nowrap;
            animation: waterfall linear infinite;
            animation-play-state: var(--animation-state);
            user-select: none;
        }

        @keyframes waterfall {
            0% { transform: translateY(-100vh); }
            100% { transform: translateY(200vh); }
        }
        
        /* --- æ·±è‰²æ¨¡å¼ --- */
        body[data-mode="dark"] {
            --bg-canvas: #0a0a0a;           
            --bg-surface: #141414;          
            --text-primary: #ffffff;        
            --text-secondary: #a8b9d9;      
            --color-error: #ff7f7f;         
            --border-light: #333333;        
            --button-text: #0a0a0a;         
             background-image: radial-gradient(
                circle at 50% 10%, 
                rgba(var(--accent-color-rgb), 0.15) 0%, 
                var(--bg-canvas) 50%
            );
        }

        /* é€šç”¨ç±» */
        .bg-surface { background-color: var(--bg-surface); }
        .text-primary { color: var(--text-primary); }
        .text-secondary { color: var(--text-secondary); }
        .border-light { border-color: var(--border-light); }
        .accent-bg { background-color: var(--accent-bg); }
        
        /* è¾“å…¥æ¡†æ ·å¼ */
        .input-field {
            border-color: var(--border-light);
            color: var(--text-primary);
            background-color: var(--bg-surface);
            transition: border-color 0.3s, background-color 0.5s;
        }
        .input-field:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(var(--accent-color-rgb), 0.3);
            outline: none;
        }

        /* C1: ä¸»é¢˜æŒ‰é’®é€‰ä¸­æ€ä¼˜åŒ– - åŒå±‚ç¯æ•ˆæœ */
        .theme-button {
            position: relative;
        }
        .theme-button.active {
            transform: scale(1.1);
            box-shadow: 0 0 0 2px var(--bg-surface), 0 0 0 4px var(--text-primary);
        }

        /* è¡¨æ ¼æ ·å¼ */
        .history-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px; 
        }
        .history-table th, .history-table td {
            padding: 10px 6px;
            text-align: center;
            border-bottom: 1px solid var(--border-light); 
            color: var(--text-primary);
        }
        .history-table thead {
            background-color: var(--accent-bg); 
            color: var(--text-primary);
        }
        .data-table th, .data-table td {
            padding: 8px;
            border: 1px solid var(--border-light);
            text-align: center;
        }
        .data-table th { background-color: var(--accent-bg); }

        /* æŒ‰é’®åŠ¨æ•ˆ */
        .calculate-button {
            background-color: var(--accent-color); 
            color: var(--button-text); 
            transition: all 0.3s ease-out; 
            font-weight: 700;
        }
        .calculate-button:hover {
            filter: brightness(1.15); 
            box-shadow: 0 4px 15px 0px rgba(var(--accent-color-rgb), 0.4); 
            transform: translateY(-2px); 
        }
        .calculate-button:active {
            filter: brightness(0.9); 
            transform: scale(0.98); 
            box-shadow: none;
        }
        .active-scale-98:active { transform: scale(0.98); }

        /* æ’ç‰ˆ */
        .main-title { font-size: 2.25rem; font-weight: 900; letter-spacing: -0.05em; }
        .section-title { font-size: 1.25rem; font-weight: 700; }
        
        /* æ¨¡å¼åˆ‡æ¢æ  */
        #mode-selector {
            position: relative;
            top: auto;
            left: auto;
            transform: none;
            z-index: 50; 
            display: flex;
            flex-direction: row;
            width: 90%;
            max-width: 500px;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.5s ease-out;
        }

        .mode-tab {
            width: 50%;
            padding: 12px 8px;
            cursor: pointer;
            text-align: center;
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-secondary);
            background-color: var(--bg-surface);
            transition: all 0.3s ease-in-out;
            border-left: none; 
            border-right: 1px solid var(--border-light); 
            border-bottom: 4px solid transparent;
        }
        .mode-tab:last-child { border-right: none; }

        #mode-selector .mode-tab.active-mode {
            color: var(--accent-color);
            background-color: var(--accent-bg);
            border-bottom-color: var(--accent-color) !important; 
            border-left-color: transparent;
            box-shadow: 0 0 15px rgba(var(--accent-color-rgb), 0.15) inset;
        }
        .mode-tab:hover:not(.active-mode) {
             background-color: var(--accent-bg);
             opacity: 0.8;
        }

        @media (min-width: 640px) {
            #mode-selector {
                position: fixed;
                top: 50%;
                left: 0;
                transform: translateY(-50%);
                flex-direction: column;
                width: auto;
                max-width: none;
                margin-bottom: 0;
                box-shadow: 4px 0 12px rgba(0, 0, 0, 0.1);
                border-radius: 0 12px 12px 0;
            }
            .mode-tab {
                width: 120px;
                border-left: 4px solid transparent;
                border-right: none;
                border-bottom: 1px solid var(--border-light);
            }
            .mode-tab:last-child { border-bottom: none; }
            #mode-selector .mode-tab.active-mode {
                border-left-color: var(--accent-color);
                border-bottom-color: var(--border-light) !important;
            }
        }
        
        .unit-toggle-btn {
            background-color: var(--accent-color);
            color: var(--button-text);
            transition: all 0.3s ease-in-out;
            border: 1px solid var(--accent-color);
            font-weight: 500;
        }
        .unit-toggle-btn.inactive {
            background-color: var(--bg-surface);
            color: var(--accent-color);
            border: 1px solid var(--border-light);
        }

        /* A5: Toast æç¤ºæ ·å¼ */
        #toast-notification {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-size: 0.9rem;
            font-weight: 500;
            z-index: 100;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            pointer-events: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        #toast-notification.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        
        /* A5: å¯ç‚¹å‡»å¤åˆ¶çš„å…ƒç´ æ ·å¼ */
        .copyable-result {
            cursor: pointer;
            position: relative;
            transition: transform 0.1s;
            border-bottom: 2px dashed rgba(var(--accent-color-rgb), 0.3);
        }
        .copyable-result:active {
            transform: scale(0.95);
        }
        .copyable-result::after {
            content: 'ğŸ“‹';
            font-size: 0.8rem;
            position: absolute;
            top: -0.8rem;
            right: -1.2rem;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .copyable-result:hover::after {
            opacity: 1;
        }

    </style>
</head>
<body data-mode="light">
    
    <div id="floating-container"></div>
    
    <!-- Toast Notification (A5) -->
    <div id="toast-notification">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
        <span>ç»“æœå·²å¤åˆ¶åˆ°å‰ªè´´æ¿</span>
    </div>
    
    <div id="mode-selector">
        <div id="tab-dilution" class="mode-tab active-mode" onclick="setMode('dilution')">
            <div class="text-lg">ğŸ’§</div> 
            ç¨€é‡Šé…åˆ¶
        </div>
        <div id="tab-standardization" class="mode-tab" onclick="setMode('standardization')">
            <div class="text-lg">âš—ï¸</div>
            æµ“åº¦æ ‡å®š
        </div>
    </div>

    <div class="main-calculator-card bg-surface shadow-2xl rounded-2xl p-8 space-y-8 border-t-8 border-[var(--accent-color)] transition-colors duration-500">

        <!-- é¡¶éƒ¨æ§åˆ¶åŒº -->
        <div class="flex flex-col space-y-4 pb-4 border-b border-[var(--border-light)] transition-colors duration-500">
            <div class="flex flex-wrap items-center space-x-3">
                <span class="text-sm font-medium text-[var(--text-secondary)] self-center">ç•Œé¢æ¨¡å¼:</span>
                <button onclick="toggleMode()"
                        class="px-3 py-1 bg-[var(--accent-bg)] rounded-full text-[var(--text-primary)] hover:bg-[var(--border-light)] transition-colors duration-300 active-scale-98 text-sm font-medium border border-[var(--border-light)]">
                    <span id="mode-text">æµ…è‰²æ¨¡å¼</span>
                </button>

                <span class="text-sm font-medium text-[var(--text-secondary)] self-center ml-6 sm:ml-8">åŠ¨æ€ç‰¹æ•ˆ:</span>
                <button onclick="toggleAnimation()"
                        class="px-3 py-1 bg-[var(--accent-bg)] rounded-full text-[var(--text-primary)] hover:bg-[var(--border-light)] transition-colors duration-300 active-scale-98 text-sm font-medium border border-[var(--border-light)]">
                    <span id="animation-text">å·²å¼€å¯</span>
                </button>
            </div>

            <!-- C1: å¼ºè°ƒè‰²é€‰æ‹© (æ ·å¼ä¼˜åŒ–) -->
            <div class="flex items-center space-x-2 pt-2">
                <span class="text-sm font-medium text-[var(--text-secondary)] self-center">å¼ºè°ƒè‰²:</span>
                
                <button id="accent-organic" onclick="setAccent('organic')" 
                        class="theme-button w-8 h-8 rounded-full transition-all duration-300 active"
                        style="background: #8c7851;" title="æœ‰æœºæš–è‰²ä¸»é¢˜">
                </button>
                <button id="accent-starry-night" onclick="setAccent('starry-night')" 
                        class="theme-button w-8 h-8 rounded-full transition-all duration-300"
                        style="background: #27497d;" title="æ˜Ÿæœˆå¤œæ·±è‰²ä¸»é¢˜">
                </button>
                <button id="accent-emerald" onclick="setAccent('emerald')" 
                        class="theme-button w-8 h-8 rounded-full transition-all duration-300"
                        style="background: #059669;" title="ç¥–æ¯ç»¿ä¸»é¢˜">
                </button>
                <button id="accent-violet" onclick="setAccent('violet')" 
                        class="theme-button w-8 h-8 rounded-full transition-all duration-300"
                        style="background: #8b5cf6;" title="ç´«ç½—å…°ä¸»é¢˜">
                </button>
            </div>
        </div>
        
        <!-- ----------------------------------------------------- -->
        <!-- æ¨¡å¼ä¸€ï¼šç¨€é‡Šé…åˆ¶è®¡ç®— (Dilution) -->
        <!-- ----------------------------------------------------- -->
        <div id="view-dilution" class="space-y-8">
            <h1 class="main-title text-center text-primary">ç¨€ç›é…¸é…ç½®è®¡ç®—å™¨</h1>
            <p class="text-center text-[var(--text-secondary)] text-md">æ ¹æ® C<sub>1</sub>V<sub>1</sub> = C<sub>2</sub>V<sub>2</sub> å…¬å¼è®¡ç®—æ‰€éœ€æµ“ç›é…¸ä½“ç§¯ã€‚</p>

            <div class="bg-[var(--accent-bg)] p-4 rounded-lg border border-light transition-colors duration-500">
                <h2 class="section-title text-primary mb-2">æµ“ç›é…¸ (HCl) æ ‡å‡†å‚è€ƒå‚æ•°ï¼š</h2>
                <div class="space-y-4">
                    <div>
                        <label for="conc-density-input" class="block text-sm font-bold text-primary mb-1">
                            æµ“ç›é…¸å¯†åº¦ (g/mL)
                        </label>
                        <input type="number" id="conc-density-input" placeholder="ä¾‹å¦‚: 1.19" min="0.5" step="0.001" value="1.19"
                               class="w-full rounded-lg p-3 border input-field" oninput="validateDilutionInputs()">
                    </div>

                    <div>
                        <label for="conc-molarity-input" class="block text-sm font-bold text-primary mb-1">
                            å½“å‰æµ“ç›é…¸æ‘©å°”æµ“åº¦ (C<sub>æµ“</sub>) (M)
                        </label>
                        <div class="flex space-x-2">
                            <input type="number" id="conc-molarity-input" placeholder="ä¾‹å¦‚: 12.063" min="0.001" step="0.001"
                                class="flex-1 block w-full rounded-lg p-3 border input-field" oninput="validateDilutionInputs()">
                            <button onclick="resetConcentration()"
                                    class="px-4 py-2 bg-[var(--border-light)] text-primary rounded-lg hover:filter hover:brightness-90 text-sm font-medium transition duration-150 ease-in-out active-scale-98 whitespace-nowrap">
                                é‡ç½®
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="space-y-6">
                <div>
                    <label for="target-volume" class="block text-sm font-medium text-secondary mb-1">
                        ç›®æ ‡ç¨€ç›é…¸ä½“ç§¯ (V<sub>ç¨€</sub>)
                    </label>
                    <div class="mt-1 flex rounded-md shadow-sm">
                        <input type="number" id="target-volume" placeholder="ä¾‹å¦‚: 500" min="0.1" step="0.1"
                               class="flex-1 block w-full rounded-l-md p-3 border input-field" oninput="hideMessages()">
                        <div class="flex items-center">
                             <button id="volume-unit-mL" class="unit-toggle-btn w-12 h-full rounded-none" onclick="toggleDilutionUnit('volume', 'mL')">
                                mL
                            </button>
                            <button id="volume-unit-L" class="unit-toggle-btn inactive w-12 h-full rounded-r-md" onclick="toggleDilutionUnit('volume', 'L')">
                                L
                            </button>
                        </div>
                    </div>
                </div>

                <div>
                    <label for="target-concentration" class="block text-sm font-medium text-secondary mb-1">
                        ç›®æ ‡ç¨€ç›é…¸æµ“åº¦ (C<sub>ç¨€</sub>)
                    </label>
                    <div class="mt-1 flex rounded-md shadow-sm">
                        <input type="number" id="target-concentration" placeholder="ä¾‹å¦‚: 0.1" min="0.001" step="0.001"
                               class="flex-1 block w-full rounded-l-md p-3 border input-field" oninput="validateDilutionInputs()">
                        <div class="flex items-center">
                             <button id="conc-unit-M" class="unit-toggle-btn w-12 h-full rounded-none" onclick="toggleDilutionUnit('conc', 'M')">
                                M
                            </button>
                            <button id="conc-unit-W" class="unit-toggle-btn inactive w-16 h-full rounded-r-md" onclick="toggleDilutionUnit('conc', 'W')">
                                %
                            </button>
                        </div>
                    </div>
                    <!-- A4: å®æ—¶è­¦å‘Šä¿¡æ¯å®¹å™¨ -->
                    <p id="dilution-warning-text" class="text-xs text-[var(--color-error)] mt-1 font-bold hidden">
                        âš ï¸ ç›®æ ‡æµ“åº¦ä¸èƒ½é«˜äºæµ“ç›é…¸åŸæ¶²æµ“åº¦ã€‚
                    </p>

                    <div id="target-density-group" class="mt-2" style="display:none;">
                         <label for="target-density" class="block text-xs font-medium text-secondary mb-1">
                            ç›®æ ‡ç¨€ç›é…¸å¯†åº¦ (g/mL) <span class="text-[var(--accent-color)] font-bold ml-1" id="auto-density-badge" style="display:none;">(âš¡ï¸å·²è‡ªåŠ¨ä¼°ç®—)</span>
                        </label>
                        <input type="number" id="target-density" placeholder="ä¾‹å¦‚: 1.00" min="0.5" step="0.001" value="1.00"
                               class="w-full rounded-lg p-2 border input-field" oninput="validateDilutionInputs()">
                        <p class="text-xs text-secondary mt-1">
                            è¯´æ˜: "è´¨é‡%" -> "æ‘©å°”æµ“åº¦" çš„æ¢ç®—å¿…é¡»ä¾èµ–å¯†åº¦ã€‚App ä¼šæ ¹æ®æ‚¨è¾“å…¥çš„æµ“åº¦è‡ªåŠ¨ä¼°ç®—è¿‘ä¼¼å¯†åº¦ã€‚
                        </p>
                    </div>
                </div>
                
                <input type="hidden" id="V_dilute_unit" value="mL">
                <input type="hidden" id="C_dilute_unit" value="M">

                <button id="calculate-dilution-btn" onclick="calculateDilution()"
                        class="w-full flex justify-center py-3 px-4 rounded-lg shadow-lg text-lg calculate-button">
                    è®¡ç®—æ‰€éœ€æµ“ç›é…¸ä½“ç§¯
                </button>
            </div>

            <div id="dilution-result-box" class="mt-6 p-6 bg-surface rounded-lg border-2 border-[var(--accent-color)] hidden transition-colors duration-500">
                <h2 class="text-xl font-bold text-[var(--accent-color)] mb-2">è®¡ç®—ç»“æœ (V<sub>æµ“</sub>)</h2>
                <div class="flex items-baseline space-x-2">
                    <!-- A5: æ·»åŠ ç‚¹å‡»å¤åˆ¶ -->
                    <span id="required-volume" class="text-4xl font-extrabold text-[var(--accent-color)] copyable-result" onclick="copyResult(this)">0.00</span> 
                    <span id="required-volume-unit" class="text-xl font-bold text-[var(--accent-color)]">mL</span>
                </div>
                <p class="text-sm text-secondary mt-2">
                    <span class="inline-block bg-[var(--accent-bg)] text-[var(--text-primary)] px-2 py-0.5 rounded text-xs mr-1">æç¤º</span>
                    ç‚¹å‡»ç»“æœæ•°å€¼å¯å¤åˆ¶ã€‚å–è¯¥ä½“ç§¯æµ“ç›é…¸ï¼ŒåŠ æ°´ç¨€é‡Šè‡³ç›®æ ‡ä½“ç§¯ã€‚
                </p>
            </div>

            <div class="mt-10 pt-6 border-t border-light transition-colors duration-500">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 space-y-2 sm:space-y-0">
                    <h2 class="section-title text-primary">ç¨€é‡Šå†å²è®°å½•</h2>
                    <div class="space-x-2">
                        <button onclick="exportCSV('dilution')"
                                class="px-3 py-1 bg-[#2ECC71] text-white rounded-lg hover:bg-[#25A764] text-sm font-medium transition duration-150 ease-in-out active-scale-98">
                            å¯¼å‡º CSV
                        </button>
                        <button onclick="clearHistory('dilution')"
                                class="px-3 py-1 bg-[var(--color-error)] text-white rounded-lg hover:filter hover:brightness-90 text-sm font-medium transition duration-150 ease-in-out active-scale-98">
                            æ¸…ç©ºè®°å½•
                        </button>
                    </div>
                </div>
                <div id="dilution-history-container" class="overflow-x-auto"></div>
            </div>
        </div>
        
        <!-- ----------------------------------------------------- -->
        <!-- æ¨¡å¼äºŒï¼šç›é…¸æ ‡å‡†æº¶æ¶²æ ‡å®šè®¡ç®— (Standardization) -->
        <!-- ----------------------------------------------------- -->
        <div id="view-standardization" class="space-y-8 hidden">
             <h1 class="main-title text-center text-primary">ç¨€ç›é…¸æµ“åº¦æ ‡å®šå™¨</h1>
             <p class="text-center text-[var(--text-secondary)] text-md">ä½¿ç”¨åŸºå‡†ç‰©è´¨æ ‡å®š HCl æº¶æ¶²çš„å‡†ç¡®æµ“åº¦ã€‚</p>
             
             <div class="accent-bg p-4 rounded-lg border border-light transition-colors duration-500">
                <h2 class="section-title text-primary mb-2">æ ‡å®šå‚æ•°è®¾ç½®ï¼š</h2>
                
                <!-- B3: åŸºå‡†ç‰©è´¨é€‰æ‹© -->
                <div class="mb-4">
                    <label for="standard-substance" class="block text-sm font-bold text-primary mb-1">
                        é€‰æ‹©åŸºå‡†ç‰©è´¨
                    </label>
                    <select id="standard-substance" onchange="updateStandardSubstance()"
                            class="w-full rounded-lg p-3 border input-field cursor-pointer">
                        <option value="Na2CO3">æ— æ°´ç¢³é…¸é’  (Naâ‚‚COâ‚ƒ)</option>
                        <option value="Borax">ç¡¼ç ‚ (Naâ‚‚Bâ‚„Oâ‚‡Â·10Hâ‚‚O)</option>
                    </select>
                </div>

                <div class="text-sm space-y-1 text-secondary">
                    <p>ååº”åŒ–å­¦è®¡é‡æ¯”ï¼š<span id="stoich-display" class="font-mono font-bold">2HCl ~ 1Na<sub>2</sub>CO<sub>3</sub></span></p>
                    <p id="formula-display" class="font-mono text-base break-words text-xs sm:text-sm">
                        C<sub>HCl</sub> = (2 Ã— m) / (M Ã— V Ã— 10<sup>-3</sup>)
                    </p>
                </div>

                <div class="mt-4">
                    <label for="molar-mass-standard" class="block text-sm font-bold text-primary mb-1">
                        åŸºå‡†ç‰©æ‘©å°”è´¨é‡ (M) (g/mol)
                    </label>
                    <div class="flex space-x-2">
                        <input type="number" id="molar-mass-standard" value="105.99" min="1" step="0.01"
                               class="flex-1 block w-full rounded-lg p-3 border input-field">
                        <button onclick="resetMolarMass()"
                                class="px-4 py-2 bg-[var(--border-light)] text-primary rounded-lg hover:filter hover:brightness-90 text-sm font-medium transition duration-150 ease-in-out active-scale-98 whitespace-nowrap">
                            é‡ç½®
                        </button>
                    </div>
                </div>
                
                <div class="mt-4">
                    <label for="rsd-limit" class="block text-sm font-bold text-primary mb-1">
                        RSD éªŒæ”¶æ ‡å‡† (%)
                    </label>
                    <div class="flex space-x-2">
                        <input type="number" id="rsd-limit" value="0.20" min="0.01" step="0.01"
                               class="flex-1 block w-full rounded-lg p-3 border input-field" oninput="hideMessages()">
                        <span class="px-4 py-2 bg-[var(--border-light)] text-primary rounded-lg text-sm font-medium transition duration-150 ease-in-out active-scale-98 whitespace-nowrap">
                            %
                        </span>
                    </div>
                </div>
            </div>
            
            <h2 class="section-title text-primary">å¹³è¡Œæµ‹å®šæ•°æ®è¾“å…¥ (3æ¬¡)</h2>
            <div id="trials-container" class="space-y-4">
                <!-- Trial 1 -->
                <div class="p-4 rounded-lg border border-light bg-surface space-y-2" data-trial="1">
                    <h3 class="font-bold text-primary">ç¬¬ 1 æ¬¡æµ‹å®š</h3>
                    <div>
                        <label for="mass-1" class="block text-xs font-medium text-secondary mb-1">åŸºå‡†ç‰©è´¨é‡ m (g)</label>
                        <input type="number" id="mass-1" placeholder="è´¨é‡ (g)" min="0.001" step="0.0001" value=""
                               class="w-full rounded-lg p-2 border input-field" oninput="hideMessages()">
                    </div>
                    <div>
                        <label for="volume-1" class="block text-xs font-medium text-secondary mb-1">HCl æ¶ˆè€—ä½“ç§¯ (mL)</label>
                        <input type="number" id="volume-1" placeholder="ä½“ç§¯ (mL)" min="0.01" step="0.01" value=""
                               class="w-full rounded-lg p-2 border input-field" oninput="hideMessages()">
                    </div>
                </div>
                 <!-- Trial 2 -->
                <div class="p-4 rounded-lg border border-light bg-surface space-y-2" data-trial="2">
                    <h3 class="font-bold text-primary">ç¬¬ 2 æ¬¡æµ‹å®š</h3>
                    <div>
                        <label for="mass-2" class="block text-xs font-medium text-secondary mb-1">åŸºå‡†ç‰©è´¨é‡ m (g)</label>
                        <input type="number" id="mass-2" placeholder="è´¨é‡ (g)" min="0.001" step="0.0001" value=""
                               class="w-full rounded-lg p-2 border input-field" oninput="hideMessages()">
                    </div>
                    <div>
                        <label for="volume-2" class="block text-xs font-medium text-secondary mb-1">HCl æ¶ˆè€—ä½“ç§¯ (mL)</label>
                        <input type="number" id="volume-2" placeholder="ä½“ç§¯ (mL)" min="0.01" step="0.01" value=""
                               class="w-full rounded-lg p-2 border input-field" oninput="hideMessages()">
                    </div>
                </div>
                 <!-- Trial 3 -->
                <div class="p-4 rounded-lg border border-light bg-surface space-y-2" data-trial="3">
                    <h3 class="font-bold text-primary">ç¬¬ 3 æ¬¡æµ‹å®š</h3>
                    <div>
                        <label for="mass-3" class="block text-xs font-medium text-secondary mb-1">åŸºå‡†ç‰©è´¨é‡ m (g)</label>
                        <input type="number" id="mass-3" placeholder="è´¨é‡ (g)" min="0.001" step="0.0001" value=""
                               class="w-full rounded-lg p-2 border input-field" oninput="hideMessages()">
                    </div>
                    <div>
                        <label for="volume-3" class="block text-xs font-medium text-secondary mb-1">HCl æ¶ˆè€—ä½“ç§¯ (mL)</label>
                        <input type="number" id="volume-3" placeholder="ä½“ç§¯ (mL)" min="0.01" step="0.01" value=""
                               class="w-full rounded-lg p-2 border input-field" oninput="hideMessages()">
                    </div>
                </div>
            </div>
            
            <button id="calculate-standardization-btn" onclick="calculateStandardization()"
                    class="w-full flex justify-center py-3 px-4 rounded-lg shadow-lg text-lg calculate-button">
                è®¡ç®—å‡†ç¡®æ‘©å°”æµ“åº¦
            </button>
            
            <div id="standardization-result-box" class="mt-6 p-6 bg-surface rounded-lg border-2 border-[var(--accent-color)] hidden transition-colors duration-500">
                <h2 class="text-xl font-bold text-[var(--accent-color)] mb-4">æ ‡å®šç»“æœæ±‡æ€»</h2>
                <div id="standardization-results" class="space-y-4">
                    <table class="data-table w-full">
                        <thead>
                            <tr>
                                <th>æ¬¡æ•°</th>
                                <th>m (g)</th>
                                <th>V (mL)</th>
                                <th>C<sub>HCl</sub> (M)</th> 
                            </tr>
                        </thead>
                        <tbody id="standardization-data-body"></tbody>
                    </table>

                    <div class="flex flex-col sm:flex-row justify-between items-center bg-[var(--accent-bg)] p-3 rounded-lg font-semibold transition-colors duration-500">
                        <span class="text-primary text-lg">å¹³å‡æµ“åº¦ C<sub>HCl</sub> (M):</span> 
                        <!-- A5: ç‚¹å‡»å¤åˆ¶ -->
                        <span id="avg-concentration" class="text-[var(--accent-color)] text-3xl font-extrabold copyable-result" onclick="copyResult(this)">0.0000</span>
                    </div>
                    
                    <div class="p-2 rounded-lg border border-light text-primary text-sm space-y-2">
                        <div class="flex justify-between items-center">
                            <span>ç›¸å¯¹å¹³å‡åå·® (RSD):</span>
                            <span id="rsd-value" class="text-[var(--color-error)] font-bold">0.00%</span>
                        </div>
                         <div id="rsd-warning" class="hidden p-2 rounded-lg bg-red-100 text-[var(--color-error)] text-center font-semibold border border-[var(--color-error)]" role="alert">
                            âš ï¸ RSD è¶…å‡ºéªŒæ”¶æ ‡å‡†ï¼ˆ<span id="rsd-limit-display">0.00%</span>ï¼‰ï¼Œå®éªŒç²¾å¯†åº¦å¯èƒ½ä¸è¶³ã€‚
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-10 pt-6 border-t border-light transition-colors duration-500">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 space-y-2 sm:space-y-0">
                    <h2 class="section-title text-primary">æ ‡å®šå†å²è®°å½•</h2>
                    <div class="space-x-2">
                        <button onclick="exportCSV('standardization')"
                                class="px-3 py-1 bg-[#2ECC71] text-white rounded-lg hover:bg-[#25A764] text-sm font-medium transition duration-150 ease-in-out active-scale-98">
                            å¯¼å‡º CSV
                        </button>
                        <button onclick="clearHistory('standardization')"
                                class="px-3 py-1 bg-[var(--color-error)] text-white rounded-lg hover:filter hover:brightness-90 text-sm font-medium transition duration-150 ease-in-out active-scale-98">
                            æ¸…ç©ºè®°å½•
                        </button>
                    </div>
                </div>
                <div id="standardization-history-container" class="overflow-x-auto"></div>
            </div>
        </div>

        <div id="error-box" class="mt-6 p-4 accent-bg border border-[var(--color-error)] text-[var(--color-error)] rounded-lg hidden transition-colors duration-500">
            <p id="error-message" class="text-sm font-medium"></p>
        </div>

    </div>

    <script>
        // --- å¸¸é‡å®šä¹‰ (æ›´æ–° B3: å¤šç§åŸºå‡†ç‰©) ---
        const STANDARDS = {
            'Na2CO3': {
                name: 'æ— æ°´ç¢³é…¸é’ ',
                molarMass: 105.99,
                formulaDisplay: '2HCl ~ 1Na<sub>2</sub>CO<sub>3</sub>'
            },
            'Borax': {
                name: 'ç¡¼ç ‚ (Naâ‚‚Bâ‚„Oâ‚‡Â·10Hâ‚‚O)',
                molarMass: 381.37,
                formulaDisplay: '2HCl ~ 1Na<sub>2</sub>B<sub>4</sub>O<sub>7</sub>' // ç®€åŒ–æ˜¾ç¤ºï¼Œå®é™…ä¹Ÿæ˜¯ 2:1
            }
        };

        const STANDARD_CONC_MOLARITY = 12.063; 
        const STANDARD_DENSITY = 1.19;        
        const HCL_MOLAR_MASS = 36.46;          
        
        const DILUTION_HISTORY_KEY = 'hclDilutionHistory';
        const STANDARDIZATION_HISTORY_KEY = 'hclStandardizationHistory';
        const ACCENT_KEY = 'hclDilutionAccent';
        const MODE_KEY = 'hclDilutionMode';
        const ANIMATION_KEY = 'hclDilutionAnimation'; 
        const CUSTOM_CONC_KEY = 'hclDilutionCustomConc';
        const CUSTOM_RSD_KEY = 'hclStandardizationRSD';

        let dilutionHistory = []; 
        let standardizationHistory = [];
        let currentAccent = 'organic';
        let currentMode = 'dilution';
        let isAnimationEnabled = true; 
        
        let dilutionVolumeUnit = 'mL'; 
        let dilutionConcUnit = 'M';    
        
        // å½“å‰é€‰æ‹©çš„åŸºå‡†ç‰© key
        let currentStandardKey = 'Na2CO3';

        let floatingElements = [];
        let mouseX = 0;
        let mouseY = 0;
        const INTERACTION_RADIUS = 120; 
        const REPEL_FORCE = 30;

        const colorPalettes = {
            'organic': {
                name: 'æœ‰æœºæš–è‰²',
                light: { '--accent-color': '#8c7851', '--accent-bg': '#eaddcf', '--button-text': '#ffffff' },
                dark: { '--accent-color': '#b39f7a', '--accent-bg': '#2b2620', '--button-text': '#141414' }
            },
            'starry-night': {
                name: 'æ˜Ÿæœˆå¤œæ·±è‰²',
                light: { '--accent-color': '#1f488e', '--accent-bg': '#e6f0ff', '--button-text': '#ffffff' },
                dark: { '--accent-color': '#ffdf66', '--accent-bg': '#27497d', '--button-text': '#0a0a0a' }
            },
            'emerald': {
                name: 'ç¥–æ¯ç»¿',
                light: { '--accent-color': '#059669', '--accent-bg': '#ecfdf5', '--button-text': '#ffffff' },
                dark: { '--accent-color': '#34d399', '--accent-bg': '#102d24', '--button-text': '#0a0a0a' }
            },
            'violet': {
                name: 'ç´«ç½—å…°',
                light: { '--accent-color': '#8b5cf6', '--accent-bg': '#f3efff', '--button-text': '#ffffff' },
                dark: { '--accent-color': '#d8b4fe', '--accent-bg': '#2c1e45', '--button-text': '#0a0a0a' }
            }
        };

        function hexToRgb(hex) {
            let r = 0, g = 0, b = 0;
            if (hex.length === 4) {
                r = parseInt(hex[1] + hex[1], 16);
                g = parseInt(hex[2] + hex[2], 16);
                b = parseInt(hex[3] + hex[3], 16);
            } else if (hex.length === 7) {
                r = parseInt(hex[1] + hex[2], 16);
                g = parseInt(hex[3] + hex[4], 16);
                b = parseInt(hex[5] + hex[6], 16);
            }
            return `${r}, ${g}, ${b}`;
        }
        function applyTheme(accentName, modeName) {
            const palette = colorPalettes[accentName];
            if (!palette || !palette[modeName]) return;
            currentAccent = accentName;
            currentMode = modeName;
            const modePalette = palette[modeName];
            const root = document.documentElement;
            const body = document.body;
            body.setAttribute('data-mode', modeName);
            localStorage.setItem(MODE_KEY, modeName);
            for (const [key, value] of Object.entries(modePalette)) {
                root.style.setProperty(key, value);
            }
            const accentHex = modePalette['--accent-color'];
            root.style.setProperty('--accent-color-rgb', hexToRgb(accentHex));
            localStorage.setItem(ACCENT_KEY, accentName);
            updateModeButton(modeName);
            updateAccentButtons(accentName);
        }
        window.setAccent = function(accentName) {
            applyTheme(accentName, document.body.getAttribute('data-mode') === 'dark' ? 'dark' : 'light');
        }
        window.toggleMode = function() {
            const newMode = document.body.getAttribute('data-mode') === 'light' ? 'dark' : 'light';
            applyTheme(currentAccent, newMode);
        }
        function updateAccentButtons(activeAccent) {
            document.querySelectorAll('.theme-button').forEach(btn => {
                btn.classList.remove('active');
            });
            const targetButton = document.getElementById(`accent-${activeAccent}`);
            if (targetButton) {
                targetButton.classList.add('active');
            }
        }
        function updateModeButton(activeMode) {
            const modeText = document.getElementById('mode-text');
            modeText.textContent = activeMode === 'light' ? 'æµ…è‰²æ¨¡å¼' : 'æ·±è‰²æ¨¡å¼';
            document.body.setAttribute('data-mode', activeMode);
        }
        function updateAnimationButton(enabled) {
            const animationText = document.getElementById('animation-text');
            animationText.textContent = enabled ? 'å·²å¼€å¯' : 'å·²å…³é—­';
        }
        window.toggleAnimation = function() {
            isAnimationEnabled = !isAnimationEnabled;
            localStorage.setItem(ANIMATION_KEY, isAnimationEnabled);
            const root = document.documentElement;
            root.style.setProperty('--animation-state', isAnimationEnabled ? 'running' : 'paused');
            updateAnimationButton(isAnimationEnabled);
        }

        function createFloatingElements() { 
            const container = document.getElementById('floating-container');
            container.innerHTML = ''; 
            floatingElements = [];    
            const particleCount = 60; 
            const symbols = ['H', 'Cl', 'M', 'V', 'C', '+', '-', '=', 'Naâ‚‚COâ‚ƒ', 'HCl', 'T', 'V', 'Î¼', 'Ïƒ', 'Î”', 'RSD']; 
            for (let i = 0; i < particleCount; i++) {
                const element = document.createElement('div');
                element.classList.add('floating-element');
                element.textContent = symbols[Math.floor(Math.random() * symbols.length)];
                const size = Math.random() * 1.3 + 1.2; 
                element.style.fontSize = `${size}rem`;
                const initialX = Math.random() * 100;
                element.style.setProperty('--initial-x-offset', `${initialX}vw`);
                const duration = Math.random() * 20 + 20;
                element.style.animationDuration = `${duration}s`;
                const delay = Math.random() * -duration; 
                element.style.animationDelay = `${delay}s`;
                const elementData = { element: element, size: size };
                floatingElements.push(elementData);
                container.appendChild(element);
            }
        }

        function animateInteraction() { 
            document.documentElement.style.setProperty('--animation-state', isAnimationEnabled ? 'running' : 'paused');
            floatingElements.forEach(data => {
                const el = data.element;
                const rect = el.getBoundingClientRect();
                const elementCenterX = rect.left + rect.width / 2;
                const elementCenterY = rect.top + rect.height / 2;
                const dx = elementCenterX - mouseX;
                const dy = elementCenterY - mouseY;
                const distance = Math.sqrt(dx * dx + dy * dy);
                let repelX = 0;
                let repelY = 0;
                if (distance < INTERACTION_RADIUS) {
                    const strength = 1 - (distance / INTERACTION_RADIUS);
                    const angle = Math.atan2(dy, dx);
                    repelX = Math.cos(angle) * REPEL_FORCE * strength;
                    repelY = Math.sin(angle) * REPEL_FORCE * strength;
                    el.style.transform = `translate(${repelX}px, ${repelY}px)`; 
                    el.style.opacity = `${0.1 + strength * 0.15}`; 
                } else {
                    el.style.opacity = `0.1`;
                    el.style.transform = `translate(0px, 0px)`; 
                }
            });
            requestAnimationFrame(animateInteraction);
        }

        window.setMode = function(modeName) {
            currentMode = modeName;
            localStorage.setItem(MODE_KEY, modeName);
            document.getElementById('view-dilution').classList.add('hidden');
            document.getElementById('view-standardization').classList.add('hidden');
            document.getElementById(`view-${modeName}`).classList.remove('hidden');
            document.getElementById('tab-dilution').classList.remove('active-mode');
            document.getElementById('tab-standardization').classList.remove('active-mode');
            document.getElementById(`tab-${modeName}`).classList.add('active-mode');
            hideMessages(true); 
            if (modeName === 'dilution' && standardizationHistory.length > 0) {
                const latestRecord = standardizationHistory[0];
                const avgConc = latestRecord.avgConcentration;
                if (avgConc) {
                    document.getElementById('target-concentration').value = avgConc.toFixed(4);
                    toggleDilutionUnit('conc', 'M');
                }
            }
        }

        function hideMessages(clearResults = false) {
            document.getElementById('dilution-result-box').classList.add('hidden');
            document.getElementById('standardization-result-box').classList.add('hidden');
            document.getElementById('error-box').classList.add('hidden');
            if (clearResults) {
                 document.getElementById('required-volume').textContent = '0.00';
                 document.getElementById('avg-concentration').textContent = '0.0000';
                 document.getElementById('rsd-value').textContent = '0.00%';
                 document.getElementById('rsd-warning').classList.add('hidden');
            }
        }

        function showError(message) {
            hideMessages(false);
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-box').classList.remove('hidden');
        }
        
        window.toggleDilutionUnit = function(type, unit) {
            hideMessages(true); 
            if (type === 'volume') {
                dilutionVolumeUnit = unit;
                document.getElementById('V_dilute_unit').value = unit;
                document.getElementById('volume-unit-mL').classList.toggle('inactive', unit === 'L');
                document.getElementById('volume-unit-L').classList.toggle('inactive', unit === 'mL');
            } else if (type === 'conc') {
                dilutionConcUnit = unit;
                document.getElementById('C_dilute_unit').value = unit;
                document.getElementById('conc-unit-M').classList.toggle('inactive', unit === 'W');
                document.getElementById('conc-unit-W').classList.toggle('inactive', unit === 'M');
                document.getElementById('target-density-group').style.display = (unit === 'W' ? 'block' : 'none');
                
                // åˆ‡æ¢å•ä½æ—¶é‡æ–°è§¦å‘æ ¡éªŒï¼Œè¿™ä¼šè¿å¸¦è§¦å‘å¯†åº¦ä¼°ç®—
                validateDilutionInputs();
            }
        }

        function loadHistory() {
            const storedDilution = localStorage.getItem(DILUTION_HISTORY_KEY);
            dilutionHistory = storedDilution ? JSON.parse(storedDilution) : [];
            const storedStandardization = localStorage.getItem(STANDARDIZATION_HISTORY_KEY);
            standardizationHistory = storedStandardization ? JSON.parse(storedStandardization) : [];
            renderHistory(currentMode);
        }

        function saveHistory(mode) {
            if (mode === 'dilution') {
                localStorage.setItem(DILUTION_HISTORY_KEY, JSON.stringify(dilutionHistory));
            } else if (mode === 'standardization') {
                localStorage.setItem(STANDARDIZATION_HISTORY_KEY, JSON.stringify(standardizationHistory));
            }
            renderHistory(mode);
        }
        
        window.resetConcentration = function() {
            document.getElementById('conc-molarity-input').value = STANDARD_CONC_MOLARITY.toFixed(3);
            document.getElementById('conc-density-input').value = STANDARD_DENSITY.toFixed(3);
            localStorage.removeItem(CUSTOM_CONC_KEY);
            hideMessages(true); 
            validateDilutionInputs(); // è§¦å‘æ ¡éªŒ
        }
        
        function convertConcentration(value, fromUnit, toUnit, density) {
            if (fromUnit === toUnit) return value;
            if (fromUnit === 'M' && toUnit === 'W') { 
                return (value * HCL_MOLAR_MASS / 1000 / density) * 100;
            } else if (fromUnit === 'W' && toUnit === 'M') { 
                return (value / 100 * density * 1000) / HCL_MOLAR_MASS;
            }
            return value;
        }
        
        // --- A4 + æ™ºèƒ½ä¼°ç®—: å®æ—¶è¾“å…¥æ ¡éªŒä¸å¯†åº¦ä¼°ç®— ---
        window.validateDilutionInputs = function() {
            hideMessages(); // éšè—ä¹‹å‰çš„ç»“æœ
            
            const warningEl = document.getElementById('dilution-warning-text');
            const C_conc_input = parseFloat(document.getElementById('conc-molarity-input').value);
            const D_conc = parseFloat(document.getElementById('conc-density-input').value);
            const C_dilute_input_val = parseFloat(document.getElementById('target-concentration').value);
            // æ³¨æ„ï¼šè¿™é‡Œå…ˆè·å– DOM å…ƒç´ ï¼Œä¸æ€¥ç€è·å– valueï¼Œå› ä¸ºå¯èƒ½éœ€è¦è‡ªåŠ¨å¡«å…¥
            const densityInput = document.getElementById('target-density');
            let D_dilute = parseFloat(densityInput.value);
            const C_unit = document.getElementById('C_dilute_unit').value;
            const autoDensityBadge = document.getElementById('auto-density-badge');

            // æ™ºèƒ½å¯†åº¦ä¼°ç®—é€»è¾‘ (Phase 3)
            if (C_unit === 'W' && !isNaN(C_dilute_input_val) && C_dilute_input_val > 0) {
                 // ç®€å•çš„ HCl å¯†åº¦ä¼°ç®—å…¬å¼: rho â‰ˆ 1 + 0.005 * w% (ç»éªŒå…¬å¼)
                const estimatedRho = 1 + (C_dilute_input_val * 0.005);
                
                // ç­–ç•¥ï¼šå¦‚æœå½“å‰å¯†åº¦æ¡†æ²¡æœ‰ç„¦ç‚¹ï¼ˆç”¨æˆ·ä¸åœ¨æ‰‹åŠ¨æ”¹ï¼‰ï¼Œåˆ™è‡ªåŠ¨å¡«å…¥
                if (document.activeElement !== densityInput) {
                    densityInput.value = estimatedRho.toFixed(3);
                    D_dilute = estimatedRho; // æ›´æ–°å½“å‰é€»è¾‘ç”¨çš„å˜é‡
                    autoDensityBadge.style.display = 'inline'; // æ˜¾ç¤ºè‡ªåŠ¨æ ‡è®°
                }
            } else {
                 autoDensityBadge.style.display = 'none';
            }

            if (isNaN(C_conc_input) || isNaN(C_dilute_input_val)) {
                warningEl.classList.add('hidden');
                return;
            }

            let C_dilute_M;
            let isValid = true;

            if (C_unit === 'W') {
                if (isNaN(D_dilute) || D_dilute <= 0) return; // å¯†åº¦æ— æ•ˆä¸æ ¡éªŒ
                C_dilute_M = convertConcentration(C_dilute_input_val, 'W', 'M', D_dilute);
            } else {
                C_dilute_M = C_dilute_input_val;
            }
            
            // ç®€å•æ ¡éªŒï¼šç¨€é‡Šåæ‘©å°”æµ“åº¦ä¸èƒ½å¤§äºåŸæ¶²
            if (C_dilute_M >= C_conc_input) {
                isValid = false;
            }

            if (!isValid) {
                warningEl.classList.remove('hidden');
            } else {
                warningEl.classList.add('hidden');
            }
        }

        window.calculateDilution = function() {
            hideMessages(false);
            
            const C_conc_input = document.getElementById('conc-molarity-input').value;
            const D_conc = parseFloat(document.getElementById('conc-density-input').value);
            const V_dilute_input = document.getElementById('target-volume').value;
            const C_dilute_input = document.getElementById('target-concentration').value;
            const D_dilute = parseFloat(document.getElementById('target-density').value);
            const V_unit = document.getElementById('V_dilute_unit').value;
            const C_unit = document.getElementById('C_dilute_unit').value;

            if (isNaN(D_conc) || D_conc <= 0) return showError('è¯·è¾“å…¥æœ‰æ•ˆçš„æµ“ç›é…¸å¯†åº¦ï¼ˆDæµ“ï¼‰ï¼Œå¿…é¡»å¤§äº 0ã€‚');
            if (isNaN(C_conc_input) || parseFloat(C_conc_input) <= 0) return showError('è¯·è¾“å…¥æœ‰æ•ˆçš„æµ“ç›é…¸æµ“åº¦ï¼ˆCæµ“ï¼‰ï¼Œå¿…é¡»å¤§äº 0ã€‚');
            if (isNaN(V_dilute_input) || parseFloat(V_dilute_input) <= 0) return showError('è¯·è¾“å…¥æœ‰æ•ˆçš„ç¨€é‡Šåä½“ç§¯ï¼ˆVç¨€ï¼‰ï¼Œå¿…é¡»å¤§äº 0ã€‚');
            if (isNaN(C_dilute_input) || parseFloat(C_dilute_input) <= 0) return showError('è¯·è¾“å…¥æœ‰æ•ˆçš„ç¨€é‡Šåæµ“åº¦ï¼ˆCç¨€ï¼‰ï¼Œå¿…é¡»å¤§äº 0ã€‚');
            if (C_unit === 'W' && (isNaN(D_dilute) || D_dilute <= 0)) return showError('é€‰æ‹©è´¨é‡ç™¾åˆ†æ¯”æµ“åº¦æ—¶ï¼Œå¿…é¡»è¾“å…¥æœ‰æ•ˆçš„ç¨€é‡Šåå¯†åº¦ï¼ˆDç¨€ï¼‰ã€‚');
            
            const C_conc_M = parseFloat(C_conc_input); 
            const C_dilute_input_val = parseFloat(C_dilute_input); 
            const V_dilute_input_val = parseFloat(V_dilute_input); 
            
            let C_dilute_M;
            if (C_unit === 'W') {
                C_dilute_M = convertConcentration(C_dilute_input_val, 'W', 'M', D_dilute);
                const C_conc_W = convertConcentration(C_conc_M, 'M', 'W', D_conc);
                if (C_dilute_input_val >= C_conc_W) return showError(`ç›®æ ‡ç¨€é‡Šæµ“åº¦ (${C_dilute_input_val.toFixed(2)} %w/w) å¿…é¡»ä½äºå½“å‰æµ“ç›é…¸çš„æµ“åº¦ (${C_conc_W.toFixed(2)} %w/w)ã€‚`); 
            } else {
                C_dilute_M = C_dilute_input_val;
                if (C_dilute_M >= C_conc_M) return showError(`ç›®æ ‡ç¨€é‡Šæµ“åº¦ (${C_dilute_M.toFixed(3)} M) å¿…é¡»ä½äºå½“å‰è®¾ç½®çš„æµ“ç›é…¸æµ“åº¦ (${C_conc_M.toFixed(3)} M)ã€‚`); 
            }

            let V_dilute_mL = (V_unit === 'L') ? V_dilute_input_val * 1000 : V_dilute_input_val;
            const V_conc = (C_dilute_M * V_dilute_mL) / C_conc_M;

            document.getElementById('required-volume').textContent = V_conc.toFixed(3);
            document.getElementById('required-volume-unit').textContent = 'mL'; 
            document.getElementById('dilution-result-box').classList.remove('hidden');
            
            const record = {
                date: new Date().toISOString(),
                C_conc: C_conc_M,
                V_dilute: V_dilute_input_val, 
                V_unit: V_unit,
                C_dilute: C_dilute_input_val, 
                C_unit: C_unit,
                V_conc: V_conc 
            };
            dilutionHistory.unshift(record);
            saveHistory('dilution');
        }

        // --- B3: æ›´æ–°åŸºå‡†ç‰© ---
        window.updateStandardSubstance = function() {
            const select = document.getElementById('standard-substance');
            currentStandardKey = select.value;
            const standard = STANDARDS[currentStandardKey];
            
            document.getElementById('stoich-display').innerHTML = standard.formulaDisplay;
            document.getElementById('molar-mass-standard').value = standard.molarMass.toFixed(2);
            
            hideMessages(true);
        }

        window.resetMolarMass = function() {
            // é‡ç½®ä¸ºå½“å‰é€‰ä¸­åŸºå‡†ç‰©çš„é»˜è®¤è´¨é‡
            document.getElementById('molar-mass-standard').value = STANDARDS[currentStandardKey].molarMass.toFixed(2);
            document.getElementById('rsd-limit').value = '0.20';
            localStorage.removeItem(CUSTOM_RSD_KEY);
            hideMessages(true);
        }

        window.calculateStandardization = function() {
            hideMessages(false); 
            
            const M_standard = parseFloat(document.getElementById('molar-mass-standard').value);
            const RSD_limit = parseFloat(document.getElementById('rsd-limit').value); 

            if (isNaN(M_standard) || M_standard <= 0) return showError('è¯·è¾“å…¥æœ‰æ•ˆçš„åŸºå‡†ç‰©æ‘©å°”è´¨é‡ï¼Œå¿…é¡»å¤§äº 0ã€‚');
            if (isNaN(RSD_limit) || RSD_limit <= 0) return showError('è¯·è¾“å…¥æœ‰æ•ˆçš„ RSD éªŒæ”¶æ ‡å‡†ï¼Œå¿…é¡»å¤§äº 0ã€‚');
            
            localStorage.setItem(CUSTOM_RSD_KEY, RSD_limit);

            const trials = [];
            for (let i = 1; i <= 3; i++) {
                const massInput = document.getElementById(`mass-${i}`).value;
                const volumeInput = document.getElementById(`volume-${i}`).value;
                const mass = parseFloat(massInput);
                const volume = parseFloat(volumeInput);

                if ((!massInput && !volumeInput) || (isNaN(mass) && isNaN(volume))) continue; 
                if (isNaN(mass) || mass <= 0) return showError(`ç¬¬ ${i} æ¬¡æµ‹å®š: è´¨é‡è¾“å…¥æ— æ•ˆ (å¿…é¡» > 0)ã€‚`);
                if (isNaN(volume) || volume <= 0) return showError(`ç¬¬ ${i} æ¬¡æµ‹å®š: ä½“ç§¯è¾“å…¥æ— æ•ˆ (å¿…é¡» > 0)ã€‚`);
                
                // å…¬å¼ï¼š C_HCl = (2 * mass) / (M * V * 10^-3)
                // æ³¨æ„ï¼šNa2CO3 å’Œ Borax ä¸ HCl ååº”åŒ–å­¦è®¡é‡å‡ä¸º 2:1
                const concentration = (2 * mass) / (M_standard * volume * 0.001);

                trials.push({ id: i, mass: mass, volume: volume, concentration: concentration });
            }

            if (trials.length < 2) return showError('è‡³å°‘éœ€è¦ 2 ç»„æœ‰æ•ˆæ•°æ®æ‰èƒ½è®¡ç®—å¹³å‡æµ“åº¦å’Œåå·®ã€‚');

            const sumC = trials.reduce((sum, t) => sum + t.concentration, 0);
            const avgConcentration = sumC / trials.length;
            const sumDev = trials.reduce((sum, t) => sum + Math.abs(t.concentration - avgConcentration), 0);
            const avgDeviation = sumDev / trials.length;
            const RSD = (avgDeviation / avgConcentration) * 100;

            renderStandardizationResults(trials, avgConcentration, RSD, RSD_limit); 

            const record = {
                date: new Date().toISOString(),
                standard: STANDARDS[currentStandardKey].name, // è®°å½•ä½¿ç”¨çš„åŸºå‡†ç‰©
                M_standard: M_standard,
                trials: trials,
                avgConcentration: avgConcentration,
                RSD: RSD,
                RSD_limit: RSD_limit 
            };
            standardizationHistory.unshift(record);
            saveHistory('standardization');
        }

        function renderStandardizationResults(trials, avgConcentration, RSD, RSD_limit) {
            let bodyHtml = '';
            trials.forEach(t => {
                bodyHtml += `
                    <tr>
                        <td>${t.id}</td>
                        <td>${t.mass.toFixed(4)}</td>
                        <td>${t.volume.toFixed(2)}</td>
                        <td class="font-medium text-primary">${t.concentration.toFixed(4)}</td>
                    </tr>
                `;
            });

            document.getElementById('standardization-data-body').innerHTML = bodyHtml;
            document.getElementById('avg-concentration').textContent = avgConcentration.toFixed(4);
            document.getElementById('rsd-value').textContent = `${RSD.toFixed(2)}%`;
            
            const rsdWarning = document.getElementById('rsd-warning');
            const rsdLimitDisplay = document.getElementById('rsd-limit-display');
            rsdLimitDisplay.textContent = `${RSD_limit.toFixed(2)}%`;
            
            if (RSD > RSD_limit) {
                rsdWarning.classList.remove('hidden');
                document.getElementById('rsd-value').style.color = 'var(--color-error)'; 
            } else {
                rsdWarning.classList.add('hidden');
                 document.getElementById('rsd-value').style.color = 'var(--accent-color)'; 
            }
            
            document.getElementById('standardization-result-box').classList.remove('hidden');
        }
        
        function renderHistory(mode) {
            if (mode === 'dilution') {
                renderDilutionHistory();
            } else if (mode === 'standardization') {
                renderStandardizationHistory();
            }
        }
        
        function renderDilutionHistory() {
            const container = document.getElementById('dilution-history-container');
            if (dilutionHistory.length === 0) {
                container.innerHTML = `<p class="text-center text-secondary py-4 transition-colors duration-500">æš‚æ— ç¨€é‡Šé…åˆ¶è®°å½•ã€‚</p>`;
                return;
            }
            let html = `
                <table class="history-table text-sm">
                    <thead>
                        <tr>
                            <th>æ—¶é—´</th>
                            <th>C<sub>æµ“</sub> (M)</th>
                            <th>V<sub>ç¨€</sub></th>
                            <th>C<sub>ç¨€</sub></th>
                            <th>V<sub>æµ“</sub> (mL)</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            dilutionHistory.forEach((record, index) => {
                const date = new Date(record.date).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                const V_dilute_display = `${record.V_dilute.toFixed(1)} ${record.V_unit}`;
                const C_dilute_display = `${record.C_dilute.toFixed(3)} ${record.C_unit}`;
                
                html += `
                    <tr class="hover:bg-accent-bg hover:opacity-70 transition-colors duration-300">
                        <td>${date}</td>
                        <td>${record.C_conc.toFixed(3)} M</td>
                        <td>${V_dilute_display}</td>
                        <td>${C_dilute_display}</td>
                        <td class="font-bold text-[var(--accent-color)]">${record.V_conc.toFixed(3)}</td>
                        <td>
                            <button onclick="deleteRecord('dilution', ${index})"
                                class="text-[var(--color-error)] hover:opacity-80 transition duration-150 active-scale-98">
                                åˆ é™¤
                            </button>
                        </td>
                    </tr>
                `;
            });
            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        function renderStandardizationHistory() {
            const container = document.getElementById('standardization-history-container');
            if (standardizationHistory.length === 0) {
                container.innerHTML = `<p class="text-center text-secondary py-4 transition-colors duration-500">æš‚æ— æµ“åº¦æ ‡å®šè®°å½•ã€‚</p>`;
                return;
            }
            
            const getTrialData = (record, trialIndex) => {
                const trial = record.trials[trialIndex];
                if (trial) {
                    return {
                        mass: trial.mass.toFixed(4),
                        volume: trial.volume.toFixed(2),
                        concentration: trial.concentration.toFixed(4)
                    };
                }
                return { mass: '-', volume: '-', concentration: '-' };
            };
            
            let html = `
                <table class="history-table text-xs">
                    <thead>
                        <tr>
                            <th rowspan="2">æ—¶é—´</th>
                            <th rowspan="2">åŸºå‡†ç‰©</th>
                            <th rowspan="2">å¹³å‡ C<sub>HCl</sub> (M)</th>
                            <th rowspan="2">RSD (%)</th>
                            <th colspan="3" class="border-b-2">ç¬¬ 1 æ¬¡æµ‹å®š</th>
                            <th colspan="3" class="border-b-2">ç¬¬ 2 æ¬¡æµ‹å®š</th>
                            <th colspan="3" class="border-b-2">ç¬¬ 3 æ¬¡æµ‹å®š</th>
                            <th rowspan="2">æ“ä½œ</th>
                        </tr>
                        <tr>
                            <th>m</th><th>V</th><th>C</th>
                            <th>m</th><th>V</th><th>C</th>
                            <th>m</th><th>V</th><th>C</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            standardizationHistory.forEach((record, index) => {
                const date = new Date(record.date).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                const trial1 = getTrialData(record, 0);
                const trial2 = getTrialData(record, 1);
                const trial3 = getTrialData(record, 2);
                const rsdColor = (record.RSD > record.RSD_limit) ? 'text-[var(--color-error)]' : 'text-[var(--accent-color)]';
                // å…¼å®¹æ—§æ•°æ®ï¼šå¦‚æœ record.standard ä¸å­˜åœ¨ï¼Œé»˜è®¤ä¸º Na2CO3
                const standardName = record.standard ? record.standard : 'Naâ‚‚COâ‚ƒ';

                html += `
                    <tr class="hover:bg-accent-bg hover:opacity-70 transition-colors duration-300">
                        <td>${date}</td>
                        <td class="text-xs">${standardName}</td>
                        <td class="font-bold text-[var(--accent-color)]">${record.avgConcentration.toFixed(4)}</td>
                        <td class="${rsdColor}">${record.RSD.toFixed(2)}</td>

                        <td class="whitespace-nowrap">${trial1.mass}</td>
                        <td class="whitespace-nowrap">${trial1.volume}</td>
                        <td class="whitespace-nowrap">${trial1.concentration}</td>

                        <td class="whitespace-nowrap">${trial2.mass}</td>
                        <td class="whitespace-nowrap">${trial2.volume}</td>
                        <td class="whitespace-nowrap">${trial2.concentration}</td>

                        <td class="whitespace-nowrap">${trial3.mass}</td>
                        <td class="whitespace-nowrap">${trial3.volume}</td>
                        <td class="whitespace-nowrap">${trial3.concentration}</td>

                        <td>
                            <button onclick="deleteRecord('standardization', ${index})"
                                class="text-[var(--color-error)] hover:opacity-80 transition duration-150 active-scale-98">
                                åˆ é™¤
                            </button>
                        </td>
                    </tr>
                `;
            });
            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        window.deleteRecord = function(mode, index) {
            if (mode === 'dilution') {
                dilutionHistory.splice(index, 1);
            } else if (mode === 'standardization') {
                standardizationHistory.splice(index, 1);
            }
            saveHistory(mode);
            hideMessages(true);
        }

        window.exportCSV = function(mode) {
            let historyData, filename, headers;
            if (mode === 'dilution') {
                historyData = dilutionHistory;
                filename = 'HCl_Dilution_History';
                headers = "æ—¶é—´,æµ“ç›é…¸æµ“åº¦ Cæµ“ (M),ç¨€é‡Šåä½“ç§¯ Vç¨€ (åŸå§‹å€¼),Vç¨€ å•ä½,ç›®æ ‡æµ“åº¦ Cç¨€ (åŸå§‹å€¼),Cç¨€ å•ä½,æ‰€éœ€æµ“ç›é…¸ä½“ç§¯ Væµ“ (mL)\n";
            } else if (mode === 'standardization') {
                historyData = standardizationHistory;
                filename = 'HCl_Standardization_History';
                headers = "æ—¶é—´,åŸºå‡†ç‰©,å¹³å‡ C_HCl (M),RSD (%),RSD é™åˆ¶ (%),";
                for(let i = 1; i <= 3; i++) {
                    headers += `æµ‹å®š${i}-m (g),æµ‹å®š${i}-V (mL),æµ‹å®š${i}-C (M),`;
                }
                headers = headers.slice(0, -1) + "\n"; 
            } else {
                return showError("æ— æ•ˆçš„å¯¼å‡ºæ¨¡å¼ã€‚");
            }
            
            if (historyData.length === 0) return showError("æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®ï¼");
            
            let csvContent = headers;
            historyData.forEach(record => {
                const dateString = new Date(record.date).toLocaleString('zh-CN');
                let row = [`"${dateString}"`];

                if (mode === 'dilution') {
                    row.push(
                        record.C_conc.toFixed(3), 
                        record.V_dilute.toFixed(3), record.V_unit, 
                        record.C_dilute.toFixed(4), record.C_unit, 
                        record.V_conc.toFixed(3)
                    );
                } else if (mode === 'standardization') {
                    const standardName = record.standard ? record.standard : 'Naâ‚‚COâ‚ƒ';
                    row.push(standardName, record.avgConcentration.toFixed(4), record.RSD.toFixed(2), record.RSD_limit.toFixed(2));
                    for (let i = 0; i < 3; i++) {
                        const trial = record.trials[i] || {};
                        row.push(
                            trial.mass ? trial.mass.toFixed(4) : '', 
                            trial.volume ? trial.volume.toFixed(2) : '', 
                            trial.concentration ? trial.concentration.toFixed(4) : ''
                        );
                    }
                }
                csvContent += row.join(",") + "\n";
            });

            const BOM = "\ufeff";
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', filename + '_' + new Date().toISOString().substring(0, 10) + '.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link); 
            URL.revokeObjectURL(url); 
        }

        // --- A5: å¤åˆ¶åŠŸèƒ½ (é€‚ç”¨äºç§»åŠ¨ç«¯å’Œæ¡Œé¢ç«¯) ---
        window.copyResult = function(element) {
            const text = element.innerText;
            // åˆ›å»ºä¸€ä¸ªä¸´æ—¶ textarea å…ƒç´ ï¼Œè¿™åœ¨å¤šæ•°æµè§ˆå™¨å…¼å®¹æ€§æœ€å¥½
            const el = document.createElement('textarea');
            el.value = text;
            el.setAttribute('readonly', '');
            el.style.position = 'absolute';
            el.style.left = '-9999px';
            document.body.appendChild(el);
            
            const selected =  document.getSelection().rangeCount > 0 ? document.getSelection().getRangeAt(0) : false;
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            
            if (selected) {
                document.getSelection().removeAllRanges();
                document.getSelection().addRange(selected);
            }
            
            // æ˜¾ç¤º Toast
            const toast = document.getElementById('toast-notification');
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }

        document.addEventListener('DOMContentLoaded', () => {
            // åˆå§‹åŒ–è®¾ç½®
            document.getElementById('conc-molarity-input').value = STANDARD_CONC_MOLARITY.toFixed(3);
            document.getElementById('conc-density-input').value = STANDARD_DENSITY.toFixed(3);
            // é»˜è®¤åŸºå‡†ç‰©
            updateStandardSubstance();
            document.getElementById('rsd-limit').value = '0.20'; 
            
            // åŠ è½½æœ¬åœ°å­˜å‚¨é…ç½®
            const savedConc = localStorage.getItem(CUSTOM_CONC_KEY);
            if (savedConc) document.getElementById('conc-molarity-input').value = parseFloat(savedConc).toFixed(3);
             const savedRSD = localStorage.getItem(CUSTOM_RSD_KEY);
            if (savedRSD) document.getElementById('rsd-limit').value = parseFloat(savedRSD).toFixed(2);
            
            // ç»‘å®šäº‹ä»¶ç›‘å¬
            document.getElementById('conc-molarity-input').addEventListener('input', (e) => {
                const val = parseFloat(e.target.value);
                if (!isNaN(val) && val > 0) localStorage.setItem(CUSTOM_CONC_KEY, val);
                validateDilutionInputs();
            });
            document.getElementById('conc-density-input').addEventListener('input', () => validateDilutionInputs());
            document.getElementById('rsd-limit').addEventListener('input', (e) => {
                 const val = parseFloat(e.target.value);
                if (!isNaN(val) && val > 0) localStorage.setItem(CUSTOM_RSD_KEY, val);
                hideMessages(true);
            });

            loadHistory(); 

            let savedAccent = localStorage.getItem(ACCENT_KEY) || 'organic';
            let savedMode = localStorage.getItem(MODE_KEY) || 'dilution';
            let savedAnim = localStorage.getItem(ANIMATION_KEY);
            isAnimationEnabled = (savedAnim === null || savedAnim === 'true'); 
            
            if (!colorPalettes[savedAccent]) savedAccent = 'organic';
            if (savedMode !== 'dilution' && savedMode !== 'standardization') savedMode = 'dilution';
            
            applyTheme(savedAccent, localStorage.getItem(MODE_KEY) || 
                       (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'));
            setMode(savedMode);

            toggleDilutionUnit('volume', 'mL');
            toggleDilutionUnit('conc', 'M');
            
            createFloatingElements();
            animateInteraction(); 
            
            document.addEventListener('mousemove', (e) => {
                mouseX = e.clientX;
                mouseY = e.clientY;
            });
            
            // å›è½¦é”®æ”¯æŒ
            const volInput = document.getElementById('target-volume');
            const concInput = document.getElementById('target-concentration');
            const dilutionBtn = document.getElementById('calculate-dilution-btn');
            if (volInput) volInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') concInput.focus(); });
            if (concInput) concInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') dilutionBtn.click(); });
        });
        
        // --- Phase 4: Mobile Swipe Support ---
        let touchStartX = 0;
        let touchStartY = 0;
        
        // Use passive listeners to ensure scrolling performance isn't affected
        document.addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].screenX;
            touchStartY = e.changedTouches[0].screenY;
        }, { passive: true });
        
        document.addEventListener('touchend', (e) => {
            const touchEndX = e.changedTouches[0].screenX;
            const touchEndY = e.changedTouches[0].screenY;
            handleSwipe(touchStartX, touchStartY, touchEndX, touchEndY);
        }, { passive: true });
        
        function handleSwipe(startX, startY, endX, endY) {
            const diffX = endX - startX;
            const diffY = endY - startY;
            
            // Thresholds: Min distance 60px, Horizontal dominant
            if (Math.abs(diffX) > 60 && Math.abs(diffX) > Math.abs(diffY) * 1.5) {
                if (diffX > 0) {
                    // Swipe Right -> Go to Left Tab (Dilution)
                    if (currentMode !== 'dilution') setMode('dilution');
                } else {
                    // Swipe Left -> Go to Right Tab (Standardization)
                    if (currentMode !== 'standardization') setMode('standardization');
                }
            }
        }

    </script>
</body>
</html>