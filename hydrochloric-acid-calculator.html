<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é«˜çº§åŒ–å­¦è®¡ç®—å™¨ - ç¨€é‡Šä¸æ ‡å®š</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            --bg-canvas: #f0f5f9;
            --bg-surface: #ffffff;
            --text-primary: #1a1a1a;
            --text-secondary: #6b7280;
            --accent-color: #8c7851;
            --accent-bg: #eaddcf;
            --accent-hover: #7a6845;
            --color-error: #f04c4c;
            --border-light: #e0e0e0;
            --button-text: #ffffff;
            --accent-color-rgb: 140, 120, 81;
            --animation-state: running;
        }

        body {
            background-color: var(--bg-canvas);
            transition: background-color 0.5s ease, color 0.5s ease;
            background-image: radial-gradient(circle at 50% 10%, rgba(var(--accent-color-rgb), 0.07) 0%, var(--bg-canvas) 50%);
            background-size: cover;
            background-attachment: fixed;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 1.5rem 0;
            box-sizing: border-box;
            overflow-x: hidden;
        }
        
        .main-calculator-card {
            position: relative;
            z-index: 10; 
            width: 90%;
            max-width: 700px;
            margin: 0;
            margin-bottom: 4rem; 
            overflow: hidden;
            padding: 0; 
            display: flex;
            flex-direction: column;
        }

        /* --- æ ¸å¿ƒæ»‘åŠ¨å®¹å™¨ --- */
        .views-viewport {
            width: 100%;
            overflow: hidden;
            transition: height 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            position: relative;
        }

        .views-track {
            display: flex;
            width: 200%; 
            transition: transform 0.5s cubic-bezier(0.22, 1, 0.36, 1);
            align-items: flex-start; 
        }

        .single-view {
            width: 50%;
            flex-shrink: 0;
            box-sizing: border-box;
            padding: 2rem; 
        }
        
        @media (max-width: 640px) {
            .single-view { padding: 1.25rem; }
        }

        /* --- åŠ¨ç”» --- */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-stagger-enter {
            animation: fadeInUp 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
            opacity: 0;
        }
        .delay-100 { animation-delay: 0.05s; }
        .delay-200 { animation-delay: 0.1s; }
        .delay-300 { animation-delay: 0.15s; }
        .delay-400 { animation-delay: 0.2s; }

        /* --- èƒŒæ™¯ç²’å­ --- */
        #floating-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            overflow: hidden; pointer-events: none; z-index: 0;
        }
        .floating-element {
            position: absolute; top: 0; left: var(--initial-x-offset);
            color: var(--accent-color); opacity: 0.15; font-weight: 700;
            white-space: nowrap; animation: waterfall linear infinite;
            animation-play-state: var(--animation-state); -webkit-user-select: none; -moz-user-select: none; user-select: none;
            font-family: 'Times New Roman', serif; 
        }
        @keyframes waterfall { 0% { transform: translateY(-100vh) rotate(0deg); } 100% { transform: translateY(200vh) rotate(360deg); } }
        
        /* --- æ·±è‰²æ¨¡å¼ --- */
        body[data-mode="dark"] {
            --bg-canvas: #0a0a0a; --bg-surface: #141414; --text-primary: #ffffff;
            --text-secondary: #a8b9d9; --color-error: #ff7f7f; --border-light: #333333;
            --button-text: #0a0a0a;
            --accent-hover: #d4c095;
             background-image: radial-gradient(circle at 50% 10%, rgba(var(--accent-color-rgb), 0.15) 0%, var(--bg-canvas) 50%);
        }
        .bg-surface { background-color: var(--bg-surface); }
        .text-primary { color: var(--text-primary); }
        .text-secondary { color: var(--text-secondary); }
        .border-light { border-color: var(--border-light); }
        .accent-bg { background-color: var(--accent-bg); }
        
        /* --- ç»„ä»¶æ ·å¼ --- */
        .input-field {
            border-color: var(--border-light); color: var(--text-primary); background-color: var(--bg-surface);
            transition: all 0.3s;
        }
        .input-field:focus {
            border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(var(--accent-color-rgb), 0.3); outline: none;
        }
        .input-field.error-border {
            border-color: var(--color-error) !important;
            background-color: rgba(240, 76, 76, 0.05);
        }
        
        .calculate-button {
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--accent-hover) 100%);
            color: var(--button-text);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 700;
            position: relative;
            overflow: hidden;
            border: none;
        }
        .calculate-button::after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.1); opacity: 0; transition: opacity 0.3s;
        }
        .calculate-button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(var(--accent-color-rgb), 0.4); }
        .calculate-button:hover::after { opacity: 1; }
        .calculate-button:active { transform: translateY(1px); box-shadow: 0 2px 10px rgba(var(--accent-color-rgb), 0.3); }

        .unit-toggle-btn {
            background-color: var(--bg-surface); color: var(--accent-color); border: 1px solid var(--border-light);
            font-weight: 600; transition: all 0.2s;
        }
        .unit-toggle-btn:hover { background-color: var(--accent-bg); border-color: var(--accent-color); }
        .unit-toggle-btn.active-unit {
            background-color: var(--accent-color); color: var(--button-text); border-color: var(--accent-color);
            box-shadow: 0 2px 8px rgba(var(--accent-color-rgb), 0.3);
        }

        .action-btn { transition: all 0.2s; opacity: 0.9; }
        .action-btn:hover { opacity: 1; transform: scale(1.05); }
        .action-btn:active { transform: scale(0.95); }

        #mode-selector {
            position: relative; z-index: 50; display: flex; flex-direction: row;
            width: 90%; max-width: 500px; margin-bottom: 1.5rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); border-radius: 12px;
            overflow: hidden; transition: all 0.5s ease-out;
        }
        .mode-tab {
            width: 50%; padding: 12px 8px; cursor: pointer; text-align: center; font-weight: 600; font-size: 0.9rem;
            color: var(--text-secondary); background-color: var(--bg-surface); transition: all 0.3s ease-in-out;
            border-right: 1px solid var(--border-light); border-bottom: 4px solid transparent;
        }
        .mode-tab:last-child { border-right: none; }
        #mode-selector .mode-tab.active-mode {
            color: var(--accent-color); background-color: var(--accent-bg);
            border-bottom-color: var(--accent-color) !important; box-shadow: 0 0 15px rgba(var(--accent-color-rgb), 0.15) inset;
        }
        @media (min-width: 640px) {
            #mode-selector {
                position: fixed; top: 50%; left: 0; transform: translateY(-50%);
                flex-direction: column; width: auto; max-width: none; margin-bottom: 0;
                box-shadow: 4px 0 12px rgba(0, 0, 0, 0.1); border-radius: 0 12px 12px 0;
            }
            .mode-tab { width: 120px; border-left: 4px solid transparent; border-right: none; border-bottom: 1px solid var(--border-light); }
            .mode-tab:last-child { border-bottom: none; }
            #mode-selector .mode-tab.active-mode { border-left-color: var(--accent-color); border-bottom-color: var(--border-light) !important; }
        }

        .theme-button { width: 24px; height: 24px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s; }
        .theme-button:hover { transform: scale(1.1); }
        .theme-button.active { box-shadow: 0 0 0 2px var(--accent-color); transform: scale(1.1); }

        #toast-notification {
            position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%) translateY(100px);
            background-color: rgba(0, 0, 0, 0.8); color: white; padding: 0.75rem 1.5rem; border-radius: 9999px;
            font-size: 0.9rem; font-weight: 500; z-index: 100; opacity: 0; pointer-events: none;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55); display: flex; align-items: center; gap: 0.5rem;
        }
        #toast-notification.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        
        .copyable-result { cursor: pointer; border-bottom: 2px dashed rgba(var(--accent-color-rgb), 0.3); }
        .page-indicators { display: flex; justify-content: center; gap: 8px; margin-bottom: 1rem; }
        .page-dot { width: 8px; height: 8px; background-color: var(--border-light); border-radius: 50%; transition: all 0.3s; }
        .page-dot.active { width: 24px; background-color: var(--accent-color); border-radius: 4px; }

        #swipe-hint {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.7); padding: 20px; border-radius: 16px; color: white;
            z-index: 200; pointer-events: none; animation: fadeOutHint 0.5s ease-in 2.5s forwards; display: none;
        }
        @keyframes fadeOutHint { to { opacity: 0; visibility: hidden; } }
        @keyframes swipeHand { 0%, 100% { transform: translateX(0); } 50% { transform: translateX(-30px); } }
        .hand-icon { font-size: 3rem; animation: swipeHand 1.5s infinite ease-in-out; }

        /* å†å²è®°å½•è¡¨æ ¼ */
        .history-table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 800px; font-size: 0.85rem; border: 1px solid var(--border-light); border-radius: 8px; overflow: hidden; }
        .history-table th { 
            background-color: var(--accent-bg); 
            color: var(--text-primary);
            font-weight: 700;
            padding: 10px 8px;
            text-align: center;
            border-bottom: 1px solid var(--border-light);
            white-space: nowrap;
        }
        .history-table td {
            padding: 8px;
            border-bottom: 1px solid var(--border-light);
            color: var(--text-secondary);
            text-align: center;
            vertical-align: middle;
        }
        .history-table tr:last-child td { border-bottom: none; }
        .history-table tr:hover { background-color: rgba(var(--accent-color-rgb), 0.03); }
        
        /* æµ‹å®šæ•°æ®å°å­—å— */
        .trial-data-block { font-size: 0.75rem; line-height: 1.3; text-align: left; }
        .trial-data-block .val-m { color: var(--text-secondary); }
        .trial-data-block .val-v-calc { color: var(--text-primary); font-weight: 600; }
        .trial-data-block .val-v-range { font-size: 0.7rem; color: var(--text-secondary); opacity: 0.8; }
        .trial-data-block .val-c { font-weight: 600; color: var(--accent-color); }

        .input-group-label {
            font-size: 0.7rem; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 4px; display: block;
        }
        .input-compact { width: 100%; }
        .input-compact input { text-align: center; padding: 8px 4px; font-size: 0.9rem; }

        /* è´¨é‡è¾“å…¥æ¨¡å¼åˆ‡æ¢ */
        .mass-mode-toggle {
            display: flex; gap: 10px; margin-bottom: 10px; font-size: 0.8rem; color: var(--text-secondary);
        }
        .mass-mode-label { cursor: pointer; display: flex; align-items: center; gap: 4px; }
        .mass-mode-radio { accent-color: var(--accent-color); }
    </style>
</head>
<body data-mode="light">
    
    <div id="floating-container"></div>
    <div id="swipe-hint"><div class="hand-icon">ğŸ‘†</div><div class="mt-2 font-bold">å·¦å³æ»‘åŠ¨åˆ‡æ¢æ¨¡å¼</div></div>
    <div id="toast-notification">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
        <span>ç»“æœå·²å¤åˆ¶</span>
    </div>
    
    <div id="mode-selector">
        <div id="tab-dilution" class="mode-tab active-mode" onclick="setMode('dilution')">
            <div class="text-lg">ğŸ’§</div> ç¨€é‡Šé…åˆ¶
        </div>
        <div id="tab-standardization" class="mode-tab" onclick="setMode('standardization')">
            <div class="text-lg">âš—ï¸</div> æµ“åº¦æ ‡å®š
        </div>
    </div>
    
    <div class="page-indicators sm:hidden">
        <div id="dot-dilution" class="page-dot active"></div>
        <div id="dot-standardization" class="page-dot"></div>
    </div>

    <!-- ä¸»å¡ç‰‡ -->
    <div class="main-calculator-card bg-surface shadow-2xl rounded-2xl border-t-8 border-[var(--accent-color)] transition-colors duration-500">
        
        <!-- é¡¶éƒ¨æ§åˆ¶åŒº -->
        <div class="px-6 py-4 border-b border-[var(--border-light)] transition-colors duration-500 bg-surface z-20 relative">
            <div class="flex flex-col space-y-3">
                <div class="flex flex-wrap items-center justify-between sm:justify-start sm:space-x-4">
                    <div class="flex items-center space-x-2">
                        <button onclick="toggleMode()" class="px-3 py-1 bg-[var(--accent-bg)] rounded-full text-[var(--text-primary)] hover:bg-[var(--border-light)] text-xs font-bold transition-colors active:scale-95 border border-[var(--border-light)]">
                            <span id="mode-text">æµ…è‰²</span>
                        </button>
                        <button onclick="toggleAnimation()" class="px-3 py-1 bg-[var(--accent-bg)] rounded-full text-[var(--text-primary)] hover:bg-[var(--border-light)] text-xs font-bold transition-colors active:scale-95 border border-[var(--border-light)]">
                            <span id="animation-text">åŠ¨æ•ˆ: å¼€</span>
                        </button>
                    </div>
                    
                    <div class="flex items-center space-x-2 sm:ml-auto">
                        <button id="accent-organic" onclick="setAccent('organic')" class="theme-button active" style="background: #8c7851;" title="æœ‰æœºæš–è‰²"></button>
                        <button id="accent-starry-night" onclick="setAccent('starry-night')" class="theme-button" style="background: #27497d;" title="æ˜Ÿæœˆå¤œ"></button>
                        <button id="accent-emerald" onclick="setAccent('emerald')" class="theme-button" style="background: #059669;" title="ç¥–æ¯ç»¿"></button>
                        <button id="accent-violet" onclick="setAccent('violet')" class="theme-button" style="background: #8b5cf6;" title="ç´«ç½—å…°"></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- è§†å›¾è§†å£ Viewport -->
        <div id="views-viewport" class="views-viewport">
            <div id="views-track" class="views-track">
                
                <!-- æ¨¡å¼ä¸€ï¼šç¨€é‡Šé…åˆ¶ -->
                <div id="view-dilution" class="single-view">
                    <div class="space-y-6">
                        <div class="animate-target delay-100 text-center">
                            <h1 class="text-2xl font-black text-primary mb-1">ç¨€ç›é…¸é…ç½®è®¡ç®—å™¨</h1>
                            <p class="text-[var(--text-secondary)] text-sm">C<sub>1</sub>V<sub>1</sub> = C<sub>2</sub>V<sub>2</sub></p>
                        </div>

                        <div class="bg-[var(--accent-bg)] p-4 rounded-xl border border-light transition-colors duration-500 animate-target delay-200 shadow-sm">
                            <h2 class="text-sm font-bold text-primary mb-3 uppercase tracking-wide opacity-80 border-b border-[rgba(0,0,0,0.1)] pb-1">æµ“ç›é…¸ (HCl) åˆå§‹å‚æ•°</h2>
                            <div class="grid grid-cols-1 gap-3">
                                <div>
                                    <label class="block text-xs font-bold text-secondary mb-1">å¯†åº¦ (g/mL) <span class="text-[var(--accent-color)] text-[10px] ml-1">*ä¿®æ”¹è‡ªåŠ¨è®¡ç®—æµ“åº¦</span></label>
                                    <input type="number" id="conc-density-input" placeholder="1.19" value="1.19" step="0.001" min="0"
                                           class="w-full rounded-lg p-2 border input-field text-sm" oninput="preventNegative(this); updateStockMolarityFromDensity()">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-secondary mb-1">æ‘©å°”æµ“åº¦ (M)</label>
                                    <div class="flex space-x-2">
                                        <input type="number" id="conc-molarity-input" placeholder="12.063" step="0.001" min="0"
                                            class="flex-1 rounded-lg p-2 border input-field text-sm" oninput="preventNegative(this); validateDilutionInputs()">
                                        <button onclick="resetConcentration()" class="px-3 py-1 bg-white border border-[var(--border-light)] text-secondary rounded-lg text-xs font-bold hover:bg-gray-50 active:scale-95 transition">é‡ç½®</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-4 animate-target delay-300">
                            <div>
                                <label class="block text-sm font-bold text-primary mb-1">ç›®æ ‡ä½“ç§¯ (V<sub>ç¨€</sub>)</label>
                                <div class="flex rounded-md shadow-sm">
                                    <input type="number" id="target-volume" placeholder="ä¾‹å¦‚: 500" min="0"
                                           class="flex-1 block w-full rounded-l-md p-3 border input-field" oninput="preventNegative(this); hideMessages()">
                                    <div class="flex items-center">
                                         <button id="volume-unit-mL" class="unit-toggle-btn w-12 h-full text-sm active-unit rounded-none" onclick="toggleDilutionUnit('volume', 'mL')">mL</button>
                                         <button id="volume-unit-L" class="unit-toggle-btn w-12 h-full rounded-r-md text-sm" onclick="toggleDilutionUnit('volume', 'L')">L</button>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-bold text-primary mb-1">ç›®æ ‡æµ“åº¦ (C<sub>ç¨€</sub>)</label>
                                <div class="flex rounded-md shadow-sm">
                                    <input type="number" id="target-concentration" placeholder="ä¾‹å¦‚: 0.1" min="0"
                                           class="flex-1 block w-full rounded-l-md p-3 border input-field" oninput="preventNegative(this); validateDilutionInputs()">
                                    <div class="flex items-center">
                                         <button id="conc-unit-M" class="unit-toggle-btn w-12 h-full text-sm active-unit rounded-none" onclick="toggleDilutionUnit('conc', 'M')">M</button>
                                         <button id="conc-unit-W" class="unit-toggle-btn w-12 h-full rounded-r-md text-sm" onclick="toggleDilutionUnit('conc', 'W')">%</button>
                                    </div>
                                </div>
                                <p id="dilution-warning-text" class="text-xs text-[var(--color-error)] mt-1 font-bold hidden">âš ï¸ ç›®æ ‡æµ“åº¦è¿‡é«˜</p>
                                <div id="target-density-group" class="mt-2 hidden">
                                     <label class="block text-xs font-bold text-secondary mb-1">ç›®æ ‡å¯†åº¦ <span id="auto-density-badge" class="text-[var(--accent-color)] hidden">(âš¡ï¸è‡ªåŠ¨)</span></label>
                                    <input type="number" id="target-density" value="1.00" step="0.001" min="0" class="w-full rounded-lg p-2 border input-field text-sm" oninput="preventNegative(this); validateDilutionInputs()">
                                </div>
                            </div>
                            
                            <input type="hidden" id="V_dilute_unit" value="mL">
                            <input type="hidden" id="C_dilute_unit" value="M">

                            <button id="calculate-dilution-btn" onclick="calculateDilution()" class="w-full py-3 rounded-lg shadow-lg text-lg calculate-button mt-4">è®¡ç®—æ‰€éœ€æµ“ç›é…¸ä½“ç§¯</button>
                        </div>

                        <div id="dilution-result-box" class="mt-4 p-5 bg-surface rounded-xl border-2 border-[var(--accent-color)] hidden animate-target shadow-md">
                            <h2 class="text-sm font-bold text-[var(--accent-color)] mb-1 uppercase tracking-wider">è®¡ç®—ç»“æœ (V<sub>æµ“</sub>)</h2>
                            <div class="flex items-baseline space-x-2">
                                <span id="required-volume" class="text-4xl font-extrabold text-[var(--accent-color)] copyable-result" onclick="copyResult(this)">0.00</span> 
                                <span class="text-xl font-bold text-[var(--accent-color)]">mL</span>
                            </div>
                        </div>

                        <div class="pt-6 border-t border-light animate-target delay-400">
                            <div class="flex justify-between items-center mb-3">
                                <h2 class="text-sm font-bold text-secondary">å†å²è®°å½•</h2>
                                <div class="space-x-2">
                                    <button onclick="exportCSV('dilution')" class="action-btn px-3 py-1.5 bg-[#10B981] text-white rounded-lg text-xs font-bold shadow-sm">å¯¼å‡º CSV</button>
                                    <button onclick="clearHistory('dilution')" class="action-btn px-3 py-1.5 bg-[var(--color-error)] text-white rounded-lg text-xs font-bold shadow-sm">æ¸…ç©º</button>
                                </div>
                            </div>
                            <div id="dilution-history-container" class="overflow-x-auto"></div>
                        </div>
                    </div>
                </div>
                
                <!-- æ¨¡å¼äºŒï¼šæµ“åº¦æ ‡å®š -->
                <div id="view-standardization" class="single-view">
                    <div class="space-y-6">
                        <div class="animate-target delay-100 text-center">
                             <h1 class="text-2xl font-black text-primary mb-1">ç¨€ç›é…¸æµ“åº¦æ ‡å®šå™¨</h1>
                             <p class="text-[var(--text-secondary)] text-sm">åŸºå‡†ç‰©è´¨æ ‡å®šæ³•</p>
                        </div>
                         
                        <div class="bg-[var(--accent-bg)] p-4 rounded-xl border border-light transition-colors duration-500 animate-target delay-200 shadow-sm">
                            <h2 class="text-sm font-bold text-primary mb-3 uppercase tracking-wide opacity-80 border-b border-[rgba(0,0,0,0.1)] pb-1">æ ‡å®šå‚æ•°</h2>
                            <div class="mb-3">
                                <label class="input-group-label">åŸºå‡†ç‰©è´¨</label>
                                <select id="standard-substance" onchange="updateStandardSubstance()" class="w-full rounded-lg p-2.5 border input-field text-sm font-bold cursor-pointer">
                                    <option value="Na2CO3">æ— æ°´ç¢³é…¸é’  (Naâ‚‚COâ‚ƒ)</option>
                                    <option value="Borax">ç¡¼ç ‚ (Naâ‚‚Bâ‚„Oâ‚‡Â·10Hâ‚‚O)</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="input-group-label">æ‘©å°”è´¨é‡ (g/mol)</label>
                                    <input type="number" id="molar-mass-standard" min="0" class="w-full rounded-lg p-2 border input-field text-sm" oninput="preventNegative(this)">
                                </div>
                                <div>
                                    <label class="input-group-label">RSD é™åº¦ (%)</label>
                                    <input type="number" id="rsd-limit" value="0.20" step="0.01" min="0" class="w-full rounded-lg p-2 border input-field text-sm" oninput="preventNegative(this); hideMessages()">
                                </div>
                            </div>
                        </div>
                        
                        <div class="animate-target delay-300">
                            <h2 class="text-sm font-bold text-primary mb-2 pl-1">å¹³è¡Œæµ‹å®šæ•°æ® (3ç»„)</h2>
                            
                            <!-- è´¨é‡è¾“å…¥æ¨¡å¼åˆ‡æ¢ -->
                            <div class="mass-mode-toggle px-1">
                                <label class="mass-mode-label">
                                    <input type="radio" name="massMode" value="direct" class="mass-mode-radio" checked onchange="toggleMassMode()"> 
                                    ç›´æ¥è¾“å…¥è´¨é‡ m
                                </label>
                                <label class="mass-mode-label">
                                    <input type="radio" name="massMode" value="diff" class="mass-mode-radio" onchange="toggleMassMode()"> 
                                    å·®å‡æ³• (m = |mâ‚ - mâ‚‚|)
                                </label>
                            </div>

                            <!-- è¡¨å¤´ -->
                            <div class="grid grid-cols-[20px_1fr_1fr_1fr] gap-2 mb-2 px-1">
                                <div></div>
                                <div class="text-xs font-bold text-secondary text-center" id="mass-col-header">è´¨é‡ m (g)</div>
                                <div class="text-xs font-bold text-secondary text-center">åˆè¯»æ•° (mL)</div>
                                <div class="text-xs font-bold text-secondary text-center">ç»ˆè¯»æ•° (mL)</div>
                            </div>

                            <div id="trials-container" class="space-y-3">
                                <!-- Trial 1 -->
                                <div class="grid grid-cols-[20px_1fr_1fr_1fr] gap-2 items-center">
                                    <span class="font-bold text-secondary text-sm text-center">1</span>
                                    <div class="input-compact" id="mass-container-1">
                                        <!-- åŠ¨æ€å†…å®¹ -->
                                    </div>
                                    <div class="input-compact">
                                        <input type="number" id="v-start-1" placeholder="0.00" step="0.01" min="0" class="w-full rounded-lg border input-field font-medium" oninput="preventNegative(this); hideMessages()" onchange="formatDecimal(this, 2)">
                                    </div>
                                    <div class="input-compact">
                                        <input type="number" id="v-end-1" placeholder="0.00" step="0.01" min="0" class="w-full rounded-lg border input-field font-medium" oninput="preventNegative(this); hideMessages(); validateVolume(1)" onchange="formatDecimal(this, 2)">
                                    </div>
                                </div>
                                <!-- Trial 2 -->
                                <div class="grid grid-cols-[20px_1fr_1fr_1fr] gap-2 items-center">
                                    <span class="font-bold text-secondary text-sm text-center">2</span>
                                    <div class="input-compact" id="mass-container-2">
                                        <!-- åŠ¨æ€å†…å®¹ -->
                                    </div>
                                    <div class="input-compact">
                                        <input type="number" id="v-start-2" placeholder="0.00" step="0.01" min="0" class="w-full rounded-lg border input-field font-medium" oninput="preventNegative(this); hideMessages()" onchange="formatDecimal(this, 2)">
                                    </div>
                                    <div class="input-compact">
                                        <input type="number" id="v-end-2" placeholder="0.00" step="0.01" min="0" class="w-full rounded-lg border input-field font-medium" oninput="preventNegative(this); hideMessages(); validateVolume(2)" onchange="formatDecimal(this, 2)">
                                    </div>
                                </div>
                                <!-- Trial 3 -->
                                <div class="grid grid-cols-[20px_1fr_1fr_1fr] gap-2 items-center">
                                    <span class="font-bold text-secondary text-sm text-center">3</span>
                                    <div class="input-compact" id="mass-container-3">
                                        <!-- åŠ¨æ€å†…å®¹ -->
                                    </div>
                                    <div class="input-compact">
                                        <input type="number" id="v-start-3" placeholder="0.00" step="0.01" min="0" class="w-full rounded-lg border input-field font-medium" oninput="preventNegative(this); hideMessages()" onchange="formatDecimal(this, 2)">
                                    </div>
                                    <div class="input-compact">
                                        <input type="number" id="v-end-3" placeholder="0.00" step="0.01" min="0" class="w-full rounded-lg border input-field font-medium" oninput="preventNegative(this); hideMessages(); validateVolume(3)" onchange="formatDecimal(this, 2)">
                                    </div>
                                </div>
                            </div>
                            <div id="volume-warning" class="text-[var(--color-error)] text-xs font-bold text-center mt-2 hidden">âš ï¸ ç»ˆè¯»æ•°å¿…é¡»å¤§äºåˆè¯»æ•°</div>
                            <button id="calculate-standardization-btn" onclick="calculateStandardization()" class="w-full py-3 rounded-lg shadow-lg text-lg calculate-button mt-6">è®¡ç®—æµ“åº¦</button>
                        </div>
                        
                        <div id="standardization-result-box" class="mt-4 p-5 bg-surface rounded-xl border-2 border-[var(--accent-color)] hidden animate-target shadow-md">
                            <div class="flex justify-between items-center mb-3">
                                <span class="text-sm font-bold text-primary">å¹³å‡æµ“åº¦ C<sub>HCl</sub></span>
                                <span id="avg-concentration" class="text-2xl font-black text-[var(--accent-color)] copyable-result" onclick="copyResult(this)">0.0000</span>
                            </div>
                            <div class="flex justify-between items-center text-sm border-t border-light pt-2">
                                <!-- ä¿®å¤æ·±è‰²æ¨¡å¼å¯è§†æ€§ -->
                                <span class="text-primary">RSD: <span id="rsd-value" class="font-bold text-[var(--text-primary)]">0.00%</span></span>
                                <span id="rsd-warning" class="text-[var(--color-error)] font-bold hidden bg-red-50 px-2 py-0.5 rounded">âš ï¸ ç²¾å¯†åº¦ä¸è¶³</span>
                            </div>
                            
                            <!-- è¯¦ç»†ç»“æœåˆ—è¡¨ -->
                            <div class="mt-3 pt-2 border-t border-light">
                                <table class="w-full text-xs text-center">
                                    <thead>
                                        <tr class="text-secondary">
                                            <th class="pb-1">#</th>
                                            <th class="pb-1">m (g)</th>
                                            <th class="pb-1">Î”V (mL)</th>
                                            <th class="pb-1">C (M)</th>
                                        </tr>
                                    </thead>
                                    <!-- ä¿®å¤è¡¨æ ¼å†…å®¹é¢œè‰² -->
                                    <tbody id="standardization-details-body" class="text-primary"></tbody>
                                </table>
                            </div>
                        </div>

                        <div class="pt-6 border-t border-light animate-target delay-400">
                            <div class="flex justify-between items-center mb-3">
                                <h2 class="text-sm font-bold text-secondary">å†å²è®°å½•</h2>
                                <div class="space-x-2">
                                    <!-- ä¿®å¤çš„æŒ‰é’® ID å¼•ç”¨ -->
                                    <button onclick="exportCSV('standardization')" class="action-btn px-3 py-1.5 bg-[#10B981] text-white rounded-lg text-xs font-bold shadow-sm">å¯¼å‡º CSV</button>
                                    <button onclick="clearHistory('standardization')" class="action-btn px-3 py-1.5 bg-[var(--color-error)] text-white rounded-lg text-xs font-bold shadow-sm">æ¸…ç©º</button>
                                </div>
                            </div>
                            <!-- ç¡®ä¿å®¹å™¨ ID å­˜åœ¨ -->
                            <div id="standardization-history-container" class="overflow-x-auto"></div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <div id="error-box" class="mx-6 mb-4 p-3 bg-red-50 border border-red-200 text-red-600 rounded-lg hidden text-sm font-bold text-center">
            <p id="error-message"></p>
        </div>

    </div>

    <script>
        // --- å¸¸é‡ä¸é…ç½® ---
        const STANDARDS = {
            'Na2CO3': { name: 'æ— æ°´ç¢³é…¸é’ ', molarMass: 105.99 },
            'Borax': { name: 'ç¡¼ç ‚', molarMass: 381.37 }
        };
        const HCL_MOLAR_MASS = 36.46;
        
        let dilutionHistory = [], standardizationHistory = [];
        let currentAccent = 'organic', currentMode = 'dilution', isAnimationEnabled = true;
        let massInputMode = 'direct'; // 'direct' or 'diff'
        
        // é…è‰²æ–¹æ¡ˆ
        const colorPalettes = {
            'organic': { light: { '--accent-color': '#8c7851', '--accent-hover': '#7a6845', '--accent-bg': '#eaddcf', '--button-text': '#ffffff' }, dark: { '--accent-color': '#b39f7a', '--accent-hover': '#d4c095', '--accent-bg': '#2b2620', '--button-text': '#141414' } },
            'starry-night': { light: { '--accent-color': '#1f488e', '--accent-hover': '#163a75', '--accent-bg': '#e6f0ff', '--button-text': '#ffffff' }, dark: { '--accent-color': '#ffdf66', '--accent-hover': '#ffea99', '--accent-bg': '#27497d', '--button-text': '#0a0a0a' } },
            'emerald': { light: { '--accent-color': '#059669', '--accent-hover': '#047857', '--accent-bg': '#ecfdf5', '--button-text': '#ffffff' }, dark: { '--accent-color': '#34d399', '--accent-hover': '#6ee7b7', '--accent-bg': '#102d24', '--button-text': '#0a0a0a' } },
            'violet': { light: { '--accent-color': '#8b5cf6', '--accent-hover': '#7c3aed', '--accent-bg': '#f3efff', '--button-text': '#ffffff' }, dark: { '--accent-color': '#d8b4fe', '--accent-hover': '#e9d5ff', '--accent-bg': '#2c1e45', '--button-text': '#0a0a0a' } }
        };

        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : '0,0,0';
        }

        function applyTheme(accentName, modeName) {
            currentAccent = accentName; currentMode = modeName;
            const p = colorPalettes[accentName][modeName];
            document.body.setAttribute('data-mode', modeName);
            for (const [k, v] of Object.entries(p)) document.documentElement.style.setProperty(k, v);
            document.documentElement.style.setProperty('--accent-color-rgb', hexToRgb(p['--accent-color']));
            updateUIState();
        }

        function updateUIState() {
            document.querySelectorAll('.theme-button').forEach(b => b.classList.remove('active'));
            document.getElementById(`accent-${currentAccent}`).classList.add('active');
            document.getElementById('mode-text').textContent = currentMode === 'light' ? 'æµ…è‰²' : 'æ·±è‰²';
            document.getElementById('animation-text').textContent = isAnimationEnabled ? 'åŠ¨æ•ˆ: å¼€' : 'åŠ¨æ•ˆ: å…³';
            localStorage.setItem('hclConfig', JSON.stringify({ accent: currentAccent, mode: currentMode, anim: isAnimationEnabled }));
        }

        window.toggleMode = () => applyTheme(currentAccent, document.body.getAttribute('data-mode') === 'light' ? 'dark' : 'light');
        window.setAccent = (name) => applyTheme(name, document.body.getAttribute('data-mode'));
        window.toggleAnimation = () => {
            isAnimationEnabled = !isAnimationEnabled;
            document.documentElement.style.setProperty('--animation-state', isAnimationEnabled ? 'running' : 'paused');
            updateUIState();
        };

        // --- æ ¸å¿ƒåˆ‡æ¢é€»è¾‘ ---
        window.setMode = function(modeName) {
            document.querySelectorAll('.mode-tab').forEach(el => el.classList.remove('active-mode'));
            document.getElementById(`tab-${modeName}`).classList.add('active-mode');
            document.querySelectorAll('.page-dot').forEach(el => el.classList.remove('active'));
            document.getElementById(`dot-${modeName}`).classList.add('active');

            const track = document.getElementById('views-track');
            track.style.transform = `translateX(${modeName === 'dilution' ? '0%' : '-50%'})`;

            setTimeout(() => adjustHeight(modeName), 50);
            triggerAnimations(modeName);
            hideMessages();
        };

        function adjustHeight(modeName) {
            const activeView = document.getElementById(`view-${modeName}`);
            const viewport = document.getElementById('views-viewport');
            if (activeView && viewport) {
                viewport.style.height = activeView.scrollHeight + 'px';
            }
        }
        
        window.addEventListener('resize', () => {
             const activeMode = document.getElementById('tab-dilution').classList.contains('active-mode') ? 'dilution' : 'standardization';
             adjustHeight(activeMode);
        });

        function triggerAnimations(modeName) {
            document.querySelectorAll('.animate-target').forEach(el => {
                el.classList.remove('animate-stagger-enter');
                el.style.opacity = '0';
            });
            const activeView = document.getElementById(`view-${modeName}`);
            void activeView.offsetWidth; 
            activeView.querySelectorAll('.animate-target').forEach(el => el.classList.add('animate-stagger-enter'));
        }

        // --- è´¨é‡è¾“å…¥æ¨¡å¼é€»è¾‘ ---
        window.toggleMassMode = function() {
            const radios = document.getElementsByName('massMode');
            for (const r of radios) {
                if (r.checked) massInputMode = r.value;
            }
            renderMassInputs();
            hideMessages();
        }

        function renderMassInputs() {
            const header = document.getElementById('mass-col-header');
            header.textContent = massInputMode === 'direct' ? 'è´¨é‡ m (g)' : 'm (g) [å·®å‡æ³•]';
            
            for(let i=1; i<=3; i++) {
                const container = document.getElementById(`mass-container-${i}`);
                container.innerHTML = '';
                
                if(massInputMode === 'direct') {
                    container.innerHTML = `<input type="number" id="mass-${i}" placeholder="0.0000" step="0.0001" min="0" class="w-full rounded-lg border input-field font-medium" oninput="preventNegative(this); hideMessages()" onchange="formatDecimal(this, 4)">`;
                } else {
                    // å·®å‡æ³•æ¨¡å¼ï¼šä¸¤ä¸ªå°è¾“å…¥æ¡† - æ·»åŠ äº† formatDecimal
                    container.innerHTML = `
                        <div class="flex flex-col gap-1">
                            <input type="number" id="mass-start-${i}" placeholder="åˆ" step="0.0001" min="0" class="w-full rounded border input-field font-medium text-[0.8rem] p-1" oninput="preventNegative(this); hideMessages()" onchange="formatDecimal(this, 4)">
                            <input type="number" id="mass-end-${i}" placeholder="ç»ˆ" step="0.0001" min="0" class="w-full rounded border input-field font-medium text-[0.8rem] p-1" oninput="preventNegative(this); hideMessages()" onchange="formatDecimal(this, 4)">
                        </div>
                    `;
                }
            }
            setTimeout(() => adjustHeight('standardization'), 50);
        }

        // --- è®¡ç®—é€»è¾‘ ---
        function hideMessages() {
            document.getElementById('dilution-result-box').classList.add('hidden');
            document.getElementById('standardization-result-box').classList.add('hidden');
            document.getElementById('error-box').classList.add('hidden');
            document.getElementById('volume-warning').classList.add('hidden');
            const activeMode = document.getElementById('tab-dilution').classList.contains('active-mode') ? 'dilution' : 'standardization';
            setTimeout(() => adjustHeight(activeMode), 100);
        }

        function showError(msg) {
            const box = document.getElementById('error-box');
            document.getElementById('error-message').textContent = msg;
            box.classList.remove('hidden');
            const activeMode = document.getElementById('tab-dilution').classList.contains('active-mode') ? 'dilution' : 'standardization';
            setTimeout(() => adjustHeight(activeMode), 100);
        }

        // è¾…åŠ©åŠŸèƒ½
        window.preventNegative = function(el) {
            if (el.value < 0) el.value = Math.abs(el.value);
        }
        
        window.formatDecimal = function(el, precision) {
            if (el.value === '') return;
            const val = parseFloat(el.value);
            if (!isNaN(val)) {
                el.value = val.toFixed(precision);
            }
        }

        window.validateVolume = function(id) {
            const start = parseFloat(document.getElementById(`v-start-${id}`).value);
            const end = parseFloat(document.getElementById(`v-end-${id}`).value);
            const endInput = document.getElementById(`v-end-${id}`);
            const warning = document.getElementById('volume-warning');
            
            if (!isNaN(start) && !isNaN(end)) {
                if (end <= start) {
                    endInput.classList.add('error-border');
                    warning.classList.remove('hidden');
                } else {
                    endInput.classList.remove('error-border');
                    warning.classList.add('hidden');
                }
            }
        }

        // --- æœ‰æ•ˆæ•°å­—ä¿®çº¦ç®—æ³• (å››èˆå…­å…¥äº”æˆåŒ) ---
        function roundToSigFigs(num, n) {
            if (num === 0) return 0;
            
            // 1. è®¡ç®—æ•°é‡çº§ï¼Œç¡®å®šä¿ç•™çš„å°æ•°ä½æ•°
            const d = Math.ceil(Math.log10(num < 0 ? -num : num));
            const power = n - d;
            const magnitude = Math.pow(10, power);
            const shifted = num * magnitude;
            
            // 2. æ ¸å¿ƒä¿®çº¦é€»è¾‘
            const roundedShifted = bankRound(shifted);
            
            // 3. è¿˜åŸå¹¶æ ¼å¼åŒ–å­—ç¬¦ä¸²ä»¥ä¿ç•™å°¾æ•°0
            const result = roundedShifted / magnitude;
            
            // è‡ªåŠ¨è¡¥å…¨æ˜¾ç¤ºä½æ•°ï¼ˆä¾‹å¦‚ 0.1 -> 0.1000ï¼‰
            // è®¡ç®—éœ€è¦çš„å°æ•°ä½æ•°ï¼šå¦‚æœ power > 0ï¼Œè¯´æ˜éœ€è¦ä¿ç•™ power ä½å°æ•°
            // æ³¨æ„ï¼šå¦‚æœ num å¾ˆåœ¨ï¼Œpower å¯èƒ½ä¸ºè´Ÿï¼Œè¿™æ—¶ä¸éœ€è¦å°æ•°ä½
            const decimalPlaces = Math.max(0, power);
            return result.toFixed(decimalPlaces);
        }

        function bankRound(num) {
            const i = Math.floor(num);
            const f = num - i;
            const e = 1e-8; // æµ®ç‚¹è¯¯å·®å®¹é™
            
            if (f > 0.5 + e) return i + 1; // > 0.5 è¿›
            if (f < 0.5 - e) return i;     // < 0.5 èˆ
            
            // f çº¦ä¸º 0.5 (è€ƒè™‘è¯¯å·®)
            if (i % 2 === 0) return i;     // å¶æ•°èˆ
            return i + 1;                  // å¥‡æ•°è¿›
        }

        // --- ç¨€é‡Šè®¡ç®—é€»è¾‘ (ä¿æŒä¸å˜) ---
        window.updateStockMolarityFromDensity = function() {
            const density = parseFloat(document.getElementById('conc-density-input').value);
            if (!isNaN(density) && density > 1.0) {
                const w_percent = (density - 1.0) * 200;
                const molarity = (density * w_percent * 10) / HCL_MOLAR_MASS;
                document.getElementById('conc-molarity-input').value = molarity.toFixed(3);
                validateDilutionInputs();
            }
        }

        window.validateDilutionInputs = function() {
            hideMessages();
            const unitW = document.getElementById('conc-unit-W').classList.contains('active-unit');
            document.getElementById('target-density-group').style.display = unitW ? 'block' : 'none';
            if(unitW) document.getElementById('auto-density-badge').style.display = 'inline';
            
            const cVal = parseFloat(document.getElementById('target-concentration').value);
            if(unitW && cVal) {
                const rho = 1 + cVal * 0.005;
                if(document.activeElement.id !== 'target-density') document.getElementById('target-density').value = rho.toFixed(3);
            }
        };

        window.toggleDilutionUnit = function(type, unit) {
            if(type==='volume') {
                document.getElementById('volume-unit-mL').classList.toggle('active-unit', unit==='mL');
                document.getElementById('volume-unit-L').classList.toggle('active-unit', unit==='L');
                document.getElementById('V_dilute_unit').value = unit;
            } else {
                document.getElementById('conc-unit-M').classList.toggle('active-unit', unit==='M');
                document.getElementById('conc-unit-W').classList.toggle('active-unit', unit==='W');
                document.getElementById('C_dilute_unit').value = unit;
                validateDilutionInputs();
            }
            setTimeout(() => adjustHeight('dilution'), 50);
        };

        window.calculateDilution = function() {
            const C_conc = parseFloat(document.getElementById('conc-molarity-input').value);
            const V_tgt = parseFloat(document.getElementById('target-volume').value);
            const C_tgt = parseFloat(document.getElementById('target-concentration').value);
            const V_unit = document.getElementById('V_dilute_unit').value;
            const C_unit = document.getElementById('C_dilute_unit').value;
            const D_tgt = parseFloat(document.getElementById('target-density').value);

            if(isNaN(C_conc) || C_conc <= 0) return showError("æµ“ç›é…¸æµ“åº¦æ— æ•ˆ");
            if(isNaN(V_tgt) || V_tgt <= 0) return showError("ç›®æ ‡ä½“ç§¯å¿…é¡»å¤§äº0");
            if(isNaN(C_tgt) || C_tgt <= 0) return showError("ç›®æ ‡æµ“åº¦å¿…é¡»å¤§äº0");

            let C_tgt_M = C_tgt;
            if(C_unit === 'W') {
                if(isNaN(D_tgt) || D_tgt <= 0) return showError("å¯†åº¦æ— æ•ˆ");
                C_tgt_M = (C_tgt * D_tgt * 10) / HCL_MOLAR_MASS; 
            }

            if(C_tgt_M >= C_conc) return showError("ç›®æ ‡æµ“åº¦ä¸èƒ½é«˜äºåŸæ¶²æµ“åº¦");

            const V_tgt_mL = V_unit === 'L' ? V_tgt * 1000 : V_tgt;
            const V_req = (C_tgt_M * V_tgt_mL) / C_conc;

            if(V_req < 0) return showError("è®¡ç®—é”™è¯¯ï¼šä½“ç§¯ä¸ºè´Ÿ");

            document.getElementById('required-volume').textContent = V_req.toFixed(2);
            document.getElementById('dilution-result-box').classList.remove('hidden');
            
            dilutionHistory.unshift({ 
                t: new Date(), 
                C_conc: C_conc,
                V_dilute: V_tgt, 
                V_unit: V_unit,
                C_dilute: C_tgt, 
                C_unit: C_unit,
                V_conc: V_req 
            });
            saveHistory('dilution');
            setTimeout(() => adjustHeight('dilution'), 100);
        };
        
        window.resetConcentration = () => {
            document.getElementById('conc-molarity-input').value = '12.063';
            document.getElementById('conc-density-input').value = '1.190';
            hideMessages();
        };

        // --- æ ‡å®šè®¡ç®—é€»è¾‘ (æ›´æ–°) ---
        window.updateStandardSubstance = () => {
            const key = document.getElementById('standard-substance').value;
            document.getElementById('molar-mass-standard').value = STANDARDS[key].molarMass;
        };

        window.calculateStandardization = function() {
            const M = parseFloat(document.getElementById('molar-mass-standard').value);
            const limit = parseFloat(document.getElementById('rsd-limit').value);
            let trials = [];
            
            if(isNaN(M) || M <= 0) return showError("æ‘©å°”è´¨é‡æ— æ•ˆ");

            for(let i=1; i<=3; i++) {
                let m = 0;
                // è´¨é‡è·å–é€»è¾‘
                if(massInputMode === 'direct') {
                    m = parseFloat(document.getElementById(`mass-${i}`).value);
                } else {
                    const m1 = parseFloat(document.getElementById(`mass-start-${i}`).value);
                    const m2 = parseFloat(document.getElementById(`mass-end-${i}`).value);
                    if(!isNaN(m1) && !isNaN(m2)) m = Math.abs(m1 - m2);
                    else m = NaN; // æ ‡è®°æ— æ•ˆ
                }

                const v_start = parseFloat(document.getElementById(`v-start-${i}`).value);
                const v_end = parseFloat(document.getElementById(`v-end-${i}`).value);
                
                // æ£€æŸ¥è¾“å…¥å®Œæ•´æ€§
                if (!isNaN(m) && m > 0 && !isNaN(v_start) && !isNaN(v_end)) {
                    if (v_end <= v_start) {
                        return showError(`ç¬¬ ${i} ç»„: ç»ˆè¯»æ•°å¿…é¡»å¤§äºåˆè¯»æ•°`);
                    }
                    const v_consumed = v_end - v_start;
                    const c = (2 * m) / (M * v_consumed * 0.001);
                    
                    // è®°å½•å•æ¬¡æµ“åº¦ä¹Ÿåº”ç”¨ä¿®çº¦è§„åˆ™ï¼ˆå¯é€‰ï¼Œæ­¤å¤„ä»…ç”¨äºæ˜¾ç¤ºï¼‰
                    const c_rounded_str = roundToSigFigs(c, 4); 
                    
                    trials.push({ id: i, m, vStart: v_start, vEnd: v_end, v: v_consumed, c, c_display: c_rounded_str });
                }
            }
            
            if(trials.length < 2) return showError("è‡³å°‘è¾“å…¥2ç»„å®Œæ•´æœ‰æ•ˆæ•°æ®");
            
            // ä½¿ç”¨åŸå§‹æ•°æ®è®¡ç®—å¹³å‡å€¼å’ŒRSDï¼Œä¿è¯ç²¾åº¦
            const avg = trials.reduce((a,b)=>a+b.c,0)/trials.length;
            const dev = trials.reduce((a,b)=>a+Math.abs(b.c-avg),0)/trials.length;
            const rsd = (dev/avg)*100;

            // æœ€ç»ˆç»“æœä½¿ç”¨ä¿®çº¦è§„åˆ™
            const avg_display = roundToSigFigs(avg, 4);

            document.getElementById('avg-concentration').textContent = avg_display;
            document.getElementById('rsd-value').textContent = rsd.toFixed(2) + '%';
            document.getElementById('rsd-warning').classList.toggle('hidden', rsd <= limit);
            
            // ç”Ÿæˆè¯¦ç»†ç»“æœåˆ—è¡¨
            let detailsHtml = '';
            trials.forEach(t => {
                detailsHtml += `
                    <tr class="border-t border-light/50">
                        <td class="py-1 text-secondary">${t.id}</td>
                        <td class="py-1">${t.m.toFixed(4)}</td>
                        <td class="py-1">${t.v.toFixed(2)}</td>
                        <td class="py-1 font-bold text-[var(--accent-color)]">${t.c_display}</td>
                    </tr>
                `;
            });
            document.getElementById('standardization-details-body').innerHTML = detailsHtml;
            
            document.getElementById('standardization-result-box').classList.remove('hidden');

            standardizationHistory.unshift({ 
                t: new Date(), 
                standard: document.getElementById('standard-substance').options[document.getElementById('standard-substance').selectedIndex].text, 
                res: avg, 
                res_display: avg_display, // å­˜å‚¨ä¿®çº¦åçš„ç»“æœç”¨äºæ˜¾ç¤º
                rsd, 
                trials 
            });
            saveHistory('standardization');
            setTimeout(() => adjustHeight('standardization'), 100);
        };

        // å†å²è®°å½•æ¸²æŸ“é€»è¾‘ (æ›´æ–°)
        function renderHistory(key) {
            const data = key === 'dilution' ? dilutionHistory : standardizationHistory;
            const el = document.getElementById(`${key}-history-container`);
            
            // å®‰å…¨æ£€æŸ¥ï¼šå¦‚æœæ‰¾ä¸åˆ°å…ƒç´ åˆ™ä¸æ‰§è¡Œ
            if (!el) {
                console.error('Cannot find history container for:', key);
                return;
            }
            
            if(!data.length) { 
                el.innerHTML = '<p class="text-xs text-center p-4 text-gray-400">æš‚æ— å†å²è®°å½•</p>'; 
                return; 
            }

            let h = '<table class="history-table"><thead><tr>';
            if (key === 'dilution') {
                h += '<th>æ—¶é—´</th><th>C<sub>æµ“</sub>(M)</th><th>V<sub>ç¨€</sub></th><th>C<sub>ç¨€</sub></th><th>V<sub>æµ“</sub>(mL)</th><th>æ“ä½œ</th>';
            } else {
                // æ‹†åˆ†æ ‡å®šå†å²åˆ—
                h += '<th>æ—¶é—´</th><th>åŸºå‡†ç‰©</th><th>å¹³å‡æµ“åº¦(M)</th><th>RSD(%)</th><th>æµ‹å®š1 (m/Î”V/C)</th><th>æµ‹å®š2 (m/Î”V/C)</th><th>æµ‹å®š3 (m/Î”V/C)</th><th>æ“ä½œ</th>';
            }
            h += '</tr></thead><tbody>';

            data.forEach((d, i) => {
                const time = new Date(d.t).toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'});
                h += `<tr>`;
                
                if (key === 'dilution') {
                    h += `<td>${time}</td>`;
                    h += `<td>${d.C_conc.toFixed(3)}</td>`;
                    h += `<td>${d.V_dilute} ${d.V_unit}</td>`;
                    h += `<td>${d.C_dilute} ${d.C_unit === 'M' ? 'M' : '%'}</td>`;
                    h += `<td class="font-bold text-[var(--accent-color)]">${d.V_conc.toFixed(3)}</td>`;
                } else {
                    h += `<td>${time}</td>`;
                    h += `<td>${d.standard || 'æœªçŸ¥'}</td>`;
                    // ä¼˜å…ˆä½¿ç”¨å­˜å‚¨çš„ä¿®çº¦ç»“æœï¼Œå…¼å®¹æ—§æ•°æ®
                    const displayRes = d.res_display ? d.res_display : (d.res ? d.res.toFixed(4) : '0.0000');
                    h += `<td class="font-bold text-[var(--accent-color)]">${displayRes}</td>`;
                    h += `<td class="${d.rsd > (d.rsdLimit||0.2) ? 'text-red-500 font-bold' : ''}">${d.rsd.toFixed(2)}</td>`;
                    
                    // æ¸²æŸ“æ¯åˆ—çš„æµ‹å®šè¯¦æƒ…
                    for(let j=1; j<=3; j++) {
                        const t = d.trials.find(tr => tr.id === j);
                        if(t) {
                            const vDisplay = t.vStart !== undefined ? `${t.vStart.toFixed(2)}â†’${t.vEnd.toFixed(2)}` : `Î”${t.v.toFixed(2)}`;
                            // å…¼å®¹æ—§æ•°æ®
                            const cDisplay = t.c_display ? t.c_display : (t.c ? t.c.toFixed(4) : '-');
                            h += `<td>
                                    <div class="trial-data-block">
                                        <div class="val-m">m:${t.m.toFixed(4)}g</div>
                                        <div class="val-v-calc">V:${t.v.toFixed(2)}mL</div>
                                        <div class="val-c font-bold text-[var(--accent-color)]">C:${cDisplay}M</div> 
                                        <div class="val-v-range text-[9px] opacity-60">(${vDisplay})</div>
                                    </div>
                                  </td>`;
                        } else {
                            h += `<td><span class="text-gray-300">-</span></td>`;
                        }
                    }
                }
                
                h += `<td><button onclick="delHistory('${key}',${i})" class="text-[var(--color-error)] text-xs font-bold hover:underline">åˆ é™¤</button></td></tr>`;
            });
            el.innerHTML = h + '</tbody></table>';
        }
        
        window.saveHistory = (key) => {
            localStorage.setItem(key+'_hist', JSON.stringify(key==='dilution'?dilutionHistory:standardizationHistory));
            renderHistory(key);
        };
        window.delHistory = (key, idx) => {
            if(key==='dilution') dilutionHistory.splice(idx,1); else standardizationHistory.splice(idx,1);
            saveHistory(key);
            setTimeout(() => adjustHeight(key === 'dilution' ? 'dilution' : 'standardization'), 50);
        };
        window.clearHistory = (key) => {
            if(key==='dilution') dilutionHistory = []; else standardizationHistory = [];
            saveHistory(key);
            setTimeout(() => adjustHeight(key === 'dilution' ? 'dilution' : 'standardization'), 50);
        };
        
        window.exportCSV = function(mode) {
             const data = mode === 'dilution' ? dilutionHistory : standardizationHistory;
             if (!data.length) return showError("æ— æ•°æ®å¯å¯¼å‡º");
             
             let csv = "";
             if (mode === 'dilution') {
                 csv += "æ—¶é—´,Cæµ“(M),Vç¨€,å•ä½,Cç¨€,å•ä½,Væµ“(mL)\n";
                 data.forEach(d => {
                     csv += `${new Date(d.t).toLocaleString()},${d.C_conc},${d.V_dilute},${d.V_unit},${d.C_dilute},${d.C_unit},${d.V_conc}\n`;
                 });
             } else {
                 csv += "æ—¶é—´,åŸºå‡†ç‰©,å¹³å‡æµ“åº¦(M),RSD(%),Trial1_m,Trial1_V_start,Trial1_V_end,Trial1_V_used,Trial2_m,Trial2_V_start,Trial2_V_end,Trial2_V_used,Trial3_m,Trial3_V_start,Trial3_V_end,Trial3_V_used\n";
                 data.forEach(d => {
                     let row = `${new Date(d.t).toLocaleString()},${d.standard},${d.res},${d.rsd}`;
                     for(let i=0; i<3; i++) {
                        const t = d.trials.find(x => x.id === i+1) || {m:0, vStart:0, vEnd:0, v:0};
                        // å…¼å®¹å¤„ç†
                        const vS = t.vStart || 0;
                        const vE = t.vEnd || 0;
                        row += `,${t.m},${vS},${vE},${t.v.toFixed(2)}`;
                     }
                     csv += row + "\n";
                 });
             }
             
             const blob = new Blob(["\ufeff"+csv], {type: 'text/csv;charset=utf-8'});
             const url = URL.createObjectURL(blob);
             const a = document.createElement('a');
             a.href = url;
             a.download = `${mode}_history.csv`;
             a.click();
        }

        window.copyResult = (el) => {
            navigator.clipboard.writeText(el.textContent);
            const t = document.getElementById('toast-notification');
            t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2000);
        };

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            try {
                const cfg = JSON.parse(localStorage.getItem('hclConfig'));
                if(cfg) { applyTheme(cfg.accent, cfg.mode); isAnimationEnabled = cfg.anim; }
                else applyTheme('organic', 'light');
                
                dilutionHistory = JSON.parse(localStorage.getItem('dilution_hist')||'[]');
                standardizationHistory = JSON.parse(localStorage.getItem('standardization_hist')||'[]');
                
                updateStandardSubstance();
                renderMassInputs();
                
                // æ¸²æŸ“å†å²è®°å½•ï¼ˆæ­¤æ—¶DOMåº”å·²å°±ç»ªï¼‰
                renderHistory('dilution'); 
                renderHistory('standardization');
                
                setTimeout(() => setMode('dilution'), 100);
                
                const fc = document.getElementById('floating-container');
                const symbols = ['Hâº', 'Clâ»', 'Hâ‚ƒOâº', 'OHâ»', 'Naâº', 'COâ‚ƒÂ²â»', 'COOH', 'NHâ‚„âº', 'âˆ«', 'âˆ‘', 'âˆ‚', 'Î”', 'pH', 'pKa', 'mol', 'M', 'eq', 'â£', 'â‡Œ'];
                
                for(let i=0;i<55;i++) { 
                    const d = document.createElement('div'); 
                    d.className='floating-element';
                    d.textContent = symbols[Math.floor(Math.random()*symbols.length)];
                    d.style.setProperty('--initial-x-offset', Math.random()*100+'vw');
                    const scale = 0.8 + Math.random() * 1.5;
                    d.style.fontSize = scale + 'rem';
                    d.style.opacity = (0.05 + Math.random() * 0.15).toFixed(2);
                    const duration = 15 + Math.random() * 25;
                    d.style.animationDuration = duration + 's';
                    d.style.animationDelay = -Math.random()*30+'s';
                    fc.appendChild(d);
                }
                
                if(window.innerWidth < 640 && !localStorage.getItem('seenSwipe')) {
                    document.getElementById('swipe-hint').style.display = 'flex';
                    localStorage.setItem('seenSwipe','1');
                }
            } catch(e) { console.error(e); }
        });

        // è§¦æ‘¸æ»‘åŠ¨é€»è¾‘ - ä¿®å¤å†²çª
        let tx = 0, ty = 0;
        let isSwipeIgnored = false;

        document.addEventListener('touchstart', e => { 
            tx = e.touches[0].clientX; 
            ty = e.touches[0].clientY;
            
            // æ£€æŸ¥æ˜¯å¦åœ¨å†å²è®°å½•æ»šåŠ¨åŒºåŸŸå†…
            const scrollContainer = e.target.closest('.overflow-x-auto');
            if (scrollContainer) {
                // å¦‚æœå†…å®¹ç¡®å®æº¢å‡ºéœ€è¦æ»šåŠ¨ï¼Œåˆ™å¿½ç•¥å…¨å±€æ»‘åŠ¨åˆ‡æ¢
                if (scrollContainer.scrollWidth > scrollContainer.clientWidth) {
                    isSwipeIgnored = true;
                } else {
                    isSwipeIgnored = false;
                }
            } else {
                isSwipeIgnored = false;
            }
        }, {passive:true});

        document.addEventListener('touchend', e => {
            if (isSwipeIgnored) return;

            const dx = e.changedTouches[0].clientX - tx;
            const dy = e.changedTouches[0].clientY - ty;
            
            if(Math.abs(dx) > 60 && Math.abs(dx) > Math.abs(dy)*2) {
                const active = document.getElementById('tab-dilution').classList.contains('active-mode');
                // å‘å·¦æ»‘ -> å»å³è¾¹ (standardization)
                if(dx < 0 && active) setMode('standardization');
                // å‘å³æ»‘ -> å»å·¦è¾¹ (dilution)
                if(dx > 0 && !active) setMode('dilution');
            }
        }, {passive:true});

    </script>
</body>
</html>